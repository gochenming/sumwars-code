<Quest name="Ein Freund in Not" table_name="rescue_willard">
	
	<Init>
		rescue_willard.freed = false;
	</Init>
	
	<Description>
		if (rescue_willard.finished) then
			return _("Quest finished");
		end
	</Description>
	
	<NPC refname="Fenor Marken">
		<Topic name="rescue_willard" start_option="Willard">
			<Condition>
				if (rescue_willard.finished == true) then
					return false
				else
					return true
				end
			</Condition>
			<Effect>
				if (rescue_willard.started == true) then
					speak('Fenor Marken',_("Ihr habt Willard noch nicht befreit."),1000)
				else
					speak('Fenor Marken',_("Ein ..."),1000)
					speak('player',_("... Gespraech"),1000)
					speak('Fenor Marken',_("Werdet ihr ihn befreien?"),1000)
					addQuestion(_("Quest annehmen?"))
					addAnswer(_("Ja"),'start_rescue_willard_quest')
					addAnswer(_("Nein"),'end')
				end
			</Effect>
		</Topic>
		
		<Topic name="start_rescue_willard_quest" >
			<Effect>
				speak('player', _("Wir machen uns auf den Weg."),1500)
				speak('Fenor Marken',_("Viel Glueck!"),1000);
				rescue_willard.started = true;
			</Effect>	
		</Topic>
	</NPC>
	
	
<NPC refname="Willard">
	<Topic name="rescue_willard_reward" start_option="Willard (Belohnung)">
		<Condition>
			if (rescue_willard.finished == true) then
				return false
			else
				return true
			end
		</Condition>
		<Effect>
			rescue_willard.finished = true
			speak('Willard','Ich bin euch zu grossem Dank verpflichtet.',1000)
			speak('Willard',_("Dafuer bekommt ihr von mir jetzt eine Belohnung."),1000)
			speak('player', _("Yeah"),1000)
			local players = getPlayers()
			local i,player
			for i,player in ipairs(players) do
				if (getPlayerPrivateVar(player,"rescue_willard.reward") ~= true) then
					setPlayerPrivateVar(player,"rescue_willard.reward",true)
					setObjectValue(player,"gold", getObjectValue(player,"gold") + 50)
				end
			end
		</Effect>
	</Topic>
</NPC>
	<Region name="medMercCamp" >
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.asked ~= true) then
					return (unitIsInArea(trigger.player,"FenorArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				rescue_willard.asked = true
				local pos = getPosition(trigger.player)
				addUnitCommand(fenor,'walk',1000,pos);
				startTimer("askRescueWillard",1000);
				addTriggerVariable("player",trigger.player);
			</Effect>
		</Event>
		
		<Event trigger ="askRescueWillard" once = "true">
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'player')
				addSpeaker(fenor,'Fenor Marken')
				setTopicBase('Fenor Marken')
				changeTopic('rescue_willard')
			</Effect>
		</Event>
		
	</Region>
	
	<Region name="aisMeadow">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea('WillardArea','circle','locWillard',20);
				addArea('WillardEnemiesArea','circle','locWillard',15);
				if (rescue_willard.freed ~= true) then
					rescue_willard_tmp.monsters = createMonsterGroup("goblins","locWillard")
				end
				if (rescue_willard.freed == true and rescue_willard.finished ~= true) then
					rescue_willard_tmp.willard = createObject('peasant', 'locWillard')
					setRefName(rescue_willard_tmp.willard, 'Willard')
				end
			</Effect>
		</Event>
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'finder')
				speak('finder','Hier steckt also dieser Willard.',1000)
			</Effect>
		</Event>
		
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		<Event trigger ="unit_die">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		
		<Event trigger ="checkWillardSafety">
			<Condition>
				local list = getMonstersInArea('WillardEnemiesArea')
				if (list[1] == nil and rescue_willard.started == true and rescue_willard.finished == false and rescue_willard.freed == false) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				rescue_willard_tmp.willard = createObject('peasant', 'locWillard')
				setRefName(rescue_willard_tmp.willard, 'Willard')
				rescue_willard.freed = true
			</Effect>
		</Event>
	</Region>
	
</Quest>

