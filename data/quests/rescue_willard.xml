<Quest name="Ein Freund in Not" table_name="rescue_willard">
	
	<Init>
		local a = 2
	</Init>
	
	<Description>
		if (rescue_willard.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	
	<NPC refname="Fenor Marken">
		<Topic name="rescue_willard" start_option="Willard">
			<Condition>
				if (rescue_willard.finished == true) then
					return false
				else
					return true
				end
			</Condition>
			<Effect>
				if (rescue_willard.started == true) then
					speak('Fenor Marken',_("You have yet to give the stone to Willard."))
				else
					addStandardSpeakers();
					speak('Fenor Marken',_("Hey there!"));
					speak('Fenor Marken',_("Are you the councils backing?"));
					speak('player',_("And if it was like that?"));
					speak('Fenor Marken',_("I heard you were Branded Ones."));
					speak('Fenor Marken',_("There is something, only someone like you can do."));
					speak('Fenor Marken',_("With sure success that is."));
					speak("ANY",_("Who would have thougt of that?"));
					speak("ANY",_("Does a respectable member of the guard want someones thoat cut?"));
					speak('Fenor Marken',_("Eh? I could've hired a professional assassin for that."));
					speak('Fenor Marken',_("I thought you were not the kind of Branded Ones"));
					speak('Fenor Marken',_("that kill everyone crossing their pass."));
					speak("ANY",_("My apologies. Maybe my mouth slipped."));
					speak('player',_("Whatever. What do you really want?"));
					speak('Fenor Marken',_("Thanks. My name is Fenor Marken."));
					speak('Fenor Marken',_("It is like that: I have a friend with the gamekeepers."));
					speak('Fenor Marken',_("He was in the woods with two others when they were attacked by goblins."));
					speak('Fenor Marken',_("And those cowards left him behind wounded."));
					speak('player',_("Surely you don't want me to bring back his corpse, do you?"));
					speak('Fenor Marken',_("No. Willard isn't someone who is killed by some measly goblins."));
					speak('Fenor Marken',_("I'm sure he's waiting somewhere for help."));
					speak('Fenor Marken',_("You must be very busy."));
					speak('Fenor Marken',_("That's why all I ask you is bringing him this phasestone."));
					speak('Fenor Marken',_("Normally I wouldn't entrust anyone with this"));
					speak('Fenor Marken',_("out of fear they'd elope with it."));
					speak('Fenor Marken',_("But you Branded Ones have other means of transportation, havn't you."));
					speak('Fenor Marken',_("That's why I came to you."));
					speak('player',_("I understand."));
					addQuestion(_("Quest annehmen?"));
					addAnswer(_("Ja"),'start_rescue_willard_quest');
					addAnswer(_("Nein"),'refuse_rescue_willard_quest');
				end
			</Effect>
		</Topic>
		
		<Topic name="start_rescue_willard_quest" >
			<Effect>
				speak("WAR",_("Your friend is as good as saved."),1000);
				speak("ANY",_("And not even asking what the rest is thinking."),2500);
				speak('Fenor Marken',_("Thank you very much."),1000);
				rescue_willard.started = true;
			</Effect>	
		</Topic>
		
		<Topic name="refuse_rescue_willard_quest" >
			<Effect>
				speak("player",_("Sorry, but we can't waste time searching for some gamekeeper."),3000);
				speak('Fenor Marken',_("You're as coldharted as they say."),1800);
				speak('Fenor Marken',_("If only I could leave here."),1800);
				speak('Fenor Marken',_("I would search for him myself"),1800);
			</Effect>	
		</Topic>
	</NPC>
	
	
	<NPC refname="Willard">
		<Topic name="rescue_willard_reward" start_option="Willard (Reward)">
			<Condition>
				if (rescue_willard.finished == true) then
					return false;
				else
					return true;
				end;
			</Condition>
			<Effect>
				rescue_willard.finished = true;
				speak("Willard","Thanks for your help.",1500);
				speak("Willard","Can I ask another favor of you?",1500);
				speak("Willard","My leg's wounded and I won't reach Medair on my own.",2000);
				speak("player", _("You're Willard I suppose."),1500);
				speak("Willard","That's me. Why do you know my name?",1800);
				speak("player", _("Your friend Fenor Marken sends us."),1800);
				speak("player", _("We are to give you a phasestone."),1700);
				speak("Willard","Holy Gods! He still has that thing?",1800);
				speak("Willard","That was one of the sins of our youth.",1800);
				speak("Willard","Mines been used up long ago.",1500);
				speak("Willard","Good old Fenor. Here, let me show you my appretiation.",2200);
				speak("Willard","Surely someone in your line of work allways has use for extra money?",2500);
				speak("player", _("I thank you."),1000);
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"rescue_willard.reward") ~= true) then
						setPlayerPrivateVar(player,"rescue_willard.reward",true);
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 50);
					end;
				end;
				changeTopic("willard_vanishes");
			</Effect>
		</Topic>
		
		<Topic name="willard_vanishes">
			<Effect>
				deleteObject(rescue_willard_tmp.willard);
			</Effect>
		</Topic>
	</NPC>
	
	
	<Region name="medMercCamp" >
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.asked ~= true) then
					return (unitIsInArea(trigger.player,"FenorArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				rescue_willard.asked = true
				addUnitCommand(fenor,'walk',trigger.player);
				startTimer("askRescueWillard",1000);
				addTriggerVariable("player",trigger.player);
			</Effect>
		</Event>
		
		<Event trigger ="askRescueWillard" once = "true">
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'player')
				addSpeaker(fenor,'Fenor Marken')
				setTopicBase('Fenor Marken')
				changeTopic('rescue_willard')
			</Effect>
		</Event>
		
	</Region>
	
	<Region name="aisMeadow">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea('WillardArea','circle','locWillard',20);
				addArea('WillardEnemiesArea','circle','locWillard',15);
				if (rescue_willard.freed ~= true) then
					rescue_willard_tmp.monsters = createMonsterGroup("goblins","locWillard")
				end
				if (rescue_willard.freed == true and rescue_willard.finished ~= true) then
					rescue_willard_tmp.willard = createObject('peasant', 'locWillard')
					setRefName(rescue_willard_tmp.willard, 'Willard')
				end
			</Effect>
		</Event>
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				-- createDialogue()
				-- addSpeaker(trigger.player,'finder')
				-- speak('finder','Hier steckt also dieser Willard.',1000)
				unitSpeak(trigger.player,_("Hier steckt also dieser Willard."),1000);
			</Effect>
		</Event>
		
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		<Event trigger ="unit_die">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		
		<Event trigger ="checkWillardSafety">
			<Condition>
				local list = getMonstersInArea('WillardEnemiesArea')
				if (list[1] == nil and rescue_willard.started == true and rescue_willard.finished ~= true and rescue_willard.freed ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				rescue_willard_tmp.willard = createObject('peasant', 'locWillard')
				setRefName(rescue_willard_tmp.willard, 'Willard')
				rescue_willard.freed = true
			</Effect>
		</Event>
	</Region>
	
</Quest>

