<Quest name="Ein Freund in Not" table_name="rescue_willard">
	
	<Init>
		local a = 2
	</Init>
	
	<Description>
		if (rescue_willard.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	
	<NPC refname="Fenor Marken">
		<Topic name="rescue_willard" start_option="Willard">
			<Condition>
				if (rescue_willard.finished == true) then
					return false
				else
					return true
				end
			</Condition>
			<Effect>
				if (rescue_willard.started == true) then
					speak('Fenor Marken',_("Ihr habt Willard noch nicht befreit."),1000)
				else
					speak('Fenor Marken',_("Heda! ..."),1000)
					speak('player',_("Und wenn es ..."),1000)
					speak('Fenor Marken',_("Ich habe laeuten ..."),1000)
					createDialogue()
					if (getPlayers()[2] ~= nil and getPlayers()[2] ~= getSpeaker("player")) then
						local any = getPlayers()[2]
					else
						local any = getPlayers()[1]
					end
					addSpeaker(any,"any")
					speak("any",_("Wer haette das ..."),1000)
					speak('Fenor Marken',_("Hae! Dafuer haette ..."),1000)
					speak("any",_("Verzeiht. Vielleicht war ..."),1000)
					speak('player',_("Wie auch immer ..."),1000)
					speak('Fenor Marken',_("Danke. Mein Name ..."),1000)
					speak('player',_("Sicher wollt ihr ..."),1000)
					speak('Fenor Marken',_("Nein. Willard ist ..."),1000)
					speak('player',_("Ich verstehe."),1000)
					addQuestion(_("Quest annehmen?"))
					addAnswer(_("Ja"),'start_rescue_willard_quest')
					addAnswer(_("Nein"),'refuse_rescue_willard_quest')
				end
			</Effect>
		</Topic>
		
		<Topic name="start_rescue_willard_quest" >
			<Effect>
				createDialogue()
				local war = getWarriors()[1]
				addSpeaker(war,"war")
				speak("war",_("Euer Freund ist ..."),1000)
				if (getPlayers()[1] ~= getSpeaker("player")) then
					local any = getPlayers()[1]
				else
					local any = getPlayers()[2]
				end
				addSpeaker(any,"any")
				speak("any",_("Und fragt nicht ..."),1000)
				speak('Fenor Marken',_("Ich danke euch ..."),1000);
				rescue_willard.started = true;
			</Effect>	
		</Topic>
		
		<Topic name="refuse_rescue_willard_quest" >
			<Effect>
				speak("player",_("Es tut mir ..."),1000)
				speak('Fenor Marken',_("Ihr seid genauso ..."),1000);
			</Effect>	
		</Topic>
	</NPC>
	
	
<NPC refname="Willard">
	<Topic name="rescue_willard_reward" start_option="Willard (Reward)">
		<Condition>
			if (rescue_willard.finished == true) then
				return false
			else
				return true
			end
		</Condition>
		<Effect>
			rescue_willard.finished = true
			speak("Willard","Danke fuer eure ...",1000)
			speak("player", _("Ich nehme an ..."),1000)
			speak("Willard","Der bin ich ...",1000)
			speak("player", _("Euer Freund Fenor ..."),1000)
			speak("Willard","Bei den Goettern ...",1000)
			speak("player", _("Ich danke euch."),1000)
			local players = getPlayers()
			local i,player
			for i,player in ipairs(players) do
				if (getPlayerPrivateVar(player,"rescue_willard.reward") ~= true) then
					setPlayerPrivateVar(player,"rescue_willard.reward",true)
					setObjectValue(player,"gold", getObjectValue(player,"gold") + 50)
				end
			end
		</Effect>
	</Topic>
</NPC>
	<Region name="medMercCamp" >
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.asked ~= true) then
					return (unitIsInArea(trigger.player,"FenorArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				rescue_willard.asked = true
				local pos = getPosition(trigger.player)
				addUnitCommand(fenor,'walk',1000,pos);
				startTimer("askRescueWillard",1000);
				addTriggerVariable("player",trigger.player);
			</Effect>
		</Event>
		
		<Event trigger ="askRescueWillard" once = "true">
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'player')
				addSpeaker(fenor,'Fenor Marken')
				setTopicBase('Fenor Marken')
				changeTopic('rescue_willard')
			</Effect>
		</Event>
		
	</Region>
	
	<Region name="aisMeadow">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea('WillardArea','circle','locWillard',20);
				addArea('WillardEnemiesArea','circle','locWillard',15);
				if (rescue_willard.freed ~= true) then
					rescue_willard_tmp.monsters = createMonsterGroup("goblins","locWillard")
				end
				if (rescue_willard.freed == true and rescue_willard.finished ~= true) then
					rescue_willard_tmp.willard = createObject('peasant', 'locWillard')
					setRefName(rescue_willard_tmp.willard, 'Willard')
				end
			</Effect>
		</Event>
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'finder')
				speak('finder','Hier steckt also dieser Willard.',1000)
			</Effect>
		</Event>
		
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		<Event trigger ="unit_die">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		
		<Event trigger ="checkWillardSafety">
			<Condition>
				local list = getMonstersInArea('WillardEnemiesArea')
				if (list[1] == nil and rescue_willard.started == true and rescue_willard.finished ~= true and rescue_willard.freed ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				rescue_willard_tmp.willard = createObject('peasant', 'locWillard')
				setRefName(rescue_willard_tmp.willard, 'Willard')
				rescue_willard.freed = true
			</Effect>
		</Event>
	</Region>
	
</Quest>

