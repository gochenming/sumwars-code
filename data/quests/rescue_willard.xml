<Quest name="Ein Freund in Not" table_name="rescue_willard">
	
	<Init>
		local a = 2
	</Init>
	
	<Description>
		if (rescue_willard.finished) then
			return _("Willard ist wieder in Medair und er hat sogar ein bisschen Geld springen lassen. Wer sagt denn, dass es sich nicht auszahlt, die Leute am Leben zu lassen? Zumindest so lange es reichlich Goblins gibt.")
		elseif(rescue_willard.started==true)then
			if(rescue_willard_tmp.freed ~= true)then
				return _("Willard versteckt sich irgendwo in der Aisener Wiese. Er wird sich wegen seiner Verletzung sicher nur zeigen, wenn keine Goblins in der Naehe sind.")
			else
				return _("Langes suchen und etliche tote Goblins spaeter ist Willard endlich aufgetaucht. Ich sollte ihm den Stein geben und es hinter mich bringen.")
			end;
		end
	</Description>
	
	<Region name="medMercCamp" >
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.asked ~= true) then
					return (unitIsInArea(trigger.player,"areaFenor"))
				else
					return false
				end
			</Condition>
			<Effect>
				unitSpeak(fenor,_("Heda!"),"normal");
				addUnitCommand(fenor,'walk',trigger.player,1.5);
				rescue_willard_tmp.proposal = true;
				createDialogue()
				addSpeaker(trigger.player,'player')
				rescue_willard_tmp.player = trigger.player;
				
				setTopicBase('Fenor Marken')
				changeTopic('rescue_willard')
				setDialogueActive(false);
			</Effect>
		</Event>
	
		<Event trigger ="command_complete" once = "true">
			<Condition>
				return ((trigger.unit == fenor)and(rescue_willard_tmp.proposal == true)) 
			</Condition>	
			<Effect>
				rescue_willard_tmp.proposal = false;
				setCurrentDialogue(rescue_willard_tmp.player);
				addSpeaker(fenor,'Fenor Marken')
				lookAtObject(fenor,rescue_willard_tmp.player);
				lookAtObject(rescue_willard_tmp.player,fenor);
				setDialogueActive(true);
			</Effect>
		</Event>
		
	</Region>
	
	
	<NPC refname="Fenor Marken">
		<Topic name="rescue_willard" start_option="Willard">
			<Condition>
				if (rescue_willard.finished == true) then
					return false
				else
					return true
				end
			</Condition>
			<Effect>
				if (rescue_willard.started == true) then
					if(solo())then
						speak('Fenor Marken',_("Ich hoffe, Ihr kommt mit Eurer Suche nach Willard voran. _solo"),"sad");
					else
						speak('Fenor Marken',_("Ich hoffe, Ihr kommt mit Eurer Suche nach Willard voran."),"sad");
					end;
				elseif(rescue_willard.denied == true)then
					speak('Fenor Marken',_("Habt Ihr es euch etwa anders ueberlegt?"),"sad");
					addQuestion(_("Nach Willard suchen?"));
					addAnswer(_("Ja"),'start_rescue_willard_quest');
					addAnswer(_("Nein"),'refuse_rescue_willard_quest_again');
				else
					addStandardRoles();
					if(solo() and maleOnly())then
						speak('Fenor Marken',_("Wenn mich nicht alles taeuscht seid ihr ein Gezeichneter."), "normal");
					elseif(solo() and femaleOnly())then
						speak('Fenor Marken',_("Wenn mich nicht alles taeuscht seid ihr eine Gezeichnete."), "normal");
					else
						speak('Fenor Marken',_("Wenn mich nicht alles taeuscht seid ihr Gezeichnete."), "normal");
					end;
					speak('player',_("Was zum..."),"angry");
					speak('player',_("Habe ich irgendwo ein Schild auf dem steht: Achtung, gefaehrliches Monster??"),"angry");
					speak('player',_("Das ist schon das zweite Mal heute!"),"unhappy");
					speak('Fenor Marken',_("Ich konnte schon immer spueren, wenn jemand ein Gezeichneter war."),"thoughtful");
					speak('Fenor Marken',_("Aber keine Sorge, ich werde niemanden verraten, solange er sich korrekt verhaelt."),"normal");
					if(solo())then
						speak('Fenor Marken',_("Es gibt da etwas, um das ich Euch bitten moechte. _solo"));
						speak('Fenor Marken',_("Nur jemand wie Ihr koennte das zuverlaessig erledigen. _solo"));
					else
						speak('Fenor Marken',_("Es gibt da etwas, um das ich Euch bitten moechte."));
						speak('Fenor Marken',_("Nur jemand wie Ihr koennte das zuverlaessig erledigen."));
					end;
					
					speak("any",_("Wer haette das gedacht?"),"sneer");
					speak("any",_("Will ein ehrbares Mitglied der Stadtwache etwa jemandes Kehle durchgeschnitten sehen?"),"unhappy");
					speak('Fenor Marken',_("Haeh? Dafuer haette ich einen professionellen Attentaeter anheuern koennen."),"aloof");
					speak('Fenor Marken',_("Ich dachte, Ihr waert die Sorte Gezeichnete, die nicht wahllos alle Menschen umbringen, die ihren Weg kreuzen."));
					speak("any",_("Verzeiht. Vielleicht war mein Mund schneller als mein Kopf."),"sad");
					speak('player',_("Wie auch immer. Was wollt Ihr wirklich?"),"normal");
					speak('Fenor Marken',_("Danke. Mein Name ist Fenor Marken."),"normal");
					speak('Fenor Marken',_("Es ist so: Ich habe einen Freund bei den Wildhuetern."));
					speak('Fenor Marken',_("Er war mit zwei Kollegen in den Wiesen, als sie von Goblins ueberfallen wurden."),"sad");
					speak('Fenor Marken',_("Und diese Feiglinge haben ihn verletzt zurueck gelassen!"),"angry");
					if(solo())then
						speak('player',_("Sicher wollt Ihr nicht, dass ich seine Leiche zurueck bringe."));
					else
						speak('player',_("Sicher wollt Ihr nicht, dass wir seine Leiche zurueck bringe."));
					end;
					speak('Fenor Marken',_("Nein. Willard ist niemand, der sich von ein paar lausigen Goblins umbringen laesst."),"aloof");
					speak('Fenor Marken',_("Ich bin sicher, er wartet irgendwo darauf, dass ihm jemand zu Hilfe eilt."),"normal");
					speak('Fenor Marken',_("Nun seid Ihr sicher sehr beschaeftigt."));
					if(solo())then
						speak('Fenor Marken',_("Deswegen bitte ich Euch, ihm diesen Phasenstein zu bringen. _solo"));
					else
						speak('Fenor Marken',_("Deswegen bitte ich Euch, ihm diesen Phasenstein zu bringen."));
					end;
					speak('Fenor Marken',_("Normalerweise wuerde ich das niemandem anvertrauen."),"thoughtful");
					speak('Fenor Marken',_("Schon gar keinen wildfremden Leuten."),"thoughtful");
					speak('Fenor Marken',_("Wer wuerde nicht einfach damit verschwinden."),"grin");
					speak('Fenor Marken',_("Aber ihr Gezeichneten habt andere Mittel und Wege, um zu reisen."),"normal");
					speak('Fenor Marken',_("Und einen Phasenstein koennt ihr nicht benutzen, weil er Avaera geweiht ist, stimmt's?"));
					speak('Fenor Marken',_("Deswegen habe ich mich an Euch gewandt, als Ihr hier vorbei gekommen seid."));
					speak('player',_("Ihr wisst recht viel."),"normal");
					executeInDialog("rescue_willard.asked = true");
					addQuestion(_("Nach Willard suchen?"));
					addAnswer(_("Ja"),'start_rescue_willard_quest');
					addAnswer(_("Nein"),'refuse_rescue_willard_quest');
				end
			</Effect>
		</Topic>
		
		<Topic name="start_rescue_willard_quest" >
			<Effect>
				speak("waropt",_("Euer Freund ist so gut wie gerettet"));
				if(getSpeaker("waropt") ~= getSpeaker("any")) then
					speak("any",_("Und fragt nicht mal, was der Rest von uns denkt."));
				end;
				if(solo())then
					speak('Fenor Marken',_("Ich danke Euch _solo"),"happy");
				else
					speak('Fenor Marken',_("Ich danke Euch"),"happy");
				end;
				rescue_willard.started = true;
				startTimer("talk_done",4000);
			</Effect>	
		</Topic>
		
		<Topic name="refuse_rescue_willard_quest" >
			<Effect>
				rescue_willard.denied = true;
				if(solo())then
					speak("player",_("Es tut mir Leid, aber ich will meine Zeit nicht damit verschwenden, nach irgendwelchen Wildhuetern zu suchen."));
					speak('Fenor Marken',_("Ihr seid genauso kaltherzig, wie man es euch nachsagt. _solo"),"sad");
				else
					speak("player",_("Es tut mir Leid, aber wir koennen unsere Zeit nicht damit verschwenden, nach irgendwelchen Wildhuetern zu suchen."));
					speak('Fenor Marken',_("Ihr seid genauso kaltherzig, wie man es euch nachsagt."),"sad");
				end;
				speak('Fenor Marken',_("Wenn ich doch nur hier weg koennte."),"angry");
				speak('Fenor Marken',_("Dann  wuerde ich ihn selbst suchen gehen."),"threaten");
				startTimer("talk_done",4000);
			</Effect>	
		</Topic>
		<Topic name="refuse_rescue_willard_quest_again" >
			<Effect>
				if(solo())then
					speak('Fenor Marken',_("Was wollt Ihr dann von mir? _solo"),"angry");
					speak('Fenor Marken',_("Verschwindet, bevor ich jemandem von Euch erzaehle! _solo"),"angry");
				else
					speak('Fenor Marken',_("Was wollt Ihr dann von mir?"),"angry");
					speak('Fenor Marken',_("Verschwindet, bevor ich jemandem von Euch erzaehle!"),"angry");
				end;
			</Effect>	
		</Topic>
	</NPC>
	
	<Region name="medMercCamp" >
		<Event trigger ="talk_done" once = "true">
			<Effect>
				addUnitCommand(fenor,'walk','locFenor');
				rescue_willard_tmp.walkBack = true;
			</Effect>
		</Event>
	
		<Event trigger ="command_complete" once = "true">
			<Condition>
				return ((trigger.unit == fenor) and (rescue_willard_tmp.walkBack == true)) 
			</Condition>	
			<Effect>
				set(fenor,"angle",90);
			</Effect>
		</Event>
		
	</Region>
	
	
	<NPC refname="Willard">
		<Topic name="rescue_willard_reward" start_option="Willard (Reward)">
			<Condition>
				if (rescue_willard.finished == true) then
					return false;
				else
					return true;
				end;
			</Condition>
			<Effect>
				rescue_willard.finished = true;
				speak("Willard",_("Danke für eure Hilfe."),"excited");
				speak("Willard",_("Kann ich euch um noch einen Gefallen bitten?"),"normal");
				speak("Willard",_("Ich bin am Bein verwundet und schaffe es allein nicht bis nach Medair."),"sad");
				speak("player", _("Ich nehme an, ihr seid Willard."),"thoughtful");
				setSpeakerEmotion("player","amused");
				speak("Willard",_("Der bin ich. Woher kennt ihr meinen Namen?"),"surprised");
				speak("player", _("Euer Freund Fenor Marken schickt uns, um euch einen Phasenstein zu geben."),"normal");
				speak("Willard",_("Bei den Goettern! Er hat das Ding immer noch?"),"amused");
				speak("Willard",_("Das ist eine unserer Jugendsuenden gewesen."));
				speak("Willard",_("Meiner ist laengst verbraucht."),"thoughtful");
				speak("Willard",_("Der gute Fenor. Hier, lasst mich meine Dankbarkeit zeigen."),"happy");
				speak("Willard",_("Sicher kann jemand mit eurem Handwerk immer Geld gebrauchen?"));
				speak("player", _("Ich danke euch."),"amused");
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"rescue_willard.reward") ~= true) then
						setPlayerPrivateVar(player,"rescue_willard.reward",true);
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 50);
					end;
				end;
				changeTopic("willard_vanishes");
			</Effect>
		</Topic>
		
		<Topic name="willard_vanishes">
			<Effect>
				deleteObject(rescue_willard_tmp.willard);
			</Effect>
		</Topic>
	</NPC>
		
	<Region name="aisMeadow">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea('WillardArea',{'circle','willard:locWillard',20});
				addArea('WillardEnemiesArea',{'circle','willard:locWillard',15});
				local list = getMonstersInArea('WillardEnemiesArea')
				if (rescue_willard_tmp.freed ~= true) then
					rescue_willard_tmp.monsters = createMonsterGroup("willard_goblins","willard:locWillard")
				elseif (rescue_willard_tmp.freed == true and rescue_willard.finished ~= true and list[1] == nil) then
					rescue_willard_tmp.willard = createObject('peasant', 'willard:locWillard')
					setRefName(rescue_willard_tmp.willard, 'Willard')
				end
			</Effect>
		</Event>
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				unitSpeak(trigger.player,_("Hier steckt also dieser Willard."));
			</Effect>
		</Event>
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished == false) then
					return (unitIsInArea(trigger.player,"WillardArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		<Event trigger ="unit_dead">
			<Condition>
				if (rescue_willard.started == true and rescue_willard.finished ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				insertTrigger("checkWillardSafety")
			</Effect>
		</Event>
		
		
		<Event trigger ="checkWillardSafety">
			<Condition>
				local list = getMonstersInArea('WillardEnemiesArea')
				if (list[1] == nil and rescue_willard.started == true and rescue_willard.finished ~= true and rescue_willard_tmp.freed ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				rescue_willard_tmp.willard = createObject('peasant', 'willard:locWillard')
				setRefName(rescue_willard_tmp.willard, 'Willard')
				rescue_willard_tmp.freed = true
				set(rescue_willard_tmp.willard,"ignored_by_ai",true);
			</Effect>
		</Event>
	</Region>
	
</Quest>

