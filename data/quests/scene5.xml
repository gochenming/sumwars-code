<Quest name="Findet den Weg auf dem die Untoten die Stadt umgehen" table_name="scene5">
	
	<Init>
	</Init>
	
	<Description>
		if (scene5.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	
	<Region name="aisMounPath">
		<Event trigger="create_region" once="true">
			<Effect>
				addArea("aisMounPathEntryEastArea","circle","entry_east",10);
				addArea("aisMounPathPartyArea","circle","locPartyEntry",3);
				
				scene5_tmp.guard1 = createObject("guard", "locGuard1");
				setRefName(scene5_tmp.guard1, "Elementaristenwaechter1");
				setObjectValue(scene5_tmp.guard1,"max_health",1000);
				setObjectValue(scene5_tmp.guard1,"health",100);
				
				scene5_tmp.guard2 = createObject("guard", "locGuard2");
				setRefName(scene5_tmp.guard2, "Elementaristenwaechter2");
				
				
				scene5_tmp.guard3 = createObject("guard", "locGuard3");
				setRefName(scene5_tmp.guard3, "Elementaristenwaechter3");
				
				scene5_tmp.guard4 = createObject("guard", "locGuard4");
				setRefName(scene5_tmp.guard4, "Elementaristenwaechter4");
				
				
				scene5_tmp.dead_guard1 = createObject("guard", "locDeadGuard1");
				setRefName(scene5_tmp.dead_guard1, "Guard");
				setObjectValue(scene5_tmp.dead_guard1,"health",0);
				
				scene5_tmp.dead_guard2 = createObject("guard", "locDeadGuard2");
				setRefName(scene5_tmp.dead_guard2, "Guard");
				setObjectValue(scene5_tmp.dead_guard2,"health",0);
				
				
				scene5_tmp.erzmaga_ireana = createObject("peasant_f", "locIreana");
				setRefName(scene5_tmp.erzmaga_ireana, "Erzmaga Ireana von Nordenburg");
				setObjectValue(scene5_tmp.erzmaga_ireana,"max_health",10000);
				setObjectValue(scene5_tmp.erzmaga_ireana,"health",3000);
				
				scene5_tmp.hauptmann_der_wache = createObject("guard", "locCaptain");
				setRefName(scene5_tmp.hauptmann_der_wache, "Guardcaptain");
				setObjectValue(scene5_tmp.hauptmann_der_wache,"max_health",10000);
				setObjectValue(scene5_tmp.hauptmann_der_wache,"health",9000);
			</Effect>
		</Event>

		<Event trigger ="unit_dead">
			<Condition>
				return (get(trigger.unit,'subtype') == 'guard')
			</Condition>
			<Effect>
				setUnitAction(trigger.unit,"dead",0,600000);
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (scene4.scene4 == true and scene5.scene5 ~= true) then
				return (unitIsInArea(trigger.player,"aisMounPathPartyArea"));
				else
				return false;
				end;
			</Condition>
			<Effect>
				
				
				scene5_tmp.skeletons={};
				for nr=1,8 do
					scene5_tmp.skeletons[nr] = createObject("bow_skel","locSkeleton"..nr);
				end;
				scene5_tmp.skeletons_nr =8;
				
				setCutsceneMode(true);
				
				timedExecute('addUnitCommand(scene5_tmp.skeletons[1], "range_attack", scene5_tmp.guard2,0,"repeat")',400);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[2], "range_attack", scene5_tmp.guard2,0,"repeat")',350);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[3], "range_attack", scene5_tmp.guard4,0,"repeat")',100);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[4], "range_attack", scene5_tmp.hauptmann_der_wache,0,"repeat")',75);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[5], "range_attack", scene5_tmp.erzmaga_ireana,0,"repeat")', 800);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[6], "range_attack", scene5_tmp.guard1,0,"repeat")', 650);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[7], "range_attack", scene5_tmp.guard1,0,"repeat")',523);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[8], "range_attack", scene5_tmp.guard3,0,"repeat")', 250);
				
				lookAtObject(scene5_tmp.guard1, scene5_tmp.skeletons[6]);
				lookAtObject(scene5_tmp.guard2, scene5_tmp.skeletons[2]);
				lookAtObject(scene5_tmp.guard3, scene5_tmp.skeletons[8]);
				lookAtObject(scene5_tmp.guard4, scene5_tmp.skeletons[3]);
				lookAtObject(scene5_tmp.erzmaga_ireana, scene5_tmp.hauptmann_der_wache);
				lookAtObject(scene5_tmp.hauptmann_der_wache, scene5_tmp.erzmaga_ireana);
				
				addCameraPosition(0,get(getRole("PL"),"position"),-50,40,20);
				addCameraPosition(5000,get(scene5_tmp.erzmaga_ireana,"position"),-50,40,20);
				
				startTimer('scene5_dialogue1',10000);
			</Effect>
		</Event>
		
		<Topic name="insertion_guard_dies">
			<Effect>
				unitSpeak("W1",_("*urgh*"));
				setObjectValue(scene5_tmp.guard1,"health",0);
			</Effect>
		</Topic>
		
		<Event trigger="scene5_dialogue1">
			<Effect>
				
				addCameraPosition(1000,get(getRole("PL"),"position"),-50,40,20);
				-- Die Party erreicht den Ort des Geschehens. Die Kutsche der Erzmaga
				-- ist verunglueckt, mehrere Skelettbogenschuetzen beschie√üen sie mit
				-- Feuerpfeilen und die Wachen sind allesamt verwundet.
				
				playersLookAt(getPosition(scene5_tmp.erzmaga_ireana));
				lookAtObject(scene5_tmp.guard1, getRole("PL"));
				
				createDialogue();
				addSpeaker(scene5_tmp.guard1,"W1");
				addSpeaker(scene5_tmp.soren_windclaw_crystal,"SW");
				addSpeaker(scene5_tmp.erzmaga_ireana,"IvN");
				addSpeaker(scene5_tmp.hauptmann_der_wache,"HW");
				addSpeaker(scene5_tmp.guard2,"EW");
				addSpeaker(trigger.player,"Player");
				addStandardSpeakers("aisMounPath","locPartyEntry");
				
				speak("nobody","","",2000);
				speak("MALEast",_("Wow, she's gorgeous"));
				speak("PL",_("You can stare at her later, we have to erase some undead."));
				speak("HW",_("Please help us, the maga is badly injured!"));
				
				-- W1 (Wird toedlich getroffen): *hurgs*
				jumpTopic("insertion_guard_dies");
				speak("nobody","","",1000);
				speak("WARast",_("He he. Harvest!"));
				
				-- Sie kaempfen. Die Untoten warten mit einer etwas unschoenen
				-- ueberraschung auf (starkes Monster) werden aber sicherlich bald
				-- besiegt ;-)
				
				changeTopic("end_cutscene5_fight");
			</Effect>
		</Event> 
		
		<Topic name="end_cutscene5_fight">
			<Effect>
				setCutsceneMode(false);
				
				for nr=1,8 do
					clearUnitCommands(scene5_tmp.skeletons[nr]);
				end;
				set(scene5_tmp.hauptmann_der_wache,"state","inactive");
			</Effect>
		</Topic>
		
		<Event trigger ="unit_die">
			<Condition>
				return (get(trigger.unit,'subtype') == 'bow_skel')
			</Condition>
			<Effect>
				scene5_tmp.skeletons_nr = scene5_tmp.skeletons_nr -1;
				if (scene5_tmp.skeletons_nr == 0) then
				
					if (isCreature(scene5_tmp.guard2)) then
						addUnitCommand(scene5_tmp.guard2, "walk", "locGuard2")
					end;
					if (isCreature(scene5_tmp.guard3)) then
						addUnitCommand(scene5_tmp.guard3, "walk", "locGuard3")
					end;
					if (isCreature(scene5_tmp.guard4)) then
						addUnitCommand(scene5_tmp.guard4, "walk", "locGuard4")
					end;
				
					startTimer("scene5_dialogue2",3000);
				end;
			</Effect>
		</Event>
		
		<Event trigger="scene5_dialogue2">
			<Effect>
				set(scene5_tmp.hauptmann_der_wache,"state","active");

				scene5_tmp.soren_windclaw_crystal = createObject("peasant", "locParty");
				setRefName(scene5_tmp.soren_windclaw_crystal, "Soren Windclaw");
				setObjectValue(scene5_tmp.soren_windclaw_crystal,"max_health",10000);
				setObjectValue(scene5_tmp.soren_windclaw_crystal,"health",10000);
				
				
				
				createDialogue();
				addSpeaker(scene5_tmp.soren_windclaw_crystal,"SW");
				addSpeaker(scene5_tmp.erzmaga_ireana,"IvN");
				addSpeaker(scene5_tmp.hauptmann_der_wache,"HW");
				addSpeaker(scene5_tmp.guard2,"EW");
				addSpeaker(trigger.player,"Player");
				addStandardSpeakers("aisMounPath","locParty");
				
				setCutsceneMode(true);
					
				addCameraPosition(0,get(getRole("PL"),"position"),-50,40,10);
				
				playersLookAt(getPosition(scene5_tmp.erzmaga_ireana));
				lookAtObject(scene5_tmp.soren_windclaw_crystal, scene5_tmp.erzmaga_ireana);
				lookAtObject(scene5_tmp.erzmaga_ireana, getRole("PL"));
				lookAtObject(scene5_tmp.hauptmann_der_wache, getRole("PL"));
				
				speak("HW",_("I have never seen someone fight like you before."));
				speak("MAGast",_("You don't get out very often, do you."));
				speak("PL",_("How is the archmaga?"));
				speak("HW",_("Very bad, I'm afraid."));
				speak("PL",_("Let me see."));
				
				-- PL heilt sie
				-- Wenn es keinen Priester in der Gruppe gibt, springt der MAG
				-- mit einem Trank ein, ansonsten der PL
				
				speak("IvN",_("Thank you. That was a close call for a rescue."));
				speak("PL",_("How could it even come to this?"));
				speak("PL",_("It's very dangerous to travel so far from the roads."));
				speak("WARast",_("Come off it!"));
				speak("IvN",_("No, no, it's the truth."));
				speak("IvN",_("It was not the best idea, but the streets are not safe these days and thus we wanted to travel concealed."));
				speak("HW",_("These undead layed an ambush for us here."));
				speak("ARC",_("Surprise!"));
				speak("ARC",_("No wander, this is combat area."));
				speak("HW",_("No, Dwarfenfroward hasn't fallen yet."));
				speak("HW",_("As long as that city stands the entry to the lands of the undead is blocked."));
				speak("HW",_("But I fear they have found a way around the citywalls."));
				speak("IvN",_("We mustn't allow this."));
				speak("IvN",_("If those monsters could avoid Dwarfenfroward they would advance into Aisen before one week is gone."));
				speak("SW",_("It was exeedingly careless of you to leave with so few men."));
				speak("IvN",_("The city needs every man it can get!"));
				speak("PL",_("I have a feeling what's going to come in a moment..."));
				--TODO Unterscheidung Einzel/Party
				speak("SW",_("Listen, Branded Ones!"));
				speak("HW",_("What?!?"));
				speak("HW",_("Those are Branded Ones?"));
				speak("IvN",_("Let it go."));
				speak("IvN",_("They are on our side."));
				speak("SW",_("Find the way the undead came here and render it useless."));
				speak("IvN",_("Don't you want to give them some backup?"));
				speak("SW",_("I can do what I want!"));
				speak("PL",_("Of course..."));
				speak("MAG",_("Slowly he's getting to me..."));
				speak("WAR",_("Only now?"));
				speak("MAGast",_("Mages have to be naturally patient."));
				speak("IvN",_("I'm sure the undead found a hidden cave."));
				speak("IvN",_("Please take this explosion spell."));
				speak("IvN",_("It surely will be useful."));
				speak("HW",_("I know of a cave system north of here."));
				speak("ARCast",_("Should that frighten us?"));
				speak("HW",_("... probably not."));
				speak("PL",_("Thanks for your help."));
				speak("IvN",_("Good luck!"));
				speak("IvN",_("I hope we meet again soon."));
				
				-- Hauptquest: Findet den Weg, auf dem die Untoten die Stadt umgehen
				
				changeTopic("end_cutscene5");
			</Effect>
		</Event>
		
		<Topic name="end_cutscene5">
			<Effect>
				scene5.scene5 = true;
				scene5.started = true;
				timedExecute("setCutsceneMode(false);",1000);
				deleteObject(scene5_tmp.soren_windclaw_crystal);
			</Effect>
		</Topic>

	</Region>
	
</Quest>

