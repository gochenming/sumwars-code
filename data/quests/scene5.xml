<Quest name="Findet den Weg auf dem die Untoten die Stadt umgehen" table_name="scene5">
	
	<Init>
	</Init>
	
	<Description>
		if (scene5.finished) then
			return _("Die gute Nachricht: Durch diesen Tunnel kommt niemand mehr. Die schlechte: Den Rückweg hat es auch verschuettet. Hoffentlich gibt es noch einen anderen Ausgang.")
		else
			return _("Die Untoten haben einen Weg unter der Grauen Himmelsleiter gefunden, auf dem sie Zwergentrutz umgehen koennen. Da dies das Königreich Aisen direkt bedroht, muss der Zugang schnellstmoeglich verschlossen werden. Der Durchgang in den Verfluchten Hoelen muss gefunden und mit dem Sprengzauber Ierana von Nordenburgs zerstoert werden.")
		end
	</Description>
	
	<Region name="aisMounPath">
		<Event trigger="create_region" once="true">
			<Effect>
				addArea("aisMounPathPartyArea","circle","locPartyEntry",3);
				
				scene5_tmp.guard1 = createObject("guard", "locGuard1");
				setRefName(scene5_tmp.guard1, "Elementaristenwaechter1");
				setObjectValue(scene5_tmp.guard1,"max_health",1000);
				setObjectValue(scene5_tmp.guard1,"health",100);
				
				scene5_tmp.guard2 = createObject("guard", "locGuard2");
				setRefName(scene5_tmp.guard2, "Elementaristenwaechter2");
				
				
				scene5_tmp.guard3 = createObject("guard", "locGuard3");
				setRefName(scene5_tmp.guard3, "Elementaristenwaechter3");
				
				scene5_tmp.guard4 = createObject("guard", "locGuard4");
				setRefName(scene5_tmp.guard4, "Elementaristenwaechter4");
				
				
				scene5_tmp.dead_guard1 = createObject("guard", "locDeadGuard1");
				setRefName(scene5_tmp.dead_guard1, "Guard");
				setObjectValue(scene5_tmp.dead_guard1,"health",0);
				
				scene5_tmp.dead_guard2 = createObject("guard", "locDeadGuard2");
				setRefName(scene5_tmp.dead_guard2, "Guard");
				setObjectValue(scene5_tmp.dead_guard2,"health",0);
				
				
				scene5_tmp.erzmaga_ireana = createObject("peasant_f", "locIreana");
				setRefName(scene5_tmp.erzmaga_ireana, "Erzmaga Ireana von Nordenburg");
				setObjectValue(scene5_tmp.erzmaga_ireana,"max_health",10000);
				setObjectValue(scene5_tmp.erzmaga_ireana,"health",3000);
				
				scene5_tmp.hauptmann_der_wache = createObject("guard", "locCaptain");
				setRefName(scene5_tmp.hauptmann_der_wache, "Guardcaptain");
				setObjectValue(scene5_tmp.hauptmann_der_wache,"max_health",10000);
				setObjectValue(scene5_tmp.hauptmann_der_wache,"health",9000);
				
				scene5_tmp.tolec = createObject("tolec", "locTolec");
				setRefName(scene5_tmp.tolec, "Tolec");
					
				scene5_tmp.derred = createObject("derred", "locDerred");
				setRefName(scene5_tmp.derred, "Derred");
			</Effect>
		</Event>

		<Event trigger ="unit_dead">
			<Condition>
				return (get(trigger.unit,'subtype') == 'guard')
			</Condition>
			<Effect>
				setUnitAction(trigger.unit,"dead",0,600000);
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (ambush.finished == true and scene5.scene5 ~= true) then
				return (unitIsInArea(trigger.player,"aisMounPathPartyArea"));
				else
				return false;
				end;
			</Condition>
			<Effect>
				scene5_tmp.skeletons={};
				for nr=1,8 do
					scene5_tmp.skeletons[nr] = createObject("bow_skel","locSkeleton"..nr);
				end;
				scene5_tmp.skeletons_nr =8;
				
				setCutsceneMode(true);
				
				timedExecute('addUnitCommand(scene5_tmp.skeletons[1], "range_attack", scene5_tmp.guard2,0,"repeat")',400);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[2], "range_attack", scene5_tmp.guard2,0,"repeat")',350);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[3], "range_attack", scene5_tmp.guard4,0,"repeat")',100);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[4], "range_attack", scene5_tmp.hauptmann_der_wache,0,"repeat")',75);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[5], "range_attack", scene5_tmp.erzmaga_ireana,0,"repeat")', 800);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[6], "range_attack", scene5_tmp.guard1,0,"repeat")', 650);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[7], "range_attack", scene5_tmp.guard1,0,"repeat")',523);
				timedExecute('addUnitCommand(scene5_tmp.skeletons[8], "range_attack", scene5_tmp.guard3,0,"repeat")', 250);
				
				lookAtObject(scene5_tmp.guard1, scene5_tmp.skeletons[6]);
				lookAtObject(scene5_tmp.guard2, scene5_tmp.skeletons[2]);
				lookAtObject(scene5_tmp.guard3, scene5_tmp.skeletons[8]);
				lookAtObject(scene5_tmp.guard4, scene5_tmp.skeletons[3]);
				lookAtObject(scene5_tmp.erzmaga_ireana, scene5_tmp.hauptmann_der_wache);
				lookAtObject(scene5_tmp.hauptmann_der_wache, scene5_tmp.erzmaga_ireana);
				
				addCameraPosition(0,get(getRole("PL"),"position"),-50,40,20);
				addCameraPosition(5000,get(scene5_tmp.erzmaga_ireana,"position"),-50,40,20);
				
				startTimer('scene5_dialogue1',10000);
				print("attacking the convoi")
			</Effect>
		</Event>
		
		<Topic name="insertion_guard_dies">
			<Effect>
				unitSpeak("W1",_("*urgh*"));
				setObjectValue(scene5_tmp.guard1,"health",0);
			</Effect>
		</Topic>
		
		<Event trigger="scene5_dialogue1">
			<Effect>
				print("assembling the party")
				assembleParty("aisMounPath","locPartyEntry");
				scene5_tmp.beforeBattle = true;
			</Effect>
		</Event>
		
		<Event trigger="party_complete">
			<Condition>
				print("checking for started scene")
				return(scene5_tmp.beforeBattle == true);
			</Condition>
			<Effect>
				print("starting scene")
				addCameraPosition(1000,get(getRole("PL"),"position"),-50,40,20);
				-- Die Party erreicht den Ort des Geschehens. Die Kutsche der Erzmaga
				-- ist verunglueckt, mehrere Skelettbogenschuetzen beschießen sie mit
				-- Feuerpfeilen und die Wachen sind allesamt verwundet.
				
				playersLookAt(getPosition(scene5_tmp.erzmaga_ireana));
				lookAtObject(scene5_tmp.guard1, getRole("PL"));
				
				createDialogue();
				addAllPlayersToDialog();
				
				addSpeaker(scene5_tmp.guard1,"W1");
				addSpeaker(scene5_tmp.soren_windclaw_crystal,"SW");
				addSpeaker(scene5_tmp.erzmaga_ireana,"IvN");
				addSpeaker(scene5_tmp.hauptmann_der_wache,"HW");
				addSpeaker(scene5_tmp.guard2,"EW");
				addStandardRoles();
				
				speakPause(2000);
				speak("male",_("Wow, she's gorgeous","inlove"));
				if((getSpeaker("male")~=getSpeaker("PL"))and (getSpeaker("male")~=nil))then
					speak("PL",_("You can stare at her later, we have to erase some undead."), "unhappy");
				end;
				speak("HW",_("Please help us, the maga is badly injured!", "panic"));
				
				-- W1 (Wird toedlich getroffen): *hurgs*
				jumpTopic("insertion_guard_dies");
				speakPause(1000);
				speak("waropt",_("He he. Harvest!","warcry"));
				
				-- Sie kaempfen. Die Untoten warten mit einer etwas unschoenen
				-- ueberraschung auf (starkes Monster) werden aber sicherlich bald
				-- besiegt ;-)
				
				changeTopic("end_cutscene5_fight");
			</Effect>
		</Event> 
		
		<Topic name="end_cutscene5_fight">
			<Effect>
				setCutsceneMode(false);
				
				for nr=1,8 do
					clearUnitCommands(scene5_tmp.skeletons[nr]);
				end;
				set(scene5_tmp.hauptmann_der_wache,"state","inactive");
			</Effect>
		</Topic>
		
		<Event trigger ="unit_die">
			<Condition>
				return (get(trigger.unit,'subtype') == 'bow_skel')
			</Condition>
			<Effect>
				scene5_tmp.skeletons_nr = scene5_tmp.skeletons_nr -1;
				if (scene5_tmp.skeletons_nr == 0) then
				
					if (isCreature(scene5_tmp.guard2)) then
						addUnitCommand(scene5_tmp.guard2, "walk", "locGuard2")
					end;
					if (isCreature(scene5_tmp.guard3)) then
						addUnitCommand(scene5_tmp.guard3, "walk", "locGuard3")
					end;
					if (isCreature(scene5_tmp.guard4)) then
						addUnitCommand(scene5_tmp.guard4, "walk", "locGuard4")
					end;
				
					startTimer("scene5_dialogue2",3000);
				end;
			</Effect>
		</Event>
		
		<Event trigger = "scene5_dialogue2">
			<Effect>
				assembleParty("aisMounPath","locParty");
				scene5_tmp.afterBattle = true;
			</Effect>
		</Event>
		
		<Event trigger="party_complete">
			<Condition>
				return (scene5_tmp.afterBattle==true);
			</Condition>
			<Effect>
				set(scene5_tmp.hauptmann_der_wache,"state","active");

				scene5_tmp.soren_windclaw_crystal = createObject("sorenCrystal", "locDeadSkeleton4");
				setRefName(scene5_tmp.soren_windclaw_crystal, "Soren Windclaw");
				setObjectValue(scene5_tmp.soren_windclaw_crystal,"max_health",10000);
				setObjectValue(scene5_tmp.soren_windclaw_crystal,"health",10000);
				
				
				
				createDialogue();
				addSpeaker(scene5_tmp.soren_windclaw_crystal,"SW");
				addSpeaker(scene5_tmp.erzmaga_ireana,"IvN",true);
				addSpeaker(scene5_tmp.hauptmann_der_wache,"HW",true);
				addSpeaker(scene5_tmp.tolec,"TO",true);
				addSpeaker(scene5_tmp.derred,"DE",true);
				addAllPlayersToDialog();
				addStandardRoles();
				
				setCutsceneMode(true);
					
				addCameraPosition(0,get(getRole("PL"),"position"),-50,40,10);
				
				playersLookAt(getPosition(scene5_tmp.erzmaga_ireana));
				lookAtObject(scene5_tmp.soren_windclaw_crystal, scene5_tmp.erzmaga_ireana);
				lookAtObject(scene5_tmp.erzmaga_ireana, getRole("PL"));
				lookAtObject(scene5_tmp.hauptmann_der_wache, getRole("PL"));
				
				speak("HW",_("I have never seen someone fight like you before.", "surprised"));
				speak("mage",_("You don't get out very often, do you.","sneer"));
				---einzahl/mehrzahl
				speak("TO",_("Ihr habt euch praechtig entwickelt, seit wir uns das letzte Mal gesehen haben, oder?","grin"));
				speak("PL",_("How is the archmaga?","thoughtful"));
				speak("HW",_("Very bad, I'm afraid.","sad"));
				if(getSpeaker("priest") ~=nil)then
					speak("priest",_("Let me see."),"normal");
					executeInDialog("addUnitCommand(getSpeaker('priest'),'heal')");
				elseif(getSpeaker("mage")~=nil)then
					speak("mage",_("Let me see.","normal"));
				else
					speak("PL",_("Let me see.","normal"));
				end;
				
				-- PRI heilt sie
				-- Wenn es keinen Priester in der Gruppe gibt, springt der MAG
				-- mit einem Trank ein, ansonsten der PL
				
				speak("IvN",_("Thank you. That was a close call for a rescue.","inlove"));
				speak("PL",_("How could it even come to this?","unhappy"));
				speak("PL",_("It's very dangerous to travel so far from the roads."));
				speak("warrior",_("Come off it!","unhappy"));
				speak("IvN",_("No, no, it's the truth.","sad"));
				speak("IvN",_("It was not the best idea, but the streets are not safe these days and thus we wanted to travel concealed.","normal"));
				speak("HW",_("These undead layed an ambush for us here.","angry"));
				speak("arcopt",_("Surprise!","sneer"));
				speak("arcopt",_("No wander, this is combat area."));
				speak("HW",_("No, Dwarfenwall hasn't fallen yet.","thoughtful"));
				speak("HW",_("As long as that city stands, the entry to the lands of the undead is blocked."));
				speak("HW",_("But I fear they must have found a way around the citywalls.", "sad"));
				speak("IvN",_("We mustn't allow this.", "unhappy"));
				speak("IvN",_("If those monsters could avoid Dwarfenwall they would advance into Aisen before one week is gone."));
				speak("SW",_("It was exeedingly careless of you to leave with so few men.", "unhappy"));
				speak("IvN",_("The city needs every man it can get!","angry"));
				speak("PL",_("I have a feeling what's going to come in a moment...", "bored"));
				if(solo())then
					speak("SW",_("Listen, Branded One!","normal"));
					speak("HW",_("What?!?","surprise"));
					speak("HW",_("That's a Branded One?","fear"));
				else
					speak("SW",_("Listen, Branded Ones!","normal"));
					speak("HW",_("What?!?","surprise"));
					speak("HW",_("Those are Branded Ones?","fear"));
				end;
				speak("IvN",_("Let it go.","aloof"));
				speak("IvN",_("They are on our side.","happy"));
				speak("SW",_("Find the way the undead came here and render it useless."));
				speak("IvN",_("Don't you want to give them some backup?","surprise"));
				speak("SW",_("I can do what I want!","unhappy"));
				speak("PL",_("Of course...","bored"));
				speak("magopt",_("Slowly he's getting to me...","angry"));
				if(getSpeaker("magopt") ~= getSpeaker("waropt"))then
					speak("waropt",_("Only now?","surprise"));
					speak("mage",_("Mages have to be naturally patient.","aloof"));
				end;
				speak("IvN",_("I'm sure the undead found a hidden cave.","thoughtful"));
				speak("IvN",_("Please take this explosion spell.","normal"));
				speak("IvN",_("It surely will be useful."));
				speak("HW",_("I know of a cave system north of here.","normal"));
				speak("HW",_("They say it's cursed.","threaten"));
				speak("arcopt",_("Should that frighten us?","sneer"));
				speak("HW",_("...","offended","1500"));
				speak("HW",_("probably not.","normal"));
				speak("PL",_("Thanks for your help.","normal"));
				speak("IvN",_("Good luck!","sad"));
				speak("IvN",_("I hope we meet again soon.","happy"));
				
				-- Hauptquest: Findet den Weg, auf dem die Untoten die Stadt umgehen
				
				changeTopic("end_cutscene5");
			</Effect>
		</Event>
		
		<Topic name="end_cutscene5">
			<Effect>
				scene5.scene5 = true;
				scene5.started = true;
				timedExecute("setCutsceneMode(false);",1000);
				deleteObject(scene5_tmp.soren_windclaw_crystal);
			</Effect>
		</Topic>

	</Region>
	
</Quest>

