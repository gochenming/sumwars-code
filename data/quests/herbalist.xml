<Quest name="Kraeutersammler" table_name="herbalist">
	
	<Init>
		herbalist.bushes = 0
	</Init>
	
	<Description>
		if (herbalist.finished) then
			return _("Und wieder eine gute Tat mehr. Ich koennte mich fast daran gewoehnen.")
		else
			return _("Die Kraeuterfrau aus Joringsbrueck will die Beeren von 10 Bueschen haben. Es muessen noch "..(10 - herbalist.bushes).." Stueck gesammelt werden.")
		end
	</Description>
	
	<Region name="joringsbridge">
		<Event trigger ="create_region" once = "true">
			<Effect>
				if(herbalist.asked ~= true)then
					herbalist_tmp.gertlinde = createObject("peasant_f", "locHerbalist");
				else
					herbalist_tmp.gertlinde = createObject("peasant_f", "locHerbalistHome");
					set(herbalist_tmp.gertlinde,"angle", 190);
				end;
				setRefName(herbalist_tmp.gertlinde, "Gertlinde Kampfer");
			</Effect>
		</Event>
		
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (herbalist.asked ~= true) then
					return (unitIsInArea(trigger.player,"areaGertlinde"))
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.asked = true
				createDialogue()
				addSpeaker(trigger.player,'player')
				setTopicBase("Gertlinde Kampfer");
				setDialogueActive(false);
				changeTopic("herbalist");
				herbalist_tmp.player = trigger.player;
				addArea("areaHerbQuest",{"circle",get(trigger.player,"position"),5});
				local players = getPlayersInArea("areaHerbQuest");
				addPlayersToDialog(players);
				players = listToSet(players);
				addStandardRoles(players);
				addUnitCommand(herbalist_tmp.gertlinde,'walk',trigger.player,1.5);
			</Effect>
		</Event>
		
		<Event trigger="command_complete" once = "true">
			<Condition>
				return ((trigger.unit == herbalist_tmp.gertlinde) and(herbalist.asked == true));
			</Condition>
			<Effect>
				setCurrentDialogue(herbalist_tmp.player);
				addSpeaker(herbalist_tmp.gertlinde, "Gertlinde Kampfer");
				lookAtObject(herbalist_tmp.gertlinde,herbalist_tmp.player);
				lookAtObject(herbalist_tmp.player,herbalist_tmp.gertlinde);
				setDialogueActive(true);
			</Effect>
		</Event>
		
	</Region>
	
	
	<NPC refname="Gertlinde Kampfer">
		<Topic name="herbalist" start_option="Herb gathering">
			<Condition>
				if (herbalist.finished ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				if (herbalist.started == true) then
					if (herbalist.bushes >= 10) then
						speak('player',_("Hier, alte Frau. Eure Kraeuter."))
						speak('Gertlinde Kampfer',_("Ah, gut gemacht, Jungvolk."))
						speak('Gertlinde Kampfer',_("Hier, lass dir als Gegenleistung etwas geben."))
						changeTopic("herbalist_reward")
					else
						speak('Gertlinde Kampfer',_("Ich brauche mehr Beeren, damit ich damit etwas sinnvolles anfangen kann."))
					end
				elseif(herbalist.asked==true)then
					speak('Gertlinde Kampfer',_("Wollt ihr doch noch Beeren sammeln?"))
					addQuestion(_("Quest annehmen?"))
					addAnswer(_("Ja"),"start_herbalist_quest_again")
					addAnswer(_("Nein"),"refuse_herbalist_quest_again")
				else
					speak('Gertlinde Kampfer',_("He da, Jungvolk!"))
					speak('Gertlinde Kampfer',_("Ich sehe, dass ihr in die Noerdlichen Wiesen wollt."),"thoughtful");
					speak('player',_("Das Stimmt."))
					if(getSpeaker("mage")~=getSpeaker('player'))then
						speak("mage",_("Kunststueck."))
						speak("mage",_("Immerhin wollten wir nur gerade durch das Tor."))
						speak("priest",_("Frieden."))
					end;
					speak('Gertlinde Kampfer',_("Wenn ihr sowieso da umher stiefelt und tut was ihr so eben tut, koenntet ihr mir nicht gleich noch ein paar Beeren sammeln?"),"happy");
					speak('Gertlinde Kampfer',_("Mit den ganzen Goblins kann sich eine alte Frau wie ich ja nicht mal mehr vor die Tuer wagen."),"sad");
					setSpeakerEmotion('Gertlinde Kampfer',"normal");
					speak('player',_("Pflanzen sind nicht unbedingt meine Spezialitaet..."),"unhappy")
					speak('Gertlinde Kampfer',_("Ach papperlapapp!"),"unhappy");
					setSpeakerEmotion('player',"normal");
					speak('Gertlinde Kampfer',_("Ich will ja nicht, dass ihr was exotisches sammelt."))
					speak('Gertlinde Kampfer',_("Nur Rilfbeeren."),"grin")
					speak('Gertlinde Kampfer',_("Das sind gro√üe Buesche mit auffaelligen roten Fruechten."),"normal");
					speak('Gertlinde Kampfer',_("Die findet ihr bestimmt."))
					speak('Gertlinde Kampfer',_("Damit es sich lohnt muesstet ihr mir die Beeren von wenigstens zehn Bueschen bringen."))
					speak('Gertlinde Kampfer',_("Aber nur die roten Beeren."),"thoughtful")
					speak('Gertlinde Kampfer',_("Der Rest ist voellig uninteressant."),"grin")
					addQuestion(_("Quest annehmen?"))
					addAnswer(_("Ja"),"start_herbalist_quest")
					addAnswer(_("Nein"),"refuse_herbalist_quest")
				end
			</Effect>
		</Topic>
		
		<Topic name="start_herbalist_quest" >
			<Effect>
				if(solo())then
					speak('player', _("Na schoen, wenn ich welche finde, bringe ich es mit."),"normal");
				else
					speak('player', _("Na schoen, wenn wir welche finden, bringen wir sie mit."),"normal");
				end;
				speak('Gertlinde Kampfer',_("Danke  Herzchen."),"happy");
				herbalist.bushes = 0
				herbalist.started = true
				startTimer("talk_done",4000);
			</Effect>	
		</Topic>
		
		<Topic name="refuse_herbalist_quest" >
			<Effect>
				speak('player', _("Vergiss es, Kraeuterhexe."),"unhappy")
				speak('player', _("Ich werde bestimmt nicht durch die Wiesen kriechen und nach irgendwelchen Bueschen suchen."))
				speak('Gertlinde Kampfer',_("Wie du meinst."),"sad")
				speak('Gertlinde Kampfer',_("Aber wenn du es dir noch mal anders ueberlegst, ich werde hier nicht weglaufen."),"normal");
				startTimer("talk_done",4000);
			</Effect>	
		</Topic>
		
		<Topic name="start_herbalist_quest_again" >
			<Effect>
				if(solo())then
					speak('player', _("Na schoen, wenn ich welche finde, bringe ich es mit."),"normal");
				else
					speak('player', _("Na schoen, wenn wir welche finden, bringen wir sie mit."),"normal");
				end;
				speak('Gertlinde Kampfer',_("Danke  Herzchen."),"happy");
				herbalist.bushes = 0
				herbalist.started = true
			</Effect>	
		</Topic>
		
		<Topic name="refuse_herbalist_quest_again" >
			<Effect>
				speak('player', _("Nein, immer noch nicht."),"unhappy");
				speak('Gertlinde Kampfer',_("Sag Bescheid, wenn du nicht mehr zu maechtig fuer einfache Arbeiten bist, Herzchen."),"sneer");
				speak('player',_("Huetet Eure Zunge, Weib!"),"angry");
			</Effect>	
		</Topic>
		
		<Topic name="herbalist_reward">
			<Condition>
				if (herbalist.finished ~= true and herbalist.bushes >= 10) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.finished = true
				local players = getPlayers()
				local i,player
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"herbalist.reward") ~= true) then
						setPlayerPrivateVar(player,"herbalist.reward",true)
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 50)
					end
				end
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_2", "locHerbalist")
			</Effect>
		</Topic>
	</NPC>
	
	<Region name="joringsbridge">
		<Event trigger ="talk_done" once = "true">
			<Effect>
				addUnitCommand(herbalist_tmp.gertlinde,'walk','locHerbalistHome');
				herbalist_tmp.walkBack = true;
			</Effect>
		</Event>
		<Event trigger ="command_complete" once = "true">
			<Condition>
				return ((trigger.unit == herbalist_tmp.gertlinde) and (herbalist_tmp.walkBack == true)) 
			</Condition>	
			<Effect>
				set(herbalist_tmp.gertlinde,"angle",190);
			</Effect>
		</Event>
	</Region>
	
	<Region name="aisNorthMeadow">
	
		<Event trigger="berryBushPicked">
			<Effect>
				herbalist.bushes = herbalist.bushes + 1;
				bushes_left = 10 - herbalist.bushes;
				if (not (bushes_left>0)) then
					bushes_left = 0
				end
				print (_("Collect "..bushes_left.." more herbs."));
			</Effect>
		</Event>
	</Region>
	
</Quest>

