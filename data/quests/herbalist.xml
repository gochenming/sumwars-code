<Quest name="Kraeutersammler" table_name="herbalist">
	
	<Init>
		herbalist.bushes = 0
	</Init>
	
	<Description>
		if (herbalist.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	
	<NPC refname="Gertlinde Kampfer">
		<Topic name="herbalist" start_option="Herb gathering">
			<Condition>
				if (herbalist.finished ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				if (herbalist.started == true) then
					if (herbalist.bushes >= 10) then
						speak('player',_("Here, old woman. Your herbs."),1300)
						speak('Gertlinde Kampfer',_("Ah, well done, young one."),1300)
						speak('Gertlinde Kampfer',_("Let me give you something in return."),1300)
						changeTopic("herbalist_reward")
					else
						speak('Gertlinde Kampfer',_("You need to collect more herbs."),1400)
					end
				else
					speak('Gertlinde Kampfer',_("Hey there, young one."),1000)
					speak('Gertlinde Kampfer',_("I see, you're going to the Northern Meadow."),1500)
					speak('player',_("That's right."),1000)
					local spoken = false
					if (getPlayers()[2] ~= nil) then
						if (getPriests()[1] ~= getSpeaker("player")) then
							local priest = getPriests()[1]
						else
							local priest = getPriests()[2]
						end
						if (getMages()[1] ~= getSpeaker("player")) then
							local mage = getMages()[1]
						else
							local mage = getMages()[2]
						end
						addSpeaker(mage,"mage")
						addSpeaker(priest,"priest")
						if (mage ~= nil and priest ~= nil) then
							speak("mage",_("What a feat."),1000)
							speak("mage",_("We were only just walking through the gate."),2000)
							speak("priest",_("Peace."),1000)
						end
					end
					speak('Gertlinde Kampfer',_("If you're roaming the Meadow anyway and do whatever you're doing,"),3000)
					speak('Gertlinde Kampfer',_("would you be so kind as to bring me some herbs?"),2000)
					speak('Gertlinde Kampfer',_("With all those goblins an old lady can't even dare to go out of her door."),3000)
					speak('player',_("I don't exactly specialize in herbs..."),1800)
					speak('Gertlinde Kampfer',_("Fiddlesticks!"),1000)
					speak('Gertlinde Kampfer',_("I don't want you to gather someting exotic."),2000)
					speak('Gertlinde Kampfer',_("Just Rilfherb."),1300)
					speak('Gertlinde Kampfer',_("That's big bushes with flashy red flowers."),1800)
					speak('Gertlinde Kampfer',_("I'm sure you'll recognize it."),1300)
					speak('Gertlinde Kampfer',_("You'll have to bring at least ten bushels, or else it won't be worth the efford"),3000)
					speak('Gertlinde Kampfer',_("But only the small green leaves."),1300)
					speak('Gertlinde Kampfer',_("Not the big and old stuff, that's no good."),1800)
					addQuestion(_("Accept Quest?"))
					addAnswer(_("Yes"),"start_herbalist_quest")
					addAnswer(_("No"),"refuse_herbalist_quest")
				end
			</Effect>
		</Topic>
		
		<Topic name="start_herbalist_quest" >
			<Effect>
				speak('player', _("Fine, if I see anything, I'll bring it along."),2000)
				speak('Gertlinde Kampfer',_("Thanks sweety."),1000)
				herbalist.bushes = 0
				herbalist.started = true
			</Effect>	
		</Topic>
		
		<Topic name="refuse_herbalist_quest" >
			<Effect>
				speak('player', _("Forget it, herb woman."),1000)
				speak('player', _("I cocksure won't crawl throug the meadows searching for some bushes."),2800)
				speak('Gertlinde Kampfer',_("Suit yourself!"),1000)
				speak('Gertlinde Kampfer',_("But if you change your mind let me know"),1800)
				speak('Gertlinde Kampfer',_("I won't go anywere."),1200)
			</Effect>	
		</Topic>
		
		<Topic name="herbalist_reward">
			<Condition>
				if (herbalist.finished ~= true and herbalist.bushes >= 10) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.finished = true
				local players = getPlayers()
				local i,player
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"herbalist.reward") ~= true) then
						setPlayerPrivateVar(player,"herbalist.reward",true)
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 50)
					end
				end
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_2", "locHerbalist")
			</Effect>
		</Topic>
	</NPC>


	<Region name="joringsbridge" >
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (herbalist.asked ~= true) then
					return (unitIsInArea(trigger.player,"HerbalistArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.asked = true
				local pos = getPosition(trigger.player)
				addUnitCommand(gertlinde,'walk',1000,pos)
				startTimer("askGertlinde",1000)
				addTriggerVariable("player",trigger.player)
			</Effect>
		</Event>
		
		<Event trigger ="askGertlinde" once = "true">
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'player')
				addSpeaker(gertlinde_kampfer,'Gertlinde Kampfer')
				setTopicBase('Gertlinde Kampfer')
				changeTopic('herbalist')
			</Effect>
		</Event>
	</Region>
	
	
	<Region name="aisNorthMeadow">
		<Event trigger ="create_template">
			<Condition>
				return (trigger.templname == "herbalBushes")
			</Condition>
			<Effect>
				local tree = createObject('$tree',trigger.herb );
				createEvent("player_moved",true);
				local condition = 'return ((unitIsInArea(trigger.player,"circle",'..listToString(trigger.herb)..',6)) and herbalist.started == true and herbalist.finished ~= true)';
				addCondition(condition);
				local effect = 'insertTrigger("herb_found"); addTriggerVariable("tree",'..tree..')';
				addEffect(effect);
				print("\n");
				print(condition);
				print(effect);
			</Effect>
		</Event>

		<Event trigger="herb_found">
			<Effect>
				deleteObject(trigger.tree);
				herbalist.bushes = herbalist.bushes + 1;
				bushes_left = 10 - herbalist.bushes;
				if (not (bushes_left>0)) then
					bushes_left = 0
				end
				print (_("Collect "..bushes_left.." more herbs."));
			</Effect>
		</Event>
	</Region>
	
</Quest>

