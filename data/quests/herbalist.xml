<Quest name="Kraeutersammler" table_name="herbalist">
	
	<Init>
		herbalist.bushes = 0
	</Init>
	
	<Description>
		if (herbalist.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	
	<NPC refname="Gertlinde Kampfer">
		<Topic name="herbalist" start_option="Kraeutersammler">
			<Condition>
				if (herbalist.finished ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				if (herbalist.started == true) then
					if (herbalist.bushes >= 10) then
						speak('player',_("Hier alte Frau ..."),1000)
						speak('Gertlinde Kampfer',_("Ah, gut gemacht ..."),1000)
						changeTopic("herbalist_reward")
					else
						speak('Gertlinde Kampfer',_("Ihr muesst noch mehr Kraeuter sammeln."),1000)
					end
				else
					speak('Gertlinde Kampfer',_("He da, ..."),1000)
					speak('player',_("Das stimmt."),1000)
					createDialogue()
					local spoken = false
					if (getPlayers()[2] ~= nil) then
						if (getPriests()[1] ~= getSpeaker("player")) then
							local priest = getPriests()[1]
						else
							local priest = getPriests()[2]
						end
						if (getMages()[1] ~= getSpeaker("player")) then
							local mage = getMages()[1]
						else
							local mage = getMages()[2]
						end
						addSpeaker(mage,"mage")
						addSpeaker(priest,"priest")
						if (mage ~= nil and priest ~= nil) then
							speak("mage",_("Kunststueck: Immerhin wollten ..."),1000)
							speak("priest",_("Frieden."),1000)
						end
					end
					speak('Gertlinde Kampfer',_("Wenn ihr ..."),1000)
					speak('player',_("Kraeuter ..."),1000)
					speak('Gertlinde Kampfer',_("Ach ..."),1000)
					addQuestion(_("Quest annehmen?"))
					addAnswer(_("Yes"),"start_herbalist_quest")
					addAnswer(_("No"),"refuse_herbalist_quest")
				end
			</Effect>
		</Topic>
		
		<Topic name="start_herbalist_quest" >
			<Effect>
				speak('player', _("Na schoen, wenn ..."),1000)
				speak('Gertlinde Kampfer',_("Danke Herzchen."),1000)
				herbalist.bushes = 0
				herbalist.started = true
			</Effect>	
		</Topic>
		
		<Topic name="refuse_herbalist_quest" >
			<Effect>
				speak('player', _("Vergiss es ..."),1000)
				speak('Gertlinde Kampfer',_("Wie du meinst ..."),1000)
			</Effect>	
		</Topic>
		
		<Topic name="herbalist_reward">
			<Condition>
				if (herbalist.finished ~= true and herbalist.bushes >= 10) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.finished = true
				local players = getPlayers()
				local i,player
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"herbalist.reward") ~= true) then
						setPlayerPrivateVar(player,"herbalist.reward",true)
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 50)
					end
				end
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_2", "locHerbalist")
			</Effect>
		</Topic>
	</NPC>


	<Region name="joringsbridge" >
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (herbalist.asked ~= true) then
					return (unitIsInArea(trigger.player,"HerbalistArea"))
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.asked = true
				local pos = getPosition(trigger.player)
				addUnitCommand(gertlinde,'walk',1000,pos)
				startTimer("askGertlinde",1000)
				addTriggerVariable("player",trigger.player)
			</Effect>
		</Event>
		
		<Event trigger ="askGertlinde" once = "true">
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'player')
				addSpeaker(gertlinde_kampfer,'Gertlinde Kampfer')
				setTopicBase('Gertlinde Kampfer')
				changeTopic('herbalist')
			</Effect>
		</Event>
	</Region>
	
	
	<Region name="aisNorthMeadow">
		<Event trigger ="create_template">
			<Condition>
				return (trigger.templname == "herbalBushes")
			</Condition>
			<Effect>
				local tree = createObject('$tree',trigger.herb );
				createEvent("player_moved",true);
				local condition = 'return ((unitIsInArea(trigger.player,"circle",'..listToString(trigger.herb)..',6)) and herbalist.started == true and herbalist.finished ~= true)';
				addCondition(condition);
				local effect = 'insertTrigger("herb_found"); addTriggerVariable("tree",'..tree..')';
				addEffect(effect);
				print("\n");
				print(condition);
				print(effect);
			</Effect>
		</Event>

		<Event trigger="herb_found">
			<Effect>
				deleteObject(trigger.tree);
				herbalist.bushes = herbalist.bushes + 1;
				bushes_left = 10 - herbalist.bushes;
				if (not (bushes_left>0)) then
					bushes_left = 0
				end
				print (_("Collect "..bushes_left.." more herbs."));
			</Effect>
		</Event>
	</Region>
	
</Quest>

