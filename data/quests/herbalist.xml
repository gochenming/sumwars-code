<Quest name="Kraeutersammler" table_name="herbalist">
	
	<Init>
		herbalist.bushes = 0
	</Init>
	
	<Description>
		if (herbalist.finished) then
			return _("Und wieder eine gute Tat mehr. Ich koennte mich fast daran gewoehnen.")
		else
			return _("Die Kraeuterfrau aus Joringsbrueck will die Beeren von 10 Büschen haben.")
		end
	</Description>
	
	<Region name="joringsbridge">
		<Event trigger ="create_region" once = "true">
			<Effect>
				if(herbalist.asked ~= true)then
					herbalist_tmp.gertlinde = createObject("peasant_f", "locHerbalist");
				else
					herbalist_tmp.gertlinde = createObject("peasant_f", "locHerbalistHome");
					set(herbalist_tmp.gertlinde,"angle", 190);
				end;
				setRefName(herbalist_tmp.gertlinde, "Gertlinde Kampfer");
			</Effect>
		</Event>
		
		
		<Event trigger ="player_moved" once = "true">
			<Condition>
				if (herbalist.asked ~= true) then
					return (unitIsInArea(trigger.player,"areaGertlinde"))
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.asked = true
				createDialogue()
				addSpeaker(trigger.player,'player')
				setTopicBase("Gertlinde Kampfer");
				setDialogueActive(false);
				herbalist_tmp.player = trigger.player;
				addArea("areaHerbQuest","circle",get(trigger.player,"position"),5);
				local players = getPlayersInArea("areaHerbQuest");
				addPlayersToDialog(players);
				players = listToSet(players);
				addStandardRoles(players);
				addUnitCommand(herbalist_tmp.gertlinde,'walk',trigger.player,1.5);
			</Effect>
		</Event>
		
		<Event trigger="command_complete" once = "true">
			<Condition>
				return ((trigger.unit == herbalist_tmp.gertlinde) and(herbalist.asked == true));
			</Condition>
			<Effect>
				setCurrentDialogue(herbalist_tmp.player);
				addSpeaker(herbalist_tmp.gertlinde, "Gertlinde Kampfer");
			</Effect>
		</Event>
		
		<Event trigger ="askGertlinde" once = "true">
			<Effect>
				createDialogue()
				addSpeaker(trigger.player,'player')
				addSpeaker(gertlinde_kampfer,'Gertlinde Kampfer')
				setTopicBase('Gertlinde Kampfer')
				changeTopic('herbalist')
			</Effect>
		</Event>
	</Region>
	
	
	<NPC refname="Gertlinde Kampfer">
		<Topic name="herbalist" start_option="Herb gathering">
			<Condition>
				if (herbalist.finished ~= true) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				if (herbalist.started == true) then
					if (herbalist.bushes >= 10) then
						speak('player',_("Here, old woman. Your berries."))
						speak('Gertlinde Kampfer',_("Ah, well done, young one."))
						speak('Gertlinde Kampfer',_("Let me give you something in return."))
						changeTopic("herbalist_reward")
					else
						speak('Gertlinde Kampfer',_("I need more herbs if I want to do something."))
					end
				else
					speak('Gertlinde Kampfer',_("Hey there, young one."))
					speak('Gertlinde Kampfer',_("I see, you're going to the Northern Meadow."))
					speak('player',_("That's right."))
					local spoken = false
					if (getPlayers()[2] ~= nil) then
						if (getPriests()[1] ~= getSpeaker("player")) then
							local priest = getPriests()[1]
						else
							local priest = getPriests()[2]
						end
						if (getMages()[1] ~= getSpeaker("player")) then
							local mage = getMages()[1]
						else
							local mage = getMages()[2]
						end
						addSpeaker(mage,"mage")
						addSpeaker(priest,"priest")
						if (mage ~= nil and priest ~= nil) then
							speak("mage",_("What a feat."))
							speak("mage",_("We were only just walking through the gate."))
							speak("priest",_("Peace."))
						end
					end
					speak('Gertlinde Kampfer',_("If you're roaming the Meadow anyway and do whatever you're doing,"))
					speak('Gertlinde Kampfer',_("would you be so kind as to bring me some herbs?"))
					speak('Gertlinde Kampfer',_("With all those goblins an old lady can't even dare to go out of her door."))
					speak('player',_("I don't exactly specialize in herbs..."))
					speak('Gertlinde Kampfer',_("Fiddlesticks!"))
					speak('Gertlinde Kampfer',_("I don't want you to gather someting exotic."))
					speak('Gertlinde Kampfer',_("Just Rilfherb."))
					speak('Gertlinde Kampfer',_("That's big bushes with flashy red flowers."))
					speak('Gertlinde Kampfer',_("I'm sure you'll recognize it."))
					speak('Gertlinde Kampfer',_("You'll have to bring at least ten bushels, or else it won't be worth the efford"))
					speak('Gertlinde Kampfer',_("But only the small green leaves."))
					speak('Gertlinde Kampfer',_("Not the big and old stuff, that's no good."))
					addQuestion(_("Accept Quest?"))
					addAnswer(_("Yes"),"start_herbalist_quest")
					addAnswer(_("No"),"refuse_herbalist_quest")
				end
			</Effect>
		</Topic>
		
		<Topic name="start_herbalist_quest" >
			<Effect>
				speak('player', _("Fine, if I see anything, I'll bring it along."))
				speak('Gertlinde Kampfer',_("Thanks sweety."))
				herbalist.bushes = 0
				herbalist.started = true
			</Effect>	
		</Topic>
		
		<Topic name="refuse_herbalist_quest" >
			<Effect>
				speak('player', _("Forget it, herb woman."))
				speak('player', _("I cocksure won't crawl throug the meadows searching for some bushes."))
				speak('Gertlinde Kampfer',_("Suit yourself!"))
				speak('Gertlinde Kampfer',_("But if you change your mind let me know."))
				speak('Gertlinde Kampfer',_("I won't go anywere."))
			</Effect>	
		</Topic>
		
		<Topic name="herbalist_reward">
			<Condition>
				if (herbalist.finished ~= true and herbalist.bushes >= 10) then
					return true
				else
					return false
				end
			</Condition>
			<Effect>
				herbalist.finished = true
				local players = getPlayers()
				local i,player
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"herbalist.reward") ~= true) then
						setPlayerPrivateVar(player,"herbalist.reward",true)
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 50)
					end
				end
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_1", "locHerbalist")
				dropItem("heal_2", "locHerbalist")
			</Effect>
		</Topic>
	</NPC>
	
	
	<Region name="aisNorthMeadow">
		<Event trigger ="create_template">
			<Condition>
				return (trigger.templname == "herbalBushes")
			</Condition>
			<Effect>
				local tree = createObject('$tree',trigger.herb );
				createEvent("player_moved",true);
				local condition = 'return ((unitIsInArea(trigger.player,"circle",'..listToString(trigger.herb)..',6)) and herbalist.started == true and herbalist.finished ~= true)';
				addCondition(condition);
				local effect = 'insertTrigger("herb_found"); addTriggerVariable("tree",'..tree..')';
				addEffect(effect);
				print("\n");
				print(condition);
				print(effect);
			</Effect>
		</Event>

		<Event trigger="herb_found">
			<Effect>
				deleteObject(trigger.tree);
				herbalist.bushes = herbalist.bushes + 1;
				bushes_left = 10 - herbalist.bushes;
				if (not (bushes_left>0)) then
					bushes_left = 0
				end
				print (_("Collect "..bushes_left.." more herbs."));
			</Effect>
		</Event>
	</Region>
	
</Quest>

