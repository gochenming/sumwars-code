<Quest name="Tutorial" table_name="tutorial">
	
	<Init>
		tutorial.phase="intro"
		tutorial.phasenr =0;
	</Init>
	
	<Description>
		if (tutorial.finished) then
			return _("Tutorial finished")
		else
			if (tutorial.phase == "intro") then
				return _("Gib deine Waffen bei Derred ab.");
			elseif (tutorial.phase == "learnwalk") then
				return _("Folge Tolec und Derred.")
			elseif (tutorial.phase == "fightslugs") then
				return _("Töte alle Feuerschnecken in dem Gehege.");
			elseif (tutorial.phase == "findSecretDoor") then
				return _("Finde den geheimen Zugang zur Bibliothek.");
			elseif (tutorial.phase == "killlouses") then
				return _("Töte alle Abkömmlinge des Behemoth.");
			end
			return _("Quest description")
		end
	</Description>
	
	<Region name="elCnlLobby">
		<Event trigger="create_region" once="true">
			<Effect>
				if (tutorial.finished == false) then
					addArea("entryPlayerArea","circle","locEntryPlayer",5);
					addArea("dangerArea","circle","locBackroute2",4);
					addArea("locDoorArea","circle","locLibrarySecretDoor",3);
					addArea("seeLouseArea","circle","locBackroute5",4);
					addArea("mutantSlugsArea","rect","locBackroute3",{3,3});
					
					
					local tolecpos = "locTolec";
					local derredpos = "locDerred";
					if (tutorial.phase == "fightslugs") then
						tolecpos = "locWay2";
						derredpos = "locWay2";
					end;
					if (tutorial.phase == "findSecretDoor") then
						tolecpos = "locSlugView";
						derredpos = "locSlugView";
					end;
					if (tutorial.phase == "killlouses") then
						tolecpos = "locBackroute5";
						derredpos = "locBackroute5";
					end;
					
					tutorial_tmp.tolec = createObject("tolec", tolecpos);
					set(tutorial_tmp.tolec,"ai_state","inactive");
					setRefName(tutorial_tmp.tolec, "Tolec");
					
					tutorial_tmp.derred = createObject("derred", derredpos);
					set(tutorial_tmp.derred,"ai_state","inactive");
					setRefName(tutorial_tmp.derred, "Derred");
					
					-- nur bei den Phasen intro, learnwalk, fightslugs
					if (2 >= tutorial.phasenr) then
						createMonsterGroup("tutorialSlugs","locSlugs",8);
						tutorial_tmp.slugs =0;
					end;
					
					tutorial_tmp.bguard1 = createObject("council_guard","locDoorGuardNorth");
					setRefName(tutorial_tmp.bguard1, "Wache");
					lookAt(tutorial_tmp.bguard1,getLocation("locBehemoth"));
				
					tutorial_tmp.bguard2 = createObject("council_guard","locDoorGuardWest");
					setRefName(tutorial_tmp.bguard2, "Wache");
					lookAt(tutorial_tmp.bguard2,getLocation("locBehemoth"));
					
					-- ab Phase fightslugs
					if (tutorial.phasenr > 1) then
						tutorial_tmp.behemoth = createObject("tutorialBehemoth","locBehemoth");
					end;
				
				
					local door;
					
					door = getObjectByNameRef("doorBehemothNorth");
					scriptobjectvar[door]["locked"] = true;
					door = getObjectByNameRef("doorBehemothWest");
					scriptobjectvar[door]["locked"] = true;
					
					door = getObjectByNameRef("doorScene1");
					scriptobjectvar[door]["locked"] = true;
					
					door = getObjectByNameRef("doorScene1");
					scriptobjectvar[door]["locked"] = true;
					
					if (2 > tutorial.phasenr) then
						door_toggle("doorBehemothNorth");
						door_toggle("doorBehemothWest");
					end;
					
					if (3 > tutorial.phasenr) then
						door = getObjectByNameRef("slugFarmBackdoor");
						scriptobjectvar[door]["locked"] = true;
					end;
					
					if (tutorial.phasenr == 0) then
						door = getObjectByNameRef("doorPrison");
						scriptobjectvar[door]["locked"] = true;
					end;
					
					door = getObjectByNameRef("doorSlugFarm");
					scriptobjectvar[door]["locked"] = true;
					
					if (4 > tutorial.phasenr) then
						door = getObjectByNameRef("slugFarmFoodDoor");
						scriptobjectvar[door]["locked"] = true;
					end;
					
					if (4 == tutorial.phasenr) then
						createMonsterGroup("tutorialLouses","locLouses",6);
					end;
					
					tutorial_tmp.louses =0;
				end;
				
				door = getObjectByNameRef("doorSouth");
				scriptobjectvar[door]["locked"] = true;
				
				door = getObjectByNameRef("doorKitchen");
				scriptobjectvar[door]["locked"] = true;
				
				door = getObjectByNameRef("doorDepth");
				scriptobjectvar[door]["locked"] = true;
				
				door = getObjectByNameRef("doorEast");
				scriptobjectvar[door]["locked"] = true;
				
				door = getObjectByNameRef("doorWest");
					scriptobjectvar[door]["locked"] = true;
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (tutorial.phase == "intro") then
					return (unitIsInArea(trigger.player,"entryPlayerArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				assembleParty("elCnlLobby","locEntryPlayer","locDerred");
				tutorial_tmp.assemble = "intro";
			</Effect>
		</Event>
		<Event trigger="party_complete" once="true">
			<Condition>
				return (tutorial_tmp.assemble == "intro");
			</Condition>
			<Effect>
				tutorial_tmp.assemble = nil;
				groupObjectsArc(getPlayers(),"locEntryPlayer","locTolec");
				tutorial.started = true;
				createDialogue();
				addAllPlayersToDialog();
				addSpeaker(tutorial_tmp.tolec,"Tolec");
				addSpeaker(tutorial_tmp.derred,"Derred");
				
				local leader = getRolePlayer("leader");
				local blockedspeaker={};
				blockedspeaker[leader] = true;
				local solo = (getPlayers()[2] == nil);
				
				lookAtObject(tutorial_tmp.tolec,leader);
				lookAtObject(tutorial_tmp.derred,leader);
				playersLookAt(get(tutorial_tmp.tolec,"position"));
				
				addSpeaker(leader,"PL");
				speak("PL",_("*args*"));
				-- TODO: (aufrappeln)
				speak("PL",_("Bei Harads Knochen! Das war mindestens so schlimm wie die ersten Jahre in der Hölle! Wo bin ich hier?"));
				
				if (not solo) then
					speak("PL",_("Und wer sind die anderen müden Gestalten?"));
				end;
				
				local warrior = getRolePlayerNonPref("warrior",blockedspeaker);
				local mage = getRolePlayerNonPref("mage",blockedspeaker);
				local archer = getRolePlayerNonPref("archer",blockedspeaker);
				local priest = getRolePlayerNonPref("priest",blockedspeaker);
				
				addSpeaker(warrior,"warrior");
				addSpeaker(mage,"mage");
				addSpeaker(archer,"archer");
				addSpeaker(priest,"priest");
				
				if (warrior ~= leader) then
					speak("warrior",_("Suchst du Streit? Wer ist für diesen Schlammassel verantwortlich!?!"));
				end;
				-- TODO:  (blickt sich um)
				
				speak("warrior",_("Beinahe hätte ich den verdammten Oger gehabt und plötzlich reißt mir jemand die Eingeweide raus, der noch nicht mal in meiner Nähe steht!"));
				
				if (warrior ~=0 and mage ~= 0) then
					speak("mage",_("Ah ja! Die Wunder geistigen Kapazität von Knüppelschwingern."));
					speak("warrior",_("Ich zeig dir gleich die Ausdauerkapazitäten von Magiesprutzern!"));
				end;
				
				speak("mage",_("Welch abstoßendes Ambiente. Ich habe nicht darum gebeten, hier zu sein... ich hatte gerade einen so ansprechenden und sicheren Ort gefunden."));
				
				speak("Tolec",_("Entschuldigt..."));
				speak("Derred",_("Nein, du musst das viel bestimmter sagen."));
				
				if (priest ~= 0) then
					executeInDialog('lookAt('..priest..',getLocation("locEvilMachine"))');
				end;
				
				speak("priest",_("Es scheint, als besäße hier jemand größeres Wissen über die Art und Weise, wie Harad uns am Leben hält und bewegt."));
				speak("archer",_("Wer auch immer hier das Sagen hat: Er hat sich besser überlegt, worauf er sich einlässt. Viel Geld könnte mich wieder gnädig stimmen."));
				
				speak("Tolec",_("Bitte entschuldigt die etwas raue Ankunft. Lord Magister Soren Windklaue erbittet eure Audienz."))
				
				local magopt = getRolePlayerPref("all",mage);
				local waropt = getRolePlayerPref("all",warrior);
				local arcopt = getRolePlayerPref("all",archer);
				addSpeaker(magopt,"magopt");
				addSpeaker(waropt,"waropt");
				addSpeaker(arcopt,"arcopt");
				
				speak("magopt",_("Ach so!"));
				speak("magopt",_("Lord"));
				speak("magopt",_("Magister"));
				speak("magopt",_("Windklaue."));
				speak("magopt",_("Warum habt ihr das nicht gleich gesagt?"));
				speak("Derred",_("Nun, wenn Ihr uns bitte folgen würdet?"));
				if (not solo) then
					speak("waropt",_("Wollt ihr uns verarschen? Wer bitte schön ist denn dieser Windwichtel?"));
				else
					speak("PL",_("Wollt ihr mich verarschen? Wer bitte schön ist denn dieser Windwichtel?"));
				end;
				
				if (mage ~= waropt) then
					speak("mage",_("Eine brillante Frage. Kurz und Präzise. Vielleicht kann man doch mit ihm arbeiten."));
				end;
				
				speak("Derred",_("Ähm..."));
				if (priest ~= waropt) then
					speak("priest",_("Nur die Ruhe, mein Sohn. Nimm dir Zeit, über die Antwort nachzudenken. Es könnte deine Letzte sein."));
				end;
				
				executeInDialog("addUnitCommand("..leader..",'walk',tutorial_tmp.derred,3)");
				speak("PL",_("Raus damit. Wo sind wir und wer hat den Nerv, Gezeichnete gegen sich auf zu bringen?!"));
				speak("Tolec",_("Nun, der Lord Magister hat versichert, dass er Euch das alles genau erklären wird."));
				speak("Derred",_("Außerdem war Eure Ankunft... etwas beschwerlich. Ihr dürftet im Moment nicht einmal in der Lage sein, uns gefährlich zu werden."));
				speak("waropt",_("Was habt ihr getan ihr Bastarde?!"));
				speak("Tolec",_("Keine Angst, wir haben strikten Befehl, euch nicht zu töten."));
				
				speak("arcopt",_("Der Kerl scheint zu wissen, was er tut."));
				if (arcopt ~= leader) then
					speak("PL",_("Das ist nicht der richtige Zeitpunkt, um beeindruckt zu sein."));
				end;
				
				speak("Derred",_("Schön. Da das geklärt ist, möchte ich Euch bitten, mir eure Ausrüstung zu überlassen."));
				speak("Tolec",_("Freundlich bitten."));
				speak("Derred",_("Wir können kein Risiko eingehen und innerhalb der Konzils seid Ihr sicher."));
				speak("arcopt",_("Konzil? Das Konzil der Elementarbeschwörer?! Ist das hier Aisen?"));
				speak("Tolec",_("Ja, aber das tut jetzt nichts zur Sache!"));
				if ( not solo) then
					speak("PL",_("Was wenn wir gar keine Lust haben unsere Waffen ab zu geben?"));
				else
					speak("PL",_("Was wenn ich gar keine Lust habe meine Waffen ab zu geben?"));
				end;
				
				speak("Tolec",_("Es tut uns leid, wir können euch nicht vorher aus dem Sicherheitsbereich lassen."));
				speak("magopt",_("Sicherheitsbereich?! Das ist ein verdammtes Gefängnis!"));
				speak("Derred",_("Es ist eure Entscheidung"));
				
				setTopicBase("Derred");
				changeTopic("give_weapons");
			</Effect>	
		</Event>
	</Region>

	<NPC refname="Derred">
		<Topic name="give_weapons" start_option="Waffen abgeben">
			<Condition>
				return (tutorial.phase == "intro")
			</Condition>
			<Effect>
				addAllPlayersToDialog();
				addSpeaker(tutorial_tmp.tolec,"Tolec");
				addSpeaker(tutorial_tmp.derred,"Derred");
				
				addQuestion("Wollt ihr die Waffen abgeben?");
				addAnswer("Ja","give_weapons_yes");
				addAnswer("Nein","give_weapons_no");
			</Effect>
		</Topic>
		
		<Topic name="give_weapons_yes">
			<Effect>
				local warrior = getRolePlayer("warrior");
				local waropt = getRolePlayerPref("all",warrior);
				local solo = (getPlayers()[2] == nil);
				addSpeaker(waropt,"waropt");
				if (not solo) then
					speak("waropt",_("Wie es aussieht haben wir keine Wahl..."));
				else
					speak("waropt",_("Wie es aussieht habe ich keine Wahl..."));
				end;
				speak("Derred",_("Sehr Gut. Folgt mir bitte."));
				
				door_toggle("doorPrison")
				
				tutorial.phase="learnwalk"
				tutorial.phasenr =1;
				startTimer("start_learnwalk",3000);
			</Effect>
		</Topic>
		
		<Topic name="give_weapons_no">
			<Effect>
				speak("player",_("Vergesst es!"));
				speak("Tolec",_("Wir ihr es wünscht, aber dieser Raum ist sicher. Ihr werdet ihn nicht verlassen, wenn ihr nicht eure Waffen abgebt."));
				speak("Derred",_("Sagt einfach bescheid, wenn ihr es euch anders überlegt habt."));
			</Effect>
		</Topic>
		
	</NPC>
	
	
	<NPC refname="Tolec">
		<Topic name="give_weapons" start_option="Waffen abgeben">
			<Condition>
				return (tutorial.phase == "intro")
			</Condition>
			<Effect>
				speak("Tolec",_("Meldet euch bei Derred, falls Ihr es euch anders überlegt habt."));
			</Effect>
		</Topic>	
	</NPC>
	
	<Region name="elCnlLobby">
	
		<Event trigger="player_moved" once="true">
			<Condition>
				if (tutorial.phase == "learnwalk" and tutorial_tmp.learnwalkstarted ~= true) then
					return (unitIsInArea(trigger.player,"entryPlayerArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				insertTrigger("start_learnwalk");
				unitSpeak(tutorial_tmp.derred,_("Folgt mir bitte."));
			</Effect>	
		</Event>
		
		<Event trigger="start_learnwalk" once="true">
			<Effect>
				addUnitCommand(tutorial_tmp.tolec,"walk","locWay1",1);
				addUnitCommand(tutorial_tmp.derred,"walk","locWay1",1);
				tutorial_tmp.learnwalkstarted = true;
				tutorial_tmp.tolecway1 = true;
			</Effect>	
		</Event>
		
		<Event trigger="command_complete">
			<Condition>
				return (trigger.unit == tutorial_tmp.tolec 
				and tutorial.phase == "learnwalk"
				and tutorial_tmp.tolecway1 == true);
			</Condition>	
			<Effect>
				startTimer("check_walk_success",15000);
			</Effect>	
		</Event>
		
		<Event trigger="check_walk_success">
			<Condition>
				return (tutorial_tmp.walk_success ~= true);
			</Condition>
			<Effect>
				tutorial_tmp.tolecway1 = false;
				addUnitCommand(tutorial_tmp.tolec,"walk","locDerred");
			</Effect>	
		</Event>
		
		<Event trigger="command_complete">
			<Condition>
				return (trigger.unit == tutorial_tmp.tolec 
				and tutorial.phase == "learnwalk"
				and tutorial_tmp.tolecway1 == false);
			</Condition>	
			<Effect>
				unitSpeak(tutorial_tmp.tolec,_("Wo bleibt Ihr denn? Hat Euch der Transport so sehr zugesetzt, dass ihr nicht mal mehr wisst, wie man sich bewegt? Klickt einfach mit der linken Maustaste auf eine Stelle auf dem Boden, dann kommt das alles von ganz allein wieder."));
				startTimer("tolec_back_way1",2000);
			</Effect>
		</Event>
		
		<Event trigger="tolec_back_way1">
			<Effect>
				tutorial_tmp.tolecway1 = true;
				addUnitCommand(tutorial_tmp.tolec,"walk","locWay1");
			</Effect>	
		</Event>
		
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (tutorial.phase == "learnwalk") then
					return (unitIsInArea(trigger.player,"waypoint1Area"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				tutorial_tmp.walk_success = true;
				if (tutorial_tmp.tolecway1 == false) then
					clearUnitCommands(tutorial_tmp.tolec);
					addUnitCommand(tutorial_tmp.tolec,"walk","locWay1");
				end;
				addUnitCommand(tutorial_tmp.tolec,"walk","locWay2");
				addUnitCommand(tutorial_tmp.derred,"walk","locWay2");
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (tutorial.phase == "learnwalk") then
					return (unitIsInArea(trigger.player,"waypoint2Area"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				insertTrigger("behemoth_start");
			</Effect>
		</Event>
		
		
		<Event trigger="behemoth_start" once="true">
			<Effect>
				setCutsceneMode(true);
				tutorial_tmp.behemoth = createObject("tutorialBehemoth","locBehemothStart");
				lookAt(tutorial_tmp.behemoth,getLocation("locDestroyedWall"));
				
				tutorial_tmp.worker = createObject("council_guard","locWorker");
				setRefName(tutorial_tmp.worker, "Arbeiter");
				
				tutorial_tmp.worker2 = createObject("council_guard","locWorker2");
				setRefName(tutorial_tmp.worker2, "Arbeiter");
				
				addCameraPosition(0,"locBehemothStart" , 90,20, 30);
				startTimer("behemoth_attack1",2000);
				
				tutorial_tmp.destroyed_wall = createObject("konz_wall1","locDestroyedWall",90)
			</Effect>
		</Event>
		
		<Event trigger="behemoth_attack1" once="true">
			<Effect>
				-- TODO: Explosionen
				addUnitCommand(tutorial_tmp.behemoth,"behemoth_fire_storm","locDestroyedWall");
			</Effect>
		</Event>
		
		<Event trigger="unit_hit" once="true">
			<Condition>
				return (trigger.defender == tutorial_tmp.worker);
			</Condition>
			<Effect>
				deleteObject(tutorial_tmp.destroyed_wall)
				unitSpeak(tutorial_tmp.worker,_("*Argh!!!*"));
				set(tutorial_tmp.worker,"health",0);
				
				addUnitCommand(tutorial_tmp.behemoth,"hammer_bash",tutorial_tmp.worker2);
				addUnitCommand(tutorial_tmp.behemoth,"walk","locBehemoth");
			</Effect>
		</Event>
		
		<Event trigger="unit_hit" once="true">
			<Condition>
				return (trigger.defender == tutorial_tmp.worker2);
			</Condition>	
			<Effect>
				set(tutorial_tmp.worker2,"health",0);
				startTimer("closeBehemothDoor1",2000);
			</Effect>	
		</Event>
		
		<Event trigger="closeBehemothDoor1" once="true">
			<Effect>
				addCameraPosition(500, "locDoorGuardWest" , 0,30, 20);
				unitSpeak(tutorial_tmp.bguard2,_("Bei Marek! Verschließt die Tore!!!"));
				timedExecute("door_toggle('doorBehemothWest')",1500);
				startTimer("closeBehemothDoor2",3000);
			</Effect>
		</Event>
		
		<Event trigger="closeBehemothDoor2" once="true">
			<Effect>
				addCameraPosition(500, "locDoorGuardNorth" , 90,30, 20);
				timedExecute("door_toggle('doorBehemothNorth')",1500);
				startTimer("explain_fight",3000);
			</Effect>
		</Event>
		
		<Event trigger="explain_fight" once="true">
			<Effect>
				setCutsceneMode(false);
				assembleParty("elCnlLobby","locWaypoint2");
				tutorial_tmp.assemble = "explain_fight";
				</Effect>
		</Event>
		<Event trigger="party_complete" once="true">
			<Condition>
				return (tutorial_tmp.assemble == "explain_fight");
			</Condition>
			<Effect>
				tutorial_tmp.assemble = nil;
				groupObjectsArc(getPlayers(),"locBehemothView","locWaypoint2");
				moveObject(tutorial_tmp.tolec,"locWaypoint2");
				moveObject(tutorial_tmp.derred, "locWaypoint2");
				
				createDialogue();
				addAllPlayersToDialog();
				addSpeaker(tutorial_tmp.tolec,"Tolec");
				addSpeaker(tutorial_tmp.derred,"Derred");
				
				local solo = (getPlayers()[2] == nil);
				addStandardRoles();
				
				local leader = getSpeaker("PL");
				local waropt = getSpeaker("waropt");
				local mage = getSpeaker("mage");
				
				lookAtObject(tutorial_tmp.tolec,leader);
				lookAtObject(tutorial_tmp.derred,leader);
				playersLookAt(get(tutorial_tmp.tolec,"position"));
				
				speak("Tolec",_("Mareks Schild! Das DING ist frei! Alle zurück! Los, los, los!"));
				speak("Derred",_("Da kommen wir nicht vorbei. Was machen wir jetzt?"));
				speak("PL",_("Ist das Ding da echt so schlimm?"));
				speak("Derred",_("Habt ihr keine Augen im Kopf? Das Teil ist riesig!"));
				speak("waropt",_("Größe ist nicht alles."));
				speak("arcopt",_("Sieht für mich aus wie die Fahrkarte nach draußen. Kann nicht schmerzhafter sein als die Ankunft."));
				speak("Tolec",_("Äh ja... deswegen..."));
				speak("priopt",_("Was?"));
				speak("Tolec",_("Der Lord Magister Windklaue befürchtete, Ihr könntet Euch nach eurem Eintreffen selbst entleiben, um wieder zu verschwinden, deswegen hat er... Maßnahmen getroffen"));
				
				executeInDialog("addUnitCommand("..waropt..",'walk',tutorial_tmp.tolec)");
				speak("waropt",_("Maßnahmen?"));
				speak("Derred",_("Nun, wir verstehen nicht viel davon, aber anscheinend sterbt Ihr nicht, sondern könnt einfach, wo Ihr wollt wiederauferstehen, nachdem euer Körper zerstört wurde."));
				if (not solo) then
					speak("priopt",_("Und? Niemand von uns hat um diese Fähigkeit gebeten."));
				else
					speak("priopt",_("Und? Ich habe nicht um diese Fähigkeit gebeten."));
				end;
				
				speak("Derred",_("Nun, in eurem jetzigen Zustand könnt ihr das nur an Orten großer magischer Konzentration, die ihr bereits besucht habt. Mit anderen Worten..."));
				speak("waropt",_("...nur dahinten bei dem ganzen Krempel."));
				if (mage ~= waropt and waropt ~= 0) then
					speak("mage",_("Krempel würde ich das nicht unbedingt nennen."))
				end;
				
				speak("Tolec",_("Genau, nur an dieser Stelle."));
				if (not solo) then
					speak("PL",_("Es wird Zeit, dass wir mit diesem Windklaue reden. Scheint ja ein gewitztes Kerlchen zu sein."));
				else
					speak("PL",_("Es wird Zeit, dass ich mit diesem Windklaue rede. Scheint ja ein gewitztes Kerlchen zu sein."));
				end;
				speak("arcopt",_("Ist sicher nicht allzu gesund so gewitzt zu sein."));
				speak("Derred",_("Äh, ja, gut. Da der Weg nach vorne momentan versperrt ist, müssen wir wohl versuchen, durch das Gehege mit den neuen Experimenten zu kommen."))
				speak("Derred",_("Es gibt da eine Hintertür für die Fütterung und angeblich..."));
				speak("Tolec",_("...hat sich der alte Feuerwirbel eine Geheimtür als Direktverbindung zur Küche eingebaut. Das könnte klappen! Aber die Viecher sind nicht ungefährlich."));
				speak("Derred",_("Das sind doch nur diese Schnecklinge."));
				speak("Tolec",_("Na, ich weiß ja nicht... ich hab keine Lust, nur wegen so einem schleimigen Feueratem drei Wochen das Bett zu hüten."));
				
				if (not solo) then
					speak("priopt", _("Bei Harad! Das kann man sich ja unmöglich antun. Gebt uns unsere Waffen und wir kümmern uns darum."));
				else
					speak("priopt", _("Bei Harad! Das kann man sich ja unmöglich antun. Gib mir meine  Waffe und ich kümmere mich darum."));
				end;
				speak("Derred",_("Nun, da habt Ihr nicht unrecht..."));
				speak("Tolec",_("Ja, in Anbetracht der schwierigen Umstände können wir das wohl machen. Hier bittesehr."));
				
				speak("warrior",_("Was soll das denn sein? Wo ist meine Waffe?"));
				speak("Tolec",_("Ähm... Lord Magister Windklaue befürchtete, dass es zu einer Situation kommen könnte, in der ihr auf, äh, Waffengewalt zurückgreifen müsst. Deswegen hat er uns diese hier mitgegeben."));
				speak("Derred",_("Ihr versteht sicherlich, dass ihr hier nicht mit ungeprüften Waffen umherlaufen könnt."));
				
				speak("waropt",_("Langsam fangt ihr an zu nerven."));
				speak("arcopt",_("Woran hat der eigentlich nicht gedacht? Der ist doch eindeutig paranoid."));
				-- TODO: Waffen ins Inventar legen
				-- noch nicht anlegen !
				speak("Derred",_("Ihr... könnt euch noch erinnern, wie man eine Waffe benutzt richtig? Uns wurde gesagt, dass die ersten Minuten sind, als träte man zum ersten Mal in die Welt."));
				
				tutorial.phase = "fightslugs";
				tutorial.phasenr = 2;
				
				setTopicBase("Derred");
				addQuestion(_("Inventar erklären?"));
				addAnswer("Ja","explain_inventory");
				addAnswer("Nein","explain_inv_no");
			</Effect>
		</Event>
	</Region>
	
	<NPC refname="Derred">
		<Topic name="explain_inventory" start_option="Inventar erklären">
			<Condition>
				return (tutorial.phase == "fightslugs" and tutorial_tmp.slugdoor_open ~= true)
			</Condition>
			<Effect>
				speak("Derred",_("Zuerst müsst Ihr euer Inventar öffnen. Dies tut ihr standardmäßig mit der 'i'-Taste."));
				speak("Derred",_("Alternativ könnt ihr auch auf den Inventarknopf unten in der Statusleiste drücken."));
				speak("Derred",_("Im Inventar seht ihr dann Eure Gegenstände. Sie sind unterteilt nach ihrer Größe."));
				speak("Derred",_("Die Waffe, die Ihr gerade 	erhalten habt ist ein mittelgroßer Gegenstand und befindet sich deshalb im mittleren Feld"));
				speak("Derred",_("Klickt die Waffe mit der linken Maustaste an und klickt danach auf das Waffenfeld in Eurer Ausrüstung über dem Inventar. Und schon habt ihr sie angelegt."));
				changeTopic("explain_inv_no");
			</Effect>
		</Topic>
		<Topic name="explain_inv_no">
			<Effect>
				speak("Derred",_("Sprecht mit Tolec sobald ihr bereit seid"));
			</Effect>
		</Topic>
	</NPC>
	
	<NPC refname="Tolec">
		<Topic name="attack_slugs" start_option="Schnecken angreifen">
			<Condition>
				return (tutorial.phase == "fightslugs" and tutorial_tmp.slugdoor_open ~= true)
			</Condition>
			<Effect>
				addSpeaker(tutorial_tmp.derred,"Derred");
				addStandardRoles();
				addAllPlayersToDialog();
				local solo = (getPlayers()[2] == nil);
				
				speak("Tolec",_("Aber wir ihr kämpft wisst ihr doch noch, oder?"));
				speak("PL",_("Reingehen, anklicken, töten. Das vergisst man niemals als Gezeichneter."));
				speak("Derred",_("Anklicken?"));
				speak("Tolec",_("Keine Ahnung, der Lord Magister hat gesagt, die verstehen das schon."));
				speak("waropt",_("Lasst uns diese Experimente das Fürchten lehren!"));
				speak("arcopt",_("Ich hoffe, die haben auch eine Seele."))
				if (getSpeaker("priopt") ~= getSpeaker("arcopt")) then
					speak("priopt",_("Keine Sorge. Selbst ein Golem hat eine. Da werden die Dinger keine Ausnahme sein."));
				end;
				speak("Tolec",_("Sehr gut, haltet uns einfach diese Dinger vom Hals, während wir versuchen die Luke zu  öffnen."));
				speak("Derred",_("Ich geh da nicht rein, wenn die Viecher noch auf freiem Fuß sind!"));
				
				executeInDialog("startTimer('open_slugdoor',1500)");
				local door = getObjectByNameRef("slugFarmBackdoor");
				executeInDialog("addUnitCommand(tutorial_tmp.tolec,'walk',"..door..",2)");
				tutorial_tmp.slug_door_pos = get(door,"position");
			</Effect>
		</Topic>
	</NPC>
	
	<Region name="elCnlLobby">
		<Event trigger="open_slugdoor" once="true">
			<Effect>
				door_toggle("slugFarmBackdoor");
				clearUnitCommands(tutorial_tmp.tolec);
				tutorial_tmp.slugdoor_open = true;
			</Effect>
		</Event>
		
		<Event trigger="unit_dead">
			<Condition>
				return (tutorial.phase == "fightslugs" and get(trigger.unit,"subtype") == "fireSlug")
			</Condition>
			<Effect>
				tutorial_tmp.slugs = tutorial_tmp.slugs +1;
				if (tutorial_tmp.slugs == 10) then
					addUnitCommand(tutorial_tmp.tolec,'walk',tutorial_tmp.slug_door_pos,1);
					addUnitCommand(tutorial_tmp.derred,'walk',tutorial_tmp.slug_door_pos,1);
					addUnitCommand(tutorial_tmp.tolec,'walk',"locSlugView",2);
					addUnitCommand(tutorial_tmp.derred,'walk',"locSlugView",2);
				end
			</Effect>
		</Event>
		
		<Event trigger="command_complete" once="true">
			<Condition>
				return (tutorial.phase == "fightslugs" and tutorial_tmp.slugs == 10 and trigger.unit == tutorial_tmp.tolec and trigger.last_command)
			</Condition>
			<Effect>
				assembleParty("elCnlLobby","locSlugs");
				tutorial_tmp.assemble = "fightslugs";
				</Effect>
		</Event>
		<Event trigger="party_complete" once="true">
			<Condition>
				return (tutorial_tmp.assemble == "fightslugs");
			</Condition>
			<Effect>
				tutorial_tmp.assemble = nil;
				groupObjectsArc(getPlayers(),"locSlugs","locSlugView");
				moveObject(tutorial_tmp.tolec,"locSlugView");
				moveObject(tutorial_tmp.derred, "locSlugView");
				
				createDialogue();
				addSpeaker(tutorial_tmp.derred,"Derred");
				addSpeaker(tutorial_tmp.tolec,"Tolec");
				addStandardRoles();
				addAllPlayersToDialog();
				
				local leader = getRolePlayer("leader");
				lookAtObject(tutorial_tmp.tolec,leader);
				lookAtObject(tutorial_tmp.derred,leader);
				playersLookAt(get(tutorial_tmp.tolec,"position"));
				
				speak("Derred",_("Ihh, die Dinger sind echt widerlich"));
				speak("any",_("Was seid ihr denn für Mimosen?"));
				speak("Derred",_("Suchst du streit, du Schwächling?!"));
				speak("Tolec",_("Warte mal, irgendwie sind sie stärker geworden."));
				speak("leader",_("Euer Hexenkram mag uns ja geschwächt haben, aber mit jeden getöteten Wesen nehmen wir einen Teil seiner Kraft auf und werden stärker."));
				speak("any",_("Überleg dir also lieber, wen du hier Schwächling nennst!"));
				speak("Tolec",_("Hm, stimmt der Lord Magister hat gesagt, das so etwas passieren kann. Wisst ihr auch, wie ihr diese Kraft in vernünftige Fähigkeiten umwandelt?"));
				
				tutorial_tmp.behemoth_show = true;
				tutorial.phase = "findSecretDoor";
				tutorial.phasenr = 3;
				
				setTopicBase("Tolec");
				addQuestion("Levelup erklären?");
				addAnswer("Ja","explain_levelup");
				addAnswer("Nein","explain_levelup_continue");
				
			</Effect>
		</Event>
	</Region>
	
	<NPC refname="Tolec">
		<Topic name="explain_levelup" start_option="Levelup erklären">
			<Condition>
				return (tutorial.phase == "findSecretDoor" and tutorial_tmp.fooddoor_open ~= true)
			</Condition>
			<Effect>
				addSpeaker(tutorial_tmp.derred,"Derred");
				if (getSpeaker("priopt") == 0) then
					addSpeaker(getSpeaker("player"),"priopt");
				end;
				speak("Tolec",_("Ihr könnt jedes Mal eure Attribute verbessern und von Zeit zu Zeit habt ihr sogar genug Energie für eine neue Fähigkeit."));
				speak("Derred",_("Ja genau, das war doch das, mit dem großen Plus in der linken unteren Ecke. Klickt einfach darauf und verteilt dann im Attributfenster oben eure Attribut Punkte."));
				speak("Tolec",_("Genau, und den Fähigkeitenpunkt könnt ihr im Fähigkeitenfenster verteilen. Der Lord Magister hat gesagt, dass ihr die aus drei verschiedenen Kategorien wählen könnt."));
				speak("Derred",_("In Abhängigkeit von eurer... Charaktermasse"));
				speak("Tolec",_("Charakterklasse."));
				speak("Derred",_("Oh, genau!"));
				
				speak("priopt",_("Ich frage mich, woher dieser Soren so viel über die Gefallenen weiß..."));
				speak("warrior",_("Magier sind äußerst merkwürdig. Alle."));
				if (getSpeaker("warrior") ~= 0) then
					speak("mage",_("Besser merkwürdig als..."));
				end;
				if (tutorial_tmp.behemoth_show) then
					changeTopic("explain_levelup_continue");
				end;
			</Effect>
		</Topic>
		<Topic name="explain_levelup_continue" >
			<Effect>
				insertTrigger("behemoth_show2");
			</Effect>
		</Topic>	
	</NPC>
	
	<Region name="elCnlLobby">
		<Event trigger="behemoth_show2" once="true">
			<Effect>
				startTimer("behemoth_show_end",6000);
				setCutsceneMode(true);
				local pos = getLocation("locBehemoth");
				addCameraPosition(0,"locBehemoth" , 90,20, 20);
				addCameraPosition(1000,"locBehemoth" , 90,20, 20);
				local i
				for i=1,50 do
					addCameraPosition(100,{pos[1] + math.random(11)-6,pos[2]+ math.random(11)-6} , 90,20, 20);
				end;
				addCameraPosition(0,"locBehemoth" , 90,20, 20);
				
			</Effect>
		</Event>
		<Event trigger="behemoth_show_end" once="true">
			<Effect>
				setCutsceneMode(false);
				createDialogue();
				addAllPlayersToDialog();
				addSpeaker(tutorial_tmp.tolec,"Tolec");
				addSpeaker(tutorial_tmp.derred,"Derred");
				
				speak("Tolec",_("Dieses Verdammte Ding. Ich hoffe die Wände halten."))
				speak("Derred",_("Verteilt schnell euren neuen Punkte und dann nichts wie weg von hier."));
			</Effect>
		</Event>
		
	</Region>
	
	<NPC refname="Derred">
		<Topic name="open_fooddoor" start_option="Futterklappe öffnen">
			<Condition>
				return (tutorial.phase == "findSecretDoor" and tutorial_tmp.fooddoor_open ~= true)
			</Condition>
			<Effect>
				local door = getObjectByNameRef("slugFarmFoodDoor");
				addUnitCommand(tutorial_tmp.derred,"walk",door,2);
				tutorial_tmp.backroute =1;
			</Effect>
		</Topic>
	</NPC>
	
	<Region name="elCnlLobby">
		<Event trigger="command_complete" once="true">
			<Condition>
				return (trigger.unit == tutorial_tmp.derred and tutorial_tmp.backroute ==1 and tutorial_tmp.fooddoor_open ~= true)
			</Condition>
			<Effect>
				timedExecute("door_toggle('slugFarmFoodDoor')",1000);
				startTimer("go_backroute2",2000);
				tutorial_tmp.fooddoor_open = true;
			</Effect>
		</Event>
		<Event trigger="go_backroute2" once="true">
			<Effect>
				addUnitCommand(tutorial_tmp.derred,"walk","locBackroute2");
				addUnitCommand(tutorial_tmp.tolec,"walk","locBackroute1");
				addUnitCommand(tutorial_tmp.tolec,"walk","locBackroute2",1);
				tutorial_tmp.see_louse = false;
			</Effect>
		</Event>
		<Event trigger="player_moved" once="true">
			<Condition>
				if (tutorial_tmp.see_louse == false) then
					return (unitIsInArea(trigger.player,"dangerArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				createMonsterGroup("tutorialMutantSlugs","locBackroute3",3);
				tutorial_tmp.slugs = getObjectsInArea("mutantSlugsArea","normal","monster");
				tutorial_tmp.slugnr = table.getn(tutorial_tmp.slugs);
				
				setCutsceneMode(true);				
				addCameraPosition(0,"locDanger" , -90,40, 20);
				addCameraPosition(1000,"locBackroute3" , -90,40, 20);
				startTimer("slugs2_scene",4000);
				
			</Effect>
		</Event>
		<Event trigger="slugs2_scene" once="true">
			<Effect>
				tutorial_tmp.slugs_out =0;
				local i
				for i=1,tutorial_tmp.slugnr do
					addUnitCommand(tutorial_tmp.slugs[i],"walk","locMutantSlugs");
				end;
			</Effect>
		</Event>
		
		<Event trigger="command_complete" >
			<Condition>
				return (get(trigger.unit,"subtype") == "fireSlug" or get(trigger.unit,"subtype") == "mutantSlug")
			</Condition>	
			<Effect>
				tutorial_tmp.slugs_out = tutorial_tmp.slugs_out +1;
				deleteObject(trigger.unit);
				if (tutorial_tmp.slugs_out == tutorial_tmp.slugnr) then
					addCameraPosition(300,"locBackroute3" , -90,40, 20);
					addCameraPosition(2000,"locBackroute3" , -90,40, 20);
					addCameraPosition(1000,"locDanger" , -90,40, 20);
					startTimer("slugs2_dialog",4000);
				end;
			</Effect>
		</Event>
		<Event trigger="slugs2_dialog" >
			<Effect>
				createDialogue();
				setCutsceneMode(false);
				addAllPlayersToDialog();
				addStandardRoles();
				addSpeaker(tutorial_tmp.tolec,"Tolec");
				addSpeaker(tutorial_tmp.derred,"Derred");
				
				speak("PL",_("Noch mehr von den Viechern?"));
				speak("Tolec",_("Uäks! Die scheinen irgendwie ausgebrochen zu sein. Hoffentlich vermehren die sich nicht in den Felsspalten."));
				speak("mage",_("Habt ihr schon mal was von Sicherheitsvorkehrungen gehört?"));
				speak("Derred",_("Da Hinten muss irgendwo die Geheimtür sein."));
				speak("arcopt",_("Ihr wisst gar nicht sicher, ob sie da ist?"));
				
				executeInDialog("insertTrigger('walk_backroute3')");
			</Effect>
		</Event>
		
		<Event trigger="walk_backroute3" >
			<Effect>
				addUnitCommand(tutorial_tmp.derred,"walk","locBackroute3",1);
				addUnitCommand(tutorial_tmp.tolec,"walk","locBackroute3",1);
			</Effect>
		</Event>
		
		<Event trigger="object_use" once="true">
			<Condition>
				return (tutorial.phase == "findSecretDoor" and trigger.used_object == getObjectByNameRef("doorSecretLibrary"))
			</Condition>	
			<Effect>
				addUnitCommand(tutorial_tmp.derred,"walk","locBackroute4",1);
				addUnitCommand(tutorial_tmp.tolec,"walk","locBackroute4",1);
				addUnitCommand(tutorial_tmp.derred,"walk","locBackroute5",1);
				addUnitCommand(tutorial_tmp.tolec,"walk","locBackroute5",1);
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (tutorial.phase == "findSecretDoor") then
					return (unitIsInArea(trigger.player,"seeLouseArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				setCutsceneMode(true);
				local door = getObjectByNameRef("doorBehemothNorth");
				addCameraPosition(0,get(door,"position") , 45,40, 25);
				
				addUnitCommand(tutorial_tmp.behemoth,"attack",door);
				tutorial_tmp.behemoth_door_attack = true;
			</Effect>
		</Event>
		
		<Event trigger="command_complete" once="true">
			<Condition>
				return (trigger.unit == tutorial_tmp.behemoth 
				and tutorial_tmp.behemoth_door_attack == true);
			</Condition>	
			<Effect>
				tutorial_tmp.behemoth_door_attack = false;
				local door = getObjectByNameRef("doorBehemothNorth");
				deleteObject(door);
				addUnitCommand(tutorial_tmp.bguard1,"walk","locLouses");
				addUnitCommand(tutorial_tmp.behemoth,"fire_ball",tutorial_tmp.bguard1);
			</Effect>	
		</Event>
		<Event trigger="unit_dead" once="true">
			<Condition>
				return (trigger.unit== tutorial_tmp.bguard1)
			</Condition>
			<Effect>
				local pos = get(tutorial_tmp.behemoth,"position");
				tutorial_tmp.lousepos = { pos[1],pos[2]-2 };
				tutorial_tmp.louse={};
				tutorial_tmp.louse_count =0;
				insertTrigger("create_louse");
			</Effect>	
		</Event>
		
		<Event trigger="create_louse">
			<Effect>
				if (tutorial_tmp.louse_count ~= 4) then
					tutorial_tmp.louse_count = tutorial_tmp.louse_count +1;
					tutorial_tmp.louse[tutorial_tmp.louse_count] = createObject("fireLouse",tutorial_tmp.lousepos);
					addUnitCommand(tutorial_tmp.louse[tutorial_tmp.louse_count], "walk","locLouses",2);
					startTimer("create_louse",2000);
				else
					startTimer("louse_dialogue",2000);
				end;
			</Effect>	
		</Event>
		
		<Event trigger="louse_dialogue"  once="true">
			<Effect>
				assembleParty("elCnlLobby","locEntryPlayer","locPartyLib");
				tutorial_tmp.assemble = "louses";
			</Effect>	
		</Event>
		
		<Event trigger="party_complete" once="true">
			<Condition>
				return (tutorial_tmp.assemble == "louses");
			</Condition>
			<Effect>
				setCutsceneMode(false);
				tutorial_tmp.assemble = nil;
				moveObject(tutorial_tmp.tolec,"locBackroute5");
				moveObject(tutorial_tmp.derred, "locBackroute5");
				groupObjectsArc(getPlayers(),"locPartyLib","locBackroute5");
				createDialogue();
				addAllPlayersToDialog();
				addSpeaker(tutorial_tmp.tolec,"Tolec");
				addSpeaker(tutorial_tmp.derred,"Derred");
				
				local solo = (getPlayers()[2] == nil);
				addStandardRoles();
				
				local leader = getSpeaker("PL");
				
				lookAtObject(tutorial_tmp.tolec,leader);
				lookAtObject(tutorial_tmp.derred,leader);
				playersLookAt(get(tutorial_tmp.tolec,"position"));
				
				speak("Derred",_("Das Biest erzeugt neue Monster!"));
				speak("Tolec",_("Die sind sicher gefährlich."));
				speak("Derred",_("Ich schlage vor, Ihr kümmert euch darum."));
				speak("Derred",_("Mit Hilfe eurer neuen Fähigkeit sollte das kein Problem darstellen."));
			
				tutorial.phase = "killlouses";
				tutorial.phasenr = 4;
				
				setTopicBase("Derred");
				addQuestion(_("Fähigkeiten erklären?"));
				addAnswer("Ja","explain_skills");
				addAnswer("Nein","end");
			</Effect>	
		</Event>
	</Region>
	
	
	<NPC refname="Tolec">
		<Topic name="open_lousedoor" start_option="Tür öffnen">
			<Condition>
				return (tutorial.phase == "killlouses")
			</Condition>
			<Effect>
				speak("Tolec",_("Geht ruhig vor und öffnet die Tür selbst."));
			</Effect>
		</Topic>
	</NPC>
	
	<NPC refname="Derred">
		<Topic name="explain_skills" start_option="Fähigkeiten erklären">
			<Condition>
				return (tutorial.phase == "killlouses")
			</Condition>
			<Effect>
				speak("Derred",_("Mit der Taste 't' öffnet Ihr das Fähigkeitenfenster. Hier könnt Ihr eine Fähigkeit auswählen."));
				speak("Derred",_("Klickt einfach mit der Maustaste, mit der Ihr die Fähigkeit später einsetzen wollt, auf das Fähigkeitenbild."));
				speak("Derred",_("Die Fähigkeiten sind in zwei Gruppen unterteilt."));
				speak("Derred",_("Nachdem Ihr eine Fähigkeit eingesetzt habt, könnt Ihr alle Fähigkeiten dieser Gruppe für eine Weile nicht verwenden."));
				speak("Derred",_("Schaut auf das Bild in der unteren Leiste um zu erfahren, ob eine Fähigkeit einsatzbereit ist."));
			</Effect>
		</Topic>
	</NPC>
	
	<Region name="elCnlLobby">
	
		<Event trigger="unit_dead">
			<Condition>
				return (tutorial.phase == "killlouses" and get(trigger.unit,"subtype") == "fireLouse")
			</Condition>
			<Effect>
				tutorial_tmp.louses = tutorial_tmp.louses +1;
				if (tutorial_tmp.louses == 4) then
					addUnitCommand(tutorial_tmp.derred,"walk","locBackroute6",4);
					addUnitCommand(tutorial_tmp.tolec,"walk","locBackroute6",4);
					tutorial_tmp.door = getObjectByNameRef("doorScene1");
					addUnitCommand(tutorial_tmp.derred,"walk",tutorial_tmp.door,1);
					addUnitCommand(tutorial_tmp.tolec,"walk",tutorial_tmp.door,1);
					
					tutorial.finished = true;
				end;
			</Effect>
		</Event>
		
		
		<!--
		<Event trigger="player_moved" once="true">
			<Condition>
				if (tutorial_tmp.can_find_door == true) then
					return (unitIsInArea(trigger.player,"locDoorArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				deleteObject(tutorial_tmp.libraryDoor);
				addUnitCommand(tutorial_tmp.tolec,"walk","locBackroute3");
				addUnitCommand(tutorial_tmp.derred,"walk","locBackroute3");
				tutorial_tmp.path=1;
				tutorial_tmp.path_active = true;
				tutorial_tmp.path_points={"locBackroute3", "locBackroute4", "locBackroute5", "locBackroute6", "locWay3","locWay4","locWay5","locWay6","locWay7","locWay8","locWay9"};
			</Effect>
		</Event>
		
		<Event trigger="command_complete">
			<Condition>
				return (trigger.unit == tutorial_tmp.tolec and tutorial_tmp.path_active == true);
			</Condition>
			<Effect>
				tutorial_tmp.path = tutorial_tmp.path +1;
				local newpoint = tutorial_tmp.path_points[tutorial_tmp.path]
				if (newpoint ~= nil) then
					addUnitCommand(tutorial_tmp.tolec,"walk",newpoint);
					addUnitCommand(tutorial_tmp.derred,"walk",newpoint);
					local players = getPlayers();
					local id, pl;
					for i,pl in ipairs(players) do
						addUnitCommand(pl,"walk",newpoint);
					end;
				end
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Effect>
				insertTrigger("behemoth_start");
			</Effect>
		</Event>
		-->
		<!--
		<Event trigger="command_complete">
			<Effect>
				print("command "..trigger.command.." complete by "..trigger.unit.." last "..tostring(trigger.last_command));
			</Effect>
		</Event>
		-->
	</Region>
</Quest>
	