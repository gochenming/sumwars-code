<Quest name="Maylons Grave" table_name="maylons_grave">
	
	<Init>
		local a = 2
	</Init>
	
	<Description>
		if (maylons_grave.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	
	<NPC refname="Gab Resh">
		<Topic name="talk_with_goblins">
			<Effect>
				speak("G1",_("Rakthr mootrick!"));
				speak("G2",_("Mar! Nom Togubri!"));
				speak("Gab Resh",_("Wait big warriorhumans. No kill!"));
				addQuestion(_("Kill Goblins?"));
				addAnswer(_("Yes"),"kill_goblins_immediately");
				addAnswer(_("No"),"keep_on_talking");
			</Effect>
		</Topic>
		
		<Topic name="keep_on_talking" >
			<Effect>
				speak("PL",_("A goblin that want's to talk?"));
				speak("GabResh",_("Yes. No hit, no kill!"));
				speak("GabResh",_("Gab'Resh and friends only harmless rustlers."));
				speak("GabResh",_("No bandits."));
				speak("GabResh",_("Will listen, yes?"));
				addQuestion(_("Listen?"));
				addAnswer(_("Yes"),"start_quest");
				addAnswer(_("Let Goblins go"),"let_goblins_go");
				addAnswer(_("Kill them"),"kill_goblins");
			</Effect>	
		</Topic>
		
		<Topic name="kill_goblins_immediately" >
			<Effect>
				speak("PL",_("Wretched Brood! Slay them!"));
				set(maylons_grave_tmp.Goblin1,"fraction","monster");
				set(maylons_grave_tmp.Goblin2,"fraction","monster");
				set(maylons_grave_tmp.Goblin3,"fraction","monster");
				set(maylons_grave_tmp.Goblin4,"fraction","monster");
				set(maylons_grave_tmp.GabResh,"fraction","monster");
			</Effect>	
		</Topic>
		
		<Topic name="start_quest" >
			<Effect>
				maylons_grave.started = true;
				addStandardSpeakers();
				speak("MAG",_("What could a goblin have to say?"));
				speak("Gab Resh",_("We often hide here."));
				speak("Gab Resh",_("Few humans come, and if they do, never return from deep cave."));
				speak("Gab Resh",_("But last moon black human come."));
				speak("Gab Resh",_("Now dread of the deepth also wandering up. "));
				speak("Gab Resh",_("Chasing poor goblin were never stole nothing not."));
				speak("PRI",_("Sounds allmost as if a necromancer passed by."));
				speak("PRI",_("We can't let be such a problem in an undefended region like this."));
				speak("PRI",_("Who knows what could happen."));				
				speak("Gab Resh",_("Good warning, no?"));
				speak("Gab Resh",_("Mighty humanwarriors let us live, no?"));
				speak("PL",_("Do disappear."));
				speak("PL",_("We have better things to do than killing a band of wretched goblins."));
			</Effect>	
		</Topic>
		
		<Topic name="let_goblins_go" >
			<Effect>
				maylons_grave.let_goblins_go = true;
				addStandardSpeakers();
				speak("PL",_("Just scram, before I change my mind!"));
			</Effect>	
		</Topic>
		
		<Topic name="kill_goblins" >
			<Effect>
				set(maylons_grave_tmp.Goblin1,"fraction","monster");
				set(maylons_grave_tmp.Goblin2,"fraction","monster");
				set(maylons_grave_tmp.Goblin3,"fraction","monster");
				set(maylons_grave_tmp.Goblin4,"fraction","monster");
				set(maylons_grave_tmp.GabResh,"fraction","monster");
			</Effect>	
		</Topic>
	</NPC>
	
	
	<NPC refname="Maylons Ghost">
		<Topic name="maylons_grave_freed">
			<Effect>
				speak("Maylons Ghost",_("text11"));
				if (maylons_grave.goblins_killed ~= true) then
					speak("Maylons Ghost",_("text12"));
					speak("PL",_("text13"));
					if (maylons_grave.started == true) then
						maylons_grave.finished = true;
						speak("Maylons Ghost",_("text14_reward"));
						-- drop suitable weapons
						-- dropItem("???", "graveChamber:cryptGraveChamber");
						-- dropItem("???", "graveChamber:cryptGraveChamber");
						-- dropItem("???", "graveChamber:cryptGraveChamber");
					end;
				end;
			</Effect>
		</Topic>
	</NPC>
	
	
	<Region name="aisMaylonsGraveL1">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea("GabReshGoblinArea",{"circle","cryptGoblins",15});
				addArea("GabReshArea",{"circle","cryptGoblins",5});
			if (maylons_grave.goblins_killed ~= true) then
					maylons_grave_tmp.Goblin1 = createObject("goblin", "cryptGoblins");
					maylons_grave_tmp.Goblin2 = createObject("goblin", "cryptGoblins");
					maylons_grave_tmp.Goblin3 = createObject("goblin", "cryptGoblins");
					maylons_grave_tmp.Goblin4 = createObject("goblin", "cryptGoblins");
					maylons_grave_tmp.GabResh = createObject("goblin", "cryptGoblins");
					setRefName(maylons_grave_tmp.GabResh, "Gab Resh");
					set(maylons_grave_tmp.Goblin1,"fraction","neutral");
					set(maylons_grave_tmp.Goblin2,"fraction","neutral");
					set(maylons_grave_tmp.Goblin3,"fraction","neutral");
					set(maylons_grave_tmp.Goblin4,"fraction","neutral");
					set(maylons_grave_tmp.GabResh,"fraction","neutral");
				end;
			</Effect>
		</Event>
		
		<Event trigger ="unit_die">
			<Condition>
				local list = getMonstersInArea("GabReshGoblinArea");
				if (list[1] == nil) then
					return true;
				else
					return false;
				end;
			</Condition>
			<Effect>
				maylons_grave.goblins_killed = true;
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (maylons_grave.goblins_killed ~= true and maylons_grave.started ~= true and maylons_grave.let_goblins_go ~= true) then
					return (unitIsInArea(trigger.player,"GabReshArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				createDialogue();
				addSpeaker(maylons_grave_tmp.Goblin1,"G1");
				addSpeaker(maylons_grave_tmp.Goblin1,"G2");
				addSpeaker(maylons_grave_tmp.GabResh,"Gab Resh");
				addSpeaker(trigger.player,"Player");
				addStandardSpeakers();
				setTopicBase("Gab Resh");
				changeTopic("talk_with_goblins");
			</Effect>
		</Event>
	</Region>
	
	
	<Region name="aisMaylonsGraveL2">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea("MaylonUndeadArea",{"circle","graveChamber:cryptGraveChamber",15});
				if (maylons_grave.freed ~= true) then
					createMonsterGroup("undead_weak","graveChamber:cryptGraveChamber");
					createMonsterGroup("lich_skeletons","graveChamber:cryptGraveChamber");
				end;
			</Effect>
		</Event>
		
		<Event trigger ="unit_die">
			<Condition>
				local list = getMonstersInArea("MaylonUndeadArea");
				if (list[1] == nil and maylons_grave.freed ~= true) then
					return true;
				else
					return false;
				end;
			</Condition>
			<Effect>
				maylons_grave.freed = true;
				maylons_grave_tmp.maylons_ghost = createObject("peasant", "graveChamber:cryptGraveChamber");
				setRefName(maylons_grave_tmp.maylons_ghost, "Maylons Ghost");
				createDialogue();
				addSpeaker(maylons_grave_tmp.maylons_ghost,"Maylons Ghost");
				addStandardSpeakers();
				setTopicBase("Maylons Ghost");
				changeTopic("maylons_grave_freed");
			</Effect>
		</Event>
	</Region>
	
</Quest>

