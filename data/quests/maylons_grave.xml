<Quest name="Maylons Grab" table_name="maylons_grave">
	
	<Description>
		if (maylons_grave.finished) then
			return _("Irgendein Nekromant hat tatsaechlich im Hinterland von Aisen einen alten Konzilsmagier wiederbelebt, wahrscheinlich, um fuer Verwirrung und Stoeraktionen zu sorgen. Zumindest das Problem hat sich erledigt.")
		elseif(maylons_grave.goblins_killed==true)then
			return _("Ich bin in Maylons Grab auf ein paar Goblins gestossen, die irgendwelchen Unsinn gebrabbelt haben und von einem Zombie verfolgt wurden. Irgendetwas geht in diesem Grab vor sich. Vielleicht sollte ich mal einen Blick drauf werfen.");
		elseif(maylons_grave.listened_to_goblins==true)then
			return _("Ich bin in Maylons Grab auf ein paar Goblins gestossen. Laut ihrem Schamanen hat ein Nekromant unten in der Krypta einige Untote erweckt. Ich sollte mal einen Blick drauf werfen.");
		else
			return _("Ich bin in Maylons Grab auf ein paar Goblins gestossen, die von einem Zombie verfolgt wurden. Irgendetwas geht in diesem Grab vor sich. Vielleicht sollte ich mal einen Blick drauf werfen.");
		end
	</Description>

<!-- ausloesen des Gespraeches mit den Goblins -->	
	<Region name="aisMaylonsGraveEntry">
		<Event trigger ="create_region" once = "true">
			<Condition>
				if((maylons_grave.goblins_killed ~= true) and (maylons_grave.let_goblins_go~=true))then
					return true;
				else
					return false;
				end;
			</Condition>
			<Effect>
				maylons_grave_tmp.Goblin1 = createObject("goblin_gabclan_sword", "cryptGoblins");
				maylons_grave_tmp.Goblin2 = createObject("goblin_gabclan_sword", "cryptGoblins");
				maylons_grave_tmp.Goblin3 = createObject("goblin_gabclan_bow", "cryptGoblins");
				maylons_grave_tmp.GabResh = createObject("goblin_gabresh", "cryptGoblins");
				maylons_grave_tmp.Goblin4 = createObject("goblin_gabclan_bow", "cryptGoblins");
				setRefName(maylons_grave_tmp.GabResh, "Gab Resh");
			</Effect>
		</Event>
		
		<Event trigger = "player_moved" once="true">
			<Condition>
				if((maylons_grave.started ~= true)and(maylons_grave.let_goblins_go~=true)and(maylons_grave.goblins_killed ~= true))then
					return(unitIsInArea(trigger.player,"goblinArea"))
				else
					return false
				end;
			</Condition>
			<Effect>
				maylons_grave_tmp.phase="goblinsFlee";
				maylons_grave_tmp.player = trigger.player;
				addArea("areaCryptQuest",{"circle","locParty",20});
				maylons_grave_tmp.players = getPlayersInArea("areaCryptQuest");
				groupObjectsArc(maylons_grave_tmp.players,"locParty","locGabResh",nil, 120);
				maylons_grave_tmp.zombie = createObject("zombie_crypt","locZombie");
				set(maylons_grave_tmp.zombie,"willpower",0);
				setCutsceneMode(true);
				--addCameraPosition(0,"cryptGoblins", -90,60, 25);
				addCameraPosition(0,"cryptGoblins", -90,10, 15);
				maylons_grave_tmp.door = getObjectByNameRef("entryDoor");
				door_setopen(maylons_grave_tmp.door,true);
				addUnitCommand(maylons_grave_tmp.zombie,"walk","cryptGoblins");
				unitSpeak(maylons_grave_tmp.Goblin2,"Rakthr mootrick!","panic");
				addUnitCommand(maylons_grave_tmp.Goblin1,"walk","locGoblin1");
				addUnitCommand(maylons_grave_tmp.Goblin2,"walk","locGoblin2");
				addUnitCommand(maylons_grave_tmp.Goblin3,"walk","locGoblin3");
				addUnitCommand(maylons_grave_tmp.Goblin4,"walk","locGoblin4");
				timedExecute('addUnitCommand('..maylons_grave_tmp.GabResh..',"freeze",'..maylons_grave_tmp.zombie..');',1000);
				timedExecute('addUnitCommand('..maylons_grave_tmp.GabResh..',"walk","locShutDoor");',1400);
				--Gab'Resh zu einer Location neben der Tuer schicken und das abfangen
				timedExecute('addCameraPosition(4000,"cryptGoblins",-90,10,25)',2000);
				timedExecute('addCameraPosition(3000,"locGabResh",-90,60,20)',6000);
			</Effect>
		</Event>
		
		<Event trigger = "command_complete" once="true">
			<Condition>
				if(get(trigger.unit,"subtype")=="goblin_gabresh")then
					return(maylons_grave_tmp.phase=="goblinsFlee")and (unitIsInArea(maylons_grave_tmp.GabResh,"areaDoor"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				lookAtObject(maylons_grave_tmp.GabResh,maylons_grave_tmp.door);
				door_setopen(maylons_grave_tmp.door,false);
				timedExecute('addUnitCommand('..maylons_grave_tmp.GabResh..',"walk","locGabResh");',500);
			</Effect>
		</Event>
		
		<Event trigger = "command_complete" once="true">
			<Condition>
				if(get(trigger.unit,"subtype")=="goblin_gabclan_sword")then
					return(maylons_grave_tmp.phase=="goblinsFlee")and (unitIsInArea(trigger.unit,"areaGoblin1"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				lookAt(trigger.unit,"locParty");
			</Effect>
		</Event>
		<Event trigger = "command_complete" once="true">
			<Condition>
				if(get(trigger.unit,"subtype")=="goblin_gabclan_sword")then
					return(maylons_grave_tmp.phase=="goblinsFlee")and (unitIsInArea(trigger.unit,"areaGoblin2"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				lookAt(trigger.unit,"locParty");
			</Effect>
		</Event>
		<Event trigger = "command_complete" once="true">
			<Condition>
				if(get(trigger.unit,"subtype")=="goblin_gabclan_Bow")then
					return(maylons_grave_tmp.phase=="goblinsFlee")and (unitIsInArea(trigger.unit,"areaGoblin3"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				lookAt(trigger.unit,"locParty");
			</Effect>
		</Event>
		<Event trigger = "command_complete" once="true">
			<Condition>
				if(get(trigger.unit,"subtype")=="goblin_gabclan_bow")then
					return(maylons_grave_tmp.phase=="goblinsFlee")and (unitIsInArea(trigger.unit,"areaGoblin4"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				lookAt(trigger.unit,"locParty");
				unitSpeak(trigger.unit,"Mar! Nom Togubri!");
				--auf Spieler zeigen
			</Effect>
		</Event>
		
		
		<Event trigger = "command_complete" once="true">
			<Condition>
				if(get(trigger.unit,"subtype")=="goblin_gabresh")then
					return(maylons_grave_tmp.phase=="goblinsFlee")and (unitIsInArea(maylons_grave_tmp.GabResh,"areaTalk"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				createDialogue();
				addPlayersToDialog(maylons_grave_tmp.players);
				addStandardRoles();
				addSpeaker(maylons_grave_tmp.GabResh,"GabResh");
				addSpeaker(maylons_grave_tmp.player,"player");
				setTopicBase("Gab Resh");
				lookAt(maylons_grave_tmp.GabResh,"locParty");
				speak("GabResh","Wartet, grosse Kriegermenschens. Nich toeten!","fear", 3000);
				addQuestion(_("Mit den Goblins reden?"));
				addAnswer(_("Ja"),'talk_with_goblins');
				addAnswer(_("Nein"),'kill_goblins_immediately');
				
			</Effect>
		</Event>
	</Region>
	
	<NPC refname="Gab Resh">
		<Topic name="talk_with_goblins">
			<Effect>
				speak("player",_("Ein Goblin, der reden will?"),"surprised");
				speak("GabResh",_("Ja. Nich schlagen, nich toeten."),"panic");
				speak("GabResh",_("Gab'Resh und seine nur harmlose Viehdiebe. Keine Banditen."),"fear");
				speak("GabResh",_("Ihr zuhoeren, ja?"),"fear");
				addQuestion(_("Was tun?"));
				addAnswer(_("Den Goblins zuhoeren"),"keep_on_talking");
				addAnswer(_("Die Goblins verjagen"),"let_goblins_go");
				addAnswer(_("Die Goblins erschlagen"),"kill_goblins");
			</Effect>
		</Topic>
		
		<Topic name="keep_on_talking" >
			<Effect>
				set(maylons_grave_tmp.Goblin1,"fraction","human");
				set(maylons_grave_tmp.Goblin2,"fraction","human");
				set(maylons_grave_tmp.Goblin3,"fraction","human");
				set(maylons_grave_tmp.Goblin4,"fraction","human");
				set(maylons_grave_tmp.GabResh,"fraction","human");
				speak("magopt",_("Was koennte ein Goblin schon zu sagen haben"),"sneer");
				speak("GabResh",_("Wir uns hier oft verstecken."),"normal");
				speak("GabResh",_("Kaum Menschens vorbei kommen, und wenn doch, dann nie wieder zurueck kehren aus Tiefen von Hoehle."),"amused");
				speak("GabResh",_("Aber letzten Mond schwarzer Mensch vorbei gekommen."),"unhappy");
				speak("GabResh",_("Jetzt das Grausen aus den Tiefen auch nach oben wandern und hinter uns armen Goblins her sein, wo nie was stehlen nich wollten."),"fear");
				speak("priopt",_("Das klingt beinahe, als sei ein Nekromant hier vorbei gekommen."),"thoughtful");
				if(solo())then
					speak("player",_("Ein solches Problem kann ich nicht einfach so inmitten dieser unterbewachten Region lassen."),"normal");
				else
					speak("priopt",_("Ein solches Problem koennen wir nicht einfach so inmitten dieser unterbewachten Region lassen."),"normal");
				end;
				speak("priopt",_("Wer weiï¿½, was alles passieren koennte?"),"normal");
				if(solo())then
					speak("arcopt", _("Wirklich, ich sollte diese armen gebundenen Seelen befreien und zu einem Kurzurlaub in Harads Hoelle schicken."),"sneer");
				else
					speak("arcopt", _("Wirklich, wir sollten diese armen gebundenen Seelen befreien und zu einem Kurzurlaub in Harads Hoelle schicken."),"sneer");
					if(getSpeaker("waropt")~=getSpeaker(arcopt))then
						speak("waropt",_("Besser sie als wir."),"unhappy");
					end;
				end;
				speak("GabResh",_("Gute Warnung, nein? Maechtige Menschenkriegers uns am leben lassen, nein?"),"happy");
				if(solo())then
					speak("player",_("Verschwindet schon. Ich habe jetzt besseres zu tun, als eine Bande armseliger Goblins zu toeten."),"unhappy");
				else
					speak("player",_("Verschwindet schon. Wir haben jetzt besseres zu tun, als eine Bande armseliger Goblins zu toeten."),"unhappy");
				end;
				executeInDialog('insertTrigger("goblinsWalkAway")');
				maylons_grave.started=true;
				--fuert zu weiterer Belohnung
				maylons_grave.let_goblins_go=true;
				--fuert zu weiterem quest
				maylons_grave.listened_to_goblins=true;
				setCutsceneMode(false);
			</Effect>	
		</Topic>
		
		<Topic name="kill_goblins_immediately" >
			<Effect>
				maylons_grave.goblins_killed = true;
				maylons_grave.started=true;
				if(solo())then
					speak("PL",_("Elendes Gezuecht!Sterbt alle!"));
				else
					speak("PL",_("Elendes Gezuecht! Macht sie nieder!"));
				end;
				--fuert spaeter zu weiterem Kampf
				maylons_grave.goblins_killed = true;
				setCutsceneMode(false);
			</Effect>	
		</Topic>
		
		<Topic name="let_goblins_go" >
			<Effect>
				set(maylons_grave_tmp.Goblin1,"fraction","human");
				set(maylons_grave_tmp.Goblin2,"fraction","human");
				set(maylons_grave_tmp.Goblin3,"fraction","human");
				set(maylons_grave_tmp.Goblin4,"fraction","human");
				set(maylons_grave_tmp.GabResh,"fraction","human");
				maylons_grave.started=true;
				maylons_grave.let_goblins_go = true;
				speak("player",_("Macht, dass ihr davonkommt, bevor ich es mir anders ueberlege!"));
				executeInDialog('insertTrigger("goblinsWalkAway")');
				setCutsceneMode(false);
			</Effect>	
		</Topic>
		
		<Topic name="kill_goblins" >
			<Effect>
				maylons_grave.started=true;
				maylons_grave.goblins_killed = true;
				setCutsceneMode(false);
			</Effect>	
		</Topic>
	</NPC>
	
	<Region name="aisMaylonsGraveEntry">
		<Event trigger="goblinsWalkAway" once ="true">
			<Effect>
				addUnitCommand(maylons_grave_tmp.Goblin1,"walk","entry_south")
				addUnitCommand(maylons_grave_tmp.Goblin2,"walk","entry_south")
				addUnitCommand(maylons_grave_tmp.Goblin3,"walk","entry_south")
				addUnitCommand(maylons_grave_tmp.Goblin4,"walk","entry_south")
				addUnitCommand(maylons_grave_tmp.GabResh,"walk","entry_south") --areaGoblinsAway
			</Effect>
		</Event>
		<Event trigger="unit_moved">
			<Condition>
				local unit = get(trigger.unit,"subtype");
				if((unit == "goblin_gabresh")or(unit == "goblin_gabclan_bow")or(unit == "goblin_gabclan_sword"))then
					return (unitIsInArea(trigger.unit,"areaGoblinsAway"));
				end;
				return false;
			</Condition>
			<Effect>
				deleteObject(trigger.unit);
			</Effect>
		</Event>
	</Region>
<!-- Ende des Goblingespraeches -->		
	<Region name="aisMaylonsGraveL1">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea("areaGathering",{"circle",{0,0},10000});
			</Effect>
		</Event>
		
		<Event trigger="create_template">
			<Condition>
				return (maylons_grave.finished~=true);
			</Condition>
			<Effect>
				if(trigger.templname=="randomLoc4_4")then
					createMonsterGroup("zombies_maylon",trigger.locCenter,4);
				end;
			</Effect>
		</Event>
		
		<Event trigger="enter_region" once="true">
			<Condition>
				return maylons_grave.finished==true;
			</Condition>
			<Effect>
				local monsters = getMonstersInArea("areaGathering");
				for i,monster in ipairs(monsters) do
					set(monster, "health",0);
				end;
			</Effect>
		</Event>
	</Region>	
<!-- Maylons Geist, Maylons Mumie-->
	<Region name="aisMaylonsGraveL2">
		<Event trigger ="create_region" once = "true">
			<Effect>
				addArea("areaGathering",{"circle",{0,0},10000});
				if (maylons_grave.freed ~= true) then
				end;
			</Effect>
		</Event>
		
		<Event trigger="object_use" once="true">
			<Condition>
				return ((trigger.used_object == getObjectByNameRef("doorGrave"))and (maylons_grave.freed~=false));
			</Condition>
			<Effect>
				-- when opening the door to maylons grave chamber, his mummy will appear
				setCutsceneMode(true);
				
				local door = getObjectByNameRef("doorGrave");
				scriptobjectvar[door]["locked"] = true;
				local doorPos=get(door,"position");
				
				addCameraPosition(0,doorPos,-90,45,10);
				addCameraPosition(2000,doorPos,-90,10,10);
				addCameraPosition(2000,"graveChamber:locMaylon",-90,10,10);
				
				startTimer("camera_complete",4000);
			</Effect>
		</Event>
		
		<Event trigger="camera_complete">
			<Effect>
				maylons_grave_tmp.maylon=createObject("maylonMummy","graveChamber:locMaylon",90);
				timedExecute('createObject("skel_maylon","graveChamber:locMaylonGuard1",90)',800);
				timedExecute('createObject("skel_maylon","graveChamber:locMaylonGuard2",90)',200);
				startTimer("maylon_fight",4000);
			</Effect>
		</Event>
		
		<Event trigger="maylon_fight">
			<Effect>
				timedExecute('setCutsceneMode(false)',1000);
			</Effect>
		</Event>
	
		<Event trigger="create_template">
			<Condition>
				return (maylons_grave.finished~=true);
			</Condition>
			<Effect>
				if(trigger.templname=="randomLoc4_4")then
					createMonsterGroup("zombies_maylon",trigger.locCenter,4);
				end;
			</Effect>
		</Event>
		
		<Event trigger ="unit_hit">
			<Condition>
				return(trigger.defender==maylons_grave_tmp.maylon);
			</Condition>
			<Effect>
				if(trigger.attacker~=nil)then
					maylons_grave_tmp.lastAttacker = trigger.attacker;
				end;
			</Effect>
		</Event>
		
		<Event trigger ="unit_dead" once="true">
			<Condition>
				return(trigger.unit == maylons_grave_tmp.maylon);
			</Condition>
			<Effect>
				maylons_grave.freed = true;
				local monsters = getMonstersInArea("areaGathering");
				for i,monster in ipairs(monsters) do
					set(monster, "health",0);
				end;
				local position = get(trigger.unit,"position");
				setCutsceneMode(true);
				addCameraPosition(0,position,-90,45,10);
				addUnitCommand(maylons_grave_tmp.lastAttacker,"walk",position,3);
				timedExecute('maylons_grave_tmp.maylon=createObject("maylon",{'..position[1]..','..position[2]..'})',1000);
			</Effect>
		</Event>
		
		<Event trigger="create_unit">
			<Condition>
				return(maylons_grave.freed == true);
			</Condition>
			<Effect>
				startTimer("maylon_talk",1500)
			</Effect>
		</Event>
		
		<Event trigger="maylon_talk" once="true">
			<Effect>
				lookAtObject(maylons_grave_tmp.lastAttacker,maylons_grave_tmp.maylon);
				lookAtObject(maylons_grave_tmp.maylon,maylons_grave_tmp.lastAttacker);
				createDialog();
				setTopicBase("global");
				addSpeaker(maylons_grave_tmp.lastAttacker,"player");
				addSpeaker(maylons_grave_tmp.maylon,"maylon");
				speak("maylon",_("Ich danke Euch fuer die Befreiung meines Geistes."),"happy");
				speak("maylon",_("Moeget Ihr noch viele grosse Taten vollbringen."),"happy");
				speak("maylon",_("Akerans Segen mit Euch."),"happy");
				speak("maylon",_("In meinem Sarkophag befinden sich viele Hinterlassenschaften aus meinem sterblichen Leben."),"normal");
				speak("maylon",_("Ich habe schon lange keine Verwendung mehr dafuer. Sucht Euch eine Waffe aus, die euch gefaellt."),"normal");
				speak("maylon",_("Das gilt auch fuer Eure Freunde."),"normal");
				speak("maylon",_("Jetzt muss ich aber wieder zurueck in die Glueckseligkeit von Akerans Ewiger Oase."),"excited");
				executeInDialog("set("..maylons_grave_tmp.maylon..",'health',0)");
				speakPause(1000);
				speak("player",_("Ob er das auch gesagt haette, wenn er wuesste, dass er erst mal einen Umweg ueber Harads Hoelle nehmen wird?"),"sad")
				changeTopic("maylon_rip");
			</Effect>
		</Event>
		<Event trigger="maylon_rip" once="true">
			<Effect>
				maylons_grave.finished=true;
				scriptobjectvar[getObjectByNameRef("doorGrave")]["locked"] = false;
				setCutsceneMode(false);
			</Effect>
		</Event>
	</Region>	
</Quest>

