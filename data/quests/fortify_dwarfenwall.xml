<Quest name="Fortify Dwarfenwall" table_name="fortify_dwall">
	
	<Init>
		local a = 2
	</Init>
	
	<Description>
		if (fortify_dwall.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	<Region name="elCnlLobby">
		<Event trigger="create_region" once="true">
			<Effect>
				if (fortify_dwall.scene1 ~= true) then
					fortify_dwall_tmp.soren = createObject("soren", "locSorenWindclaw");
					setRefName(fortify_dwall_tmp.soren, "Soren Windclaw");
					set(fortify_dwall_tmp.soren,"angle",-90);
					set(fortify_dwall_tmp.soren,"fraction","neutral_to_all");
					
					if (tutorial.finished == true) then
						fortify_dwall_tmp.tolec = createObject("tolec", "locTolecScene1");
						set(fortify_dwall_tmp.tolec,"ai_state","inactive");
						setRefName(fortify_dwall_tmp.tolec, "Tolec");
						set(fortify_dwall_tmp.tolec,"angle",90);
						
						fortify_dwall_tmp.derred = createObject("derred", "locDerredScene1");
						set(fortify_dwall_tmp.derred,"ai_state","inactive");
						setRefName(fortify_dwall_tmp.derred, "Derred");
						set(fortify_dwall_tmp.derred,"angle",90);
					end;
				end;
			</Effect>	
		</Event>
	</Region>
	
	<NPC refname="Derred">
		<Topic name="start_scene1" start_option="Windklaue sprechen">
			<Condition>
				return (tutorial.finished == true and fortify_dwall.scene1 ~= true)
			</Condition>
			<Effect>
				insertTrigger("start_scene1");
				speak("Derred",_("Folgt uns bitte."));
			</Effect>
		</Topic>
	</NPC>
	
	<NPC refname="Tolec">
		<Topic name="start_scene1" start_option="Windklaue sprechen">
			<Condition>
				return (tutorial.finished == true and fortify_dwall.scene1 ~= true)
			</Condition>
			<Effect>
				insertTrigger("start_scene1");
				speak("Tolec",_("Folgt uns bitte."));
			</Effect>
		</Topic>
	</NPC>
	
	<Region name="elCnlLobby">
		<Event trigger="start_scene1" once="true">
			<Effect>
				setCutsceneMode(true);
				
				local door = getObjectByNameRef("doorScene1");
				door_setopen(door,true);
				addCameraPosition(0,get(door,"position"), -90,60, 20);
				addCameraPosition(4000,get(door,"position"), -90,60, 20);
				addCameraPosition(5000,"locWay4", -90,60, 20);
				
				startTimer("guard_scene1_walk1",2000);
				startTimer("players_scene1_walk1",3000);
				startTimer("guard_scene1_walk2",9000);
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk1" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locWay3");
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locWay4");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locWay4");
				fortify_dwall_tmp.tgoal = "locWay4";
				fortify_dwall_tmp.dgoal = "locWay4";
				
			</Effect>
		</Event>
		
		<Event trigger="players_scene1_walk1" once="true">
			<Effect>
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					addUnitCommand(player,"walk","locWay3");
					addUnitCommand(player,"walk","locWay4");
				end;
			</Effect>
		</Event>
		
		<Event trigger="command_complete">
			<Condition>
				return (trigger.unit ==fortify_dwall_tmp.tolec and fortify_dwall_tmp.tgoal ~= nil and trigger.success == false)
			</Condition>
			<Effect>
				moveObject(trigger.unit,fortify_dwall_tmp.tgoal);
				fortify_dwall_tmp.tgoal = nil;
			</Effect>
		</Event>
		
		<Event trigger="command_complete">
			<Condition>
				return (trigger.unit ==fortify_dwall_tmp.derred and fortify_dwall_tmp.dgoal ~= nil and trigger.success == false)
			</Condition>
			<Effect>
				moveObject(trigger.unit,fortify_dwall_tmp.dgoal);
				fortify_dwall_tmp.dgoal = nil;
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk2" once="true">
			<Effect>
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.tolec,"Tolec");
				
				local mageopt = getSpeaker("magopt");
				local waropt= getSpeaker("waropt");
				local leader= getSpeaker("leader");
				
				speak("magopt",_("Als wenn das Theater hier irgend jemanden beeindrucken würde..."),"bored");
				if (mageopt ~= waropt) then
					speak("waropt",_("Na klar! Jetzt hast du wieder eine große Klappe."),"unhappy");
					speak("magopt",_("Warum gebe ich mich doch gleich mit deiner Gesellschaft ab?"),"grin");
					if (leader ~= mageopt and leader ~= waropt) then
						speak("leader",_("Scht! Streiten könnt ihr euch später."));
					end;
				end;
				speak("Tolec",_("Endlich sind wir da!"),"excited");
				executeInDialog("insertTrigger('guard_scene1_walk3')");
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk3" once="true">
			<Effect>
				local door = getObjectByNameRef("doorSorenSouth");
				door_setopen(door,true);
				startTimer("guard_scene1_walk4",2000);
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk4" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locMerc2");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locMerc1");
				fortify_dwall_tmp.tgoal = "locMerc2";
				fortify_dwall_tmp.dgoal = "locMerc1";
				
				addCameraPosition(5000,"locParty", -90,60, 20);
				startTimer("guard_scene1_walk5",7000);
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk5" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locGuard3");
				fortify_dwall_tmp.tgoal = nil;
				assembleParty("elCnlLobby","locWay4");
				startTimer("scene1_intro",2000);
			</Effect>
		</Event>
		<Event trigger="scene1_intro" once="true">
			<Effect>
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.tolec,"Tolec");
				addSpeaker(fortify_dwall_tmp.derred,"Derred");
				addSpeaker(fortify_dwall_tmp.soren,"Soren Windclaw");
				
				speak("Derred",_("Mein Lord! Die... Gezeichneten sind jetzt da."));
				speak("Soren Windclaw",_("Sehr gut."));
				executeInDialog("insertTrigger('scene1_tback')");
				speakPause(3000);
				speak("any",_("Spürt ihr das?!! Das fühlt sich an wie-"),"panic");
				if (getSpeaker("leader") ~= getSpeaker("any")) then
					speak("leader",_("Scht!"),"unhappy");
				end;
				local solo = (getPlayers()[2] == nil);
				if (solo) then
					speak("Tolec",_("Er erwartet dich jetzt"));
				else
					speak("Tolec",_("Er erwartet euch jetzt"));
				end;
				executeInDialog("insertTrigger('enter_soren_room')");

			</Effect>
		</Event>
		
		<Event trigger="scene1_tback" once="true">
			<Effect>
				local door = getObjectByNameRef("doorSorenSouth");
				addUnitCommand(fortify_dwall_tmp.tolec,"walk",get(door,"position"),1);
				addCameraPosition(3000,"locWay4", -90,60, 20);
			</Effect>
		</Event>
		
		
		<Event trigger="enter_soren_room" once="true">
			<Effect>
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					addUnitCommand(player,"walk","locParty");
				end;
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locMerc2");
				addCameraPosition(3000,"locSorenWindclaw", -90,60, 20);
				startTimer("scene1_assemble",4000);
			</Effect>
		</Event>
		
		
		<Event trigger="scene1_assemble" once="true">
			<Effect>
				assembleParty("elCnlLobby","locParty","locSorenWindclaw");
				fortify_dwall_tmp.assemble = "scene1";
			</Effect>
		</Event>
		
		<Event trigger="guards_out" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locGuardsAway");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locGuardsAway");
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locGuard1");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locGuard1");
				
				local door = getObjectByNameRef("doorSorenSouth");
				door_setopen(door,false);
				scriptobjectvar[door]["locked"] = true;
			</Effect>
		</Event>
		
		<Event trigger="unit_moved" >
			<Condition>
				return ((trigger.unit == fortify_dwall_tmp.tolec or trigger.unit == fortify_dwall_tmp.derred) and unitIsInArea(trigger.unit,"areaGuardAway"))
			</Condition>	
			<Effect>
				timedExecute("deleteObject("..trigger.unit..")",100);
			</Effect>
		</Event>
		
		<Event trigger="turn_soren" once="true">
			<Effect>
				timedExecute("set(fortify_dwall_tmp.soren,'angle',-45)",0);
				timedExecute("set(fortify_dwall_tmp.soren,'angle',0)",300);
				timedExecute("set(fortify_dwall_tmp.soren,'angle',45)",600);
				timedExecute("set(fortify_dwall_tmp.soren,'angle',90)",900);
			</Effect>
		</Event>
		
		<Event trigger="party_complete" once="true">
			<Condition>
				return (fortify_dwall_tmp.assemble == "scene1");
			</Condition>
			<Effect>
				fortify_dwall_tmp.assemble = nil;
				groupObjectsArc(getPlayers(),"locParty","locSorenWindclaw",nil,45);
				
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.tolec,"Tolec",true);
				addSpeaker(fortify_dwall_tmp.derred,"Derred",true);
				addSpeaker(fortify_dwall_tmp.soren,"Soren",true);
				
				addCameraPosition(3000,"locCamera", -90,60, 30);
				
				local solo = (getPlayers()[2] == nil);
				local magopt = getSpeaker("magopt");
				
				speak("Soren",_("You're presence is no longer needed."),"aloof");
				speak("Tolec",_("But my Lord, those are"),"surprised");
				executeInDialog("insertTrigger('turn_soren')");
				speak("Soren",_("..."),"threaten",2500);
				speak("Tolec",_("As you wish. My apologies."),"fear");
				speak("Derred",_("Come on, he knows what he's doing."),"fear");
				
				executeInDialog("insertTrigger('guards_out')");
				
				speak("magopt",_("Nice shack!"),"sneer");
				speak("waropt",_("Well, the corners are a bit dirty though."),"thoughtful");
				speak("waropt",_("...um nicht zu sagen: schleimig."),"grin");
				speak("priest",_("Those ritual objects have seen better times, too."));
				speak("Soren",_("Yes, they warned me that you're difficult."));
				speak("waropt",_("Difficult?"),"surprised");
				speak("waropt",_("You're putting in so much effort,"),"sneer");
				speak("waropt",_("and everything you get is 'difficult'."));
				speak("magopt",_("Pft. I feel like flaring off the whole place."),"unhappy");
				local magopt = getSpeaker("magopt");
				if (magopt ~= 0 and magopt ~= getSpeaker("any")) then
					speak("any",_("With all those wimps here it's not really worth the effort, isn't it?"),"amused");
					speak("leader",_("Wenn noch mehr von Riesendinger frei kommen könnte das ein paar Schwierigkeiten machen..."));
					speak("arcopt",_("Und die Chance ist recht hoch... die Monster hier haben schließlich alle ihren eigenen Kopf."),"grin");
					speak("priest",_("I know this nice little ban..."));
				end;
				speak("Soren",_("Would you please take a quick look at this stone."),"bored");
				
				-- Er haelt einen Kristall in die Luft. Die Gruppe verstummt sofort und
				-- dreht sich in Richtung des Gegenstandes.
				
				speak("any",_("Is that a...?"),"fear");
				speak("Soren",_("Quite so."),"grin");
				speak("Soren",_("It is a stone straight from the heart of Harad's hell."));
				speak("PL",_("How is it possible that you're still alive?"),"surprised");
				speak("Soren",_("Indeed the right question."),"grin");
				speak("Soren",_("With an answer, that could release every one of you from your suffering."));
				speak("Soren",_("But before I give it to you, you have to do something for me."));
				speak("any",_("May Harad curse you!"),"angry");
				speak("Soren",_("Ts Ts. Wie unhöflich den Namen des Verfluchten in Akerans Hallen zu verwenden."),"unhappy");
				speak("leader",_("Das ist eine verdammte Räuberhöhle."),"threaten");
				speak("Soren",_("Euch entgeht der eigentliche Punkt."),"bored");
				speak("Soren",_("Until then you should remember that it is entirely in you hands"),"threaten");
				speak("Soren",_("how long you will be under this curse."));
				speak("Soren",_("Fulfil my orders to the councils satisfaction"));
				speak("Soren",_("and I have the power to release you of the claws of the deathgod."));
				speak("Soren",_("If not, however..."));
				speak("leader",_("We know that one allready. Cut the speach."),"bored");
				if (getSpeaker("leader") ~= getSpeaker("any")) then
					speak("any",_("What?!"),"surprised");
					speak("any",_("The curse can be taken from us? Why do I hear this only know?"));
				end;
				speak("Soren",_("As you wish."),"grin");
				speak("Soren",_("The task is pretty dangerous and you are likely to die more than once."));
				speak("PL",_("Harad's curse has to have some advantage."));
				speak("waropt",_("If only the pain wasn't so bad everytime..."),"sad");
				if (getSpeaker("waropt") ~= getSpeaker("magopt")) then
					speak("magopt",_("Even here you have to whine."));
				end;
				if (not solo) then
					speak("Soren",_("You are indeed a bunch of trying people."));
				else
					speak("Soren",_("Ihr seid in der Tat eine schwierige Gestalt"));
				end;
				speak("magopt",_("He's beginning to make me angry."),"angry");
				if (getSpeaker("priest") ~= getSpeaker("magopt")) then
					speak("priest",_("Peace!"));
				end;
				speak("Soren",_("The first thing you have to learn are obviously manners."),"threaten");
				speak("Soren",_("Consider it as a small bonus:"),"aloof");
				speak("Soren",_("Before your real assignment you will go to dwarfenwall as backup."));
				speak("Soren",_("Show the undead there who the real favourite of the deathgod is."));
				speak("PL",_("Smells like exploitation."),"unhappy");
				speak("priopt",_("Besides the necromancers don't follow Harad."),"thoughtful");
				speak("any",_("This robegnome ranks pretty high among all the cheesy rats"),"unhappy");
				speak("any",_("for whom we pulled chestnuts out of the fire."),"unhappy");
				if (not solo) then
					speak("waropt",_("Ich verstehe auch nicht, warum wir hier nach seiner Pfeife tanzen. Er ist doch schließlich-"),"threaten");
					speak("any",_("Nur ein Mensch!!"),"warcry");
				end;
				speak("Soren",_("You obviously misjudge your position."),"normal");
				speak("Soren",_("What do you think will happen, if your revealed in town?"));
				speak("Soren",_("We know everything about your kind,"));
				speak("Soren",_("and believe me, no one will be stupid enough to kill you."));
				
				setTopicBase("Soren Windclaw");
				addQuestion(_("Continue to be snotty?"));
				addAnswer(_("Yes"),"be_unkind");
				addAnswer(_("No"),"be_kind");
			</Effect>
		</Event>

	</Region>
	
	
		
	<NPC refname="Soren Windclaw">
		<Topic name="be_unkind">
			<Effect>
				local solo = (getPlayers()[2] == nil);
				
				speak("PL",_("You consider yourself very mighty and clever, don't you?"),"angry");
				if (not solo) then
					speak("magopt",_("Surely he has written down that knowledge of his somewhere."),"thoughtful");
					speak("magopt",_("We can search for it after he's dead."));
					if (getSpeaker("magopt") ~= getSpeaker("waropt")) then
						speak("waropt",_("A good opportunity, indeed."),"grin");
					end;
				else
					speak("leader",_("Surely you have written down that knowledge of yours somewhere."),"thoughtful");
					speak("leader",_("I can search for it after your untimely death."));
				end;
				speak("Soren",_("Yes, they warned me about that, too."));
				
				-- Er beschwoert einen kleinen Feuerelementar vor sich und haelt einen
				-- weiteren Kristall in die Luft.
				
				speak("Soren",_("I will keep an eye on you and give you orders with this crystal."));
				speak("Soren",_("This simple elemental will remind you now that immortality has little meaning here."));
				executeInDialog("insertTrigger('fire_elemental')");
			</Effect>
		</Topic>
		
		<Topic name="be_kind">
			<Effect>
				speak("PL",_("Of course. With our freedom as the price"));
				speak("PL",_("we will do everything in our might to be successful."));
				speak("waropt",_("I don't like it."));
				speak("Soren",_("Very well."));
				speak("Soren",_("I must take care of the preparations for the princes wedding now."));
				speak("Soren",_("There is no time for further explanations."));
				speak("Soren",_("Take this crystall and some gold."));
				speak("Soren",_("I will send you orders with it when the time comes."));
				
				-- Jeder der Gruppe erhält 200 GM. Anschließend verlassen sie den Saal.
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"fortify_dwall.reward") ~= true) then
						setPlayerPrivateVar(player,"fortify_dwall.reward",true);
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 200);
					end;
				end;
				
				executeInDialog("setCutsceneMode(false)");
				executeInDialog("insertTrigger('teleport_out')");
			</Effect>
		</Topic>
	</NPC>
	
	
	<Region name="elCnlLobby">
		<Event trigger="fire_elemental" once="true">
			<Effect>
				setCutsceneMode(false);
				fortify_dwall_tmp.elemental = createObject("fireElemS","locElemental");
				fortify_dwall_tmp.playernr = table.getn(getPlayers());
				fortify_dwall_tmp.inactive_pl = {};
				fortify_dwall_tmp.inactive_pl_nr = 0;
				fortify_dwall_tmp.inactive_pl_wall = {};
				fortify_dwall_tmp.fwall1 = createObject("blockFireWall","locFireWallEast",-45);
				fortify_dwall_tmp.fwall2 = createObject("blockFireWall","locFireWallWest",45);
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (fortify_dwall.scene1 ~= true) then
					return (unitIsInArea(trigger.player,"SorenWindclawArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				createDialogue();
				addSpeaker(soren_windclaw,"Soren");
				addSpeaker(fortify_dwall_tmp.guard1,"Tolec");
				addSpeaker(fortify_dwall_tmp.guard2,"Derred");

				addSpeaker(trigger.player,"Player");
				addStandardSpeakers("elCnlLobby","locParty");
				setCutsceneMode(true);
				setTopicBase("Soren Windclaw");
				changeTopic("scene1_dialogue");
			</Effect>
		</Event>
		
		<Event trigger ="unit_die">
			<Condition>
				return (fortify_dwall_tmp.elemental ~= nil and get(trigger.unit,"type") == "PLAYER");
			</Condition>
			<Effect>
				fortify_dwall_tmp.inactive_pl_nr = fortify_dwall_tmp.inactive_pl_nr+1;
				
				set(trigger.unit,"health",1);
				set(trigger.unit,"state","inactive");
				fortify_dwall_tmp.inactive_pl[fortify_dwall_tmp.inactive_pl_nr] = trigger.unit;
				local pos = get(trigger.unit,"position");
				fortify_dwall_tmp.inactive_pl_wall[fortify_dwall_tmp.inactive_pl_nr] = createObject("fireCage",pos);
				
				fortify_dwall_tmp.playernr = fortify_dwall_tmp.playernr-1;
				if (fortify_dwall_tmp.playernr == 0) then
					startTimer("remove_fire_walls",1000);
					startTimer("reactivate_player",2000);
				end;
			</Effect>	
		</Event>
		
		<Event trigger ="unit_die" once="true" >
			<Condition>
				return (trigger.unit == fortify_dwall_tmp.elemental);
			</Condition>
			<Effect>
				fortify_dwall_tmp.elemental = nil
				startTimer("reactivate_player",1000);
			</Effect>
		</Event>
		
		<Event trigger ="remove_fire_walls" once="true" >
			<Effect>
				local i;
				for i=1,fortify_dwall_tmp.inactive_pl_nr do
					deleteObject(fortify_dwall_tmp.inactive_pl_wall[i]);
				end;
				deleteObject(fortify_dwall_tmp.fwall1);
				deleteObject(fortify_dwall_tmp.fwall2);
			</Effect>
		</Event>
		
		<Event trigger ="reactivate_player" once="true" >
			<Effect>
				local i;
				for i=1,fortify_dwall_tmp.inactive_pl_nr do
					set(fortify_dwall_tmp.inactive_pl[i],"state","active");
					fullHeal(fortify_dwall_tmp.inactive_pl[i]);
					deleteObject(fortify_dwall_tmp.inactive_pl_wall[i]);
				end;
				
				if (fortify_dwall_tmp.elemental ~= nil) then
					deleteObject(fortify_dwall_tmp.elemental);
					fortify_dwall_tmp.elemental = nil;
					startTimer("elemental_end",2000);
					fortify_dwall_tmp.elemental_defeat = false;
				else
					startTimer("elemental_end",1000);
					fortify_dwall_tmp.elemental_defeat = true;
				end
			</Effect>
		</Event>
		
		<Event trigger ="elemental_end" once="true" >
			<Effect>
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.soren,"Soren",true);
				
				if (fortify_dwall_tmp.elemental_defeat) then
					speak("leader",_("Na bitte, das war doch eher zahm."),"injured2");
				end;
				
				speak("Soren",_("That was the weakest elemental I could possibly summon."));
				speak("Soren",_("Now go. I have no time to waste."));
				speak("Soren",_("The prince will marry soon and there are lots of preparations to make."));
				
				executeInDialog("insertTrigger('teleport_out')");
			</Effect>
		</Event>
		
		<Event trigger ="teleport_out" once="true" >
			<Effect>
				assembleParty("medBackalley","locScene3","entry_north");
			</Effect>
		</Event>
	</Region>
	
</Quest>

