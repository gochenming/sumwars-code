<Quest name="Fortify Dwarfenwall" table_name="fortify_dwall">
	
	<Init>
		local a = 2
	</Init>
	
	<Description>
		if (fortify_dwall.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	<Region name="elCnlLobby">
		<Event trigger="create_region" once="true">
			<Effect>
				if (fortify_dwall.scene1 ~= true) then
					fortify_dwall_tmp.soren = createObject("soren", "locSorenWindclaw");
					setRefName(fortify_dwall_tmp.soren, "Soren Windclaw");
					set(fortify_dwall_tmp.soren,"angle",-90);
					set(fortify_dwall_tmp.soren,"fraction","neutral_to_all");
					
					if (tutorial.finished == true) then
						fortify_dwall_tmp.tolec = createObject("tolec", "locTolecScene1");
						set(fortify_dwall_tmp.tolec,"ai_state","inactive");
						setRefName(fortify_dwall_tmp.tolec, "Tolec");
						set(fortify_dwall_tmp.tolec,"angle",90);
						
						fortify_dwall_tmp.derred = createObject("derred", "locDerredScene1");
						set(fortify_dwall_tmp.derred,"ai_state","inactive");
						setRefName(fortify_dwall_tmp.derred, "Derred");
						set(fortify_dwall_tmp.derred,"angle",90);
					end;
				end;
			</Effect>	
		</Event>
	</Region>
	
	<NPC refname="Derred">
		<Topic name="start_scene1" start_option="Windklaue sprechen">
			<Condition>
				return (tutorial.finished == true and fortify_dwall.scene1 ~= true)
			</Condition>
			<Effect>
				insertTrigger("start_scene1");
				speak("Derred",_("Folgt uns bitte."));
			</Effect>
		</Topic>
	</NPC>
	
	<NPC refname="Tolec">
		<Topic name="start_scene1" start_option="Windklaue sprechen">
			<Condition>
				return (tutorial.finished == true and fortify_dwall.scene1 ~= true)
			</Condition>
			<Effect>
				insertTrigger("start_scene1");
				speak("Tolec",_("Folgt uns bitte."));
			</Effect>
		</Topic>
	</NPC>
	
	<Region name="elCnlLobby">
		<Event trigger="start_scene1" once="true">
			<Effect>
				setCutsceneMode(true);
				
				local door = getObjectByNameRef("doorScene1");
				door_setopen(door,true);
				addCameraPosition(0,get(door,"position"), -90,60, 20);
				addCameraPosition(4000,get(door,"position"), -90,60, 20);
				addCameraPosition(5000,"locWay4", -90,60, 20);
				
				startTimer("guard_scene1_walk1",2000);
				startTimer("players_scene1_walk1",3000);
				startTimer("guard_scene1_walk2",9000);
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk1" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locWay3");
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locWay4");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locWay4");
				fortify_dwall_tmp.tgoal = "locWay4";
				fortify_dwall_tmp.dgoal = "locWay4";
				
			</Effect>
		</Event>
		
		<Event trigger="players_scene1_walk1" once="true">
			<Effect>
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					addUnitCommand(player,"walk","locWay3");
					addUnitCommand(player,"walk","locWay4");
				end;
				startTimer("startNagging",700);
			</Effect>
		</Event>
		
		<Event trigger="startNagging" once="true">
			<Effect>
				fortify_dwall_tmp.leader = getRolePlayer("leader");
				local nonPrefs = {};
				nonPrefs[fortify_dwall_tmp.leader]=true;
				fortify_dwall_tmp.mage = getRolePlayerNonPref("magopt", getPlayers(), nonPrefs);
				nonPrefs[fortify_dwall_tmp.mage]=true;
				fortify_dwall_tmp.warrior = getRolePlayerNonPref("waropt", getPlayers(), nonPrefs);
				print("started nagging")
				print(fortify_dwall_tmp.leader)
				print(fortify_dwall_tmp.warrior)
				print(fortify_dwall_tmp.mage)
				unitSpeak(fortify_dwall_tmp.leader, _("Dieses Konzil ist auch nicht so besonders..."),"bored");
				if(fortify_dwall_tmp.mage ~= fortify_dwall_tmp.warrior)then
					startTimer("continueNagging",1500);
				end;
			</Effect>
		</Event>
		<Event trigger="continueNagging" once="true">
			<Effect>
				unitSpeak(fortify_dwall_tmp.warrior, _("Na klar! Jetzt hast du wieder eine große Klappe."),"unhappy");
				startTimer("mageTeasing",1500);
			</Effect>
		</Event>
		<Event trigger="mageTeasing" once="true">
			<Effect>
				unitSpeak(fortify_dwall_tmp.mage, _("Warum gebe ich mich doch gleich mit deiner Gesellschaft ab?"),"grin");
				if((fortify_dwall_tmp.mage ~= fortify_dwall_tmp.leader) and (fortify_dwall_tmp.warrior~= fortify_dwall_tmp.leader))then
					startTimer("leaderIntervene",1500);
				end;
			</Effect>
		</Event>
		<Event trigger="leaderIntervene" once="true">
			<Effect>
				unitSpeak(fortify_dwall_tmp.leader, _("Scht! Streiten könnt ihr euch später."),"unhappy");
			</Effect>
		</Event>

		
		<Event trigger="command_complete">
			<Condition>
				return (trigger.unit ==fortify_dwall_tmp.tolec and fortify_dwall_tmp.tgoal ~= nil and trigger.success == false)
			</Condition>
			<Effect>
				moveObject(trigger.unit,fortify_dwall_tmp.tgoal);
				fortify_dwall_tmp.tgoal = nil;
			</Effect>
		</Event>
		
		<Event trigger="command_complete">
			<Condition>
				return (trigger.unit ==fortify_dwall_tmp.derred and fortify_dwall_tmp.dgoal ~= nil and trigger.success == false)
			</Condition>
			<Effect>
				moveObject(trigger.unit,fortify_dwall_tmp.dgoal);
				fortify_dwall_tmp.dgoal = nil;
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk2" once="true">
			<Effect>
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.tolec,"Tolec");
				
				speak("Tolec",_("Endlich sind wir da!"),"excited");
				executeInDialog("insertTrigger('guard_scene1_walk3')");
				if(solo())then
					speak("any",_("(Der Raum da fuehlt sich gar nicht gut an.)"),"fear")
				else
					speak("any",_("Spürt ihr das?!! Das fühlt sich an wie-"),"panic");
					if (getSpeaker("leader") ~= getSpeaker("any")) then
						speak("leader",_("Scht!"),"unhappy");
					end;
				end;
				
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk3" once="true">
			<Effect>
				local door = getObjectByNameRef("doorSorenSouth");
				door_setopen(door,true);
				startTimer("guard_scene1_walk4",2000);
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk4" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locMerc2");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locMerc1");
				fortify_dwall_tmp.tgoal = "locMerc2";
				fortify_dwall_tmp.dgoal = "locMerc1";
				
				addCameraPosition(5000,"locParty", -90,60, 20);
				startTimer("guard_scene1_walk5",7000);
			</Effect>
		</Event>
		
		<Event trigger="guard_scene1_walk5" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locGuard3");
				fortify_dwall_tmp.tgoal = nil;
				assembleParty("elCnlLobby","locWay4");
				startTimer("scene1_intro",2000);
			</Effect>
		</Event>
		<Event trigger="scene1_intro" once="true">
			<Effect>
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.tolec,"Tolec");
				addSpeaker(fortify_dwall_tmp.derred,"Derred");
				addSpeaker(fortify_dwall_tmp.soren,"Soren Windclaw");
				
				speak("Derred",_("Mein Lord! Die... Gezeichneten sind jetzt da."));
				speak("Soren Windclaw",_("Sehr gut."));
				executeInDialog("insertTrigger('scene1_tback')");
				speakPause(3000);
				if (solo()) then
					speak("Tolec",_("Er erwartet dich jetzt"));
				else
					speak("Tolec",_("Er erwartet euch jetzt"));
				end;
				executeInDialog("insertTrigger('enter_soren_room')");

			</Effect>
		</Event>
		
		<Event trigger="scene1_tback" once="true">
			<Effect>
				local door = getObjectByNameRef("doorSorenSouth");
				addUnitCommand(fortify_dwall_tmp.tolec,"walk",get(door,"position"),1);
				addCameraPosition(3000,"locWay4", -90,60, 20);
			</Effect>
		</Event>
		
		
		<Event trigger="enter_soren_room" once="true">
			<Effect>
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					addUnitCommand(player,"walk","locParty");
				end;
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locMerc2");
				addCameraPosition(3000,"locSorenWindclaw", -90,60, 20);
				startTimer("scene1_assemble",4000);
			</Effect>
		</Event>
		
		
		<Event trigger="scene1_assemble" once="true">
			<Effect>
				assembleParty("elCnlLobby","locParty","locSorenWindclaw");
				fortify_dwall_tmp.assemble = "scene1";
			</Effect>
		</Event>
		
		<Event trigger="guards_out" once="true">
			<Effect>
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locGuardsAway");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locGuardsAway");
				addUnitCommand(fortify_dwall_tmp.tolec,"walk","locGuard1");
				addUnitCommand(fortify_dwall_tmp.derred,"walk","locGuard1");
				
				local door = getObjectByNameRef("doorSorenSouth");
				door_setopen(door,false);
				scriptobjectvar[door]["locked"] = true;
			</Effect>
		</Event>
		
		<Event trigger="unit_moved" >
			<Condition>
				return ((trigger.unit == fortify_dwall_tmp.tolec or trigger.unit == fortify_dwall_tmp.derred) and unitIsInArea(trigger.unit,"areaGuardAway"))
			</Condition>	
			<Effect>
				timedExecute("deleteObject("..trigger.unit..")",100);
			</Effect>
		</Event>
		
		<Event trigger="turn_soren" once="true">
			<Effect>
				timedExecute("set(fortify_dwall_tmp.soren,'angle',-45)",0);
				timedExecute("set(fortify_dwall_tmp.soren,'angle',0)",300);
				timedExecute("set(fortify_dwall_tmp.soren,'angle',45)",600);
				timedExecute("set(fortify_dwall_tmp.soren,'angle',90)",900);
			</Effect>
		</Event>
		
		<Event trigger="party_complete" once="true">
			<Condition>
				return (fortify_dwall_tmp.assemble == "scene1");
			</Condition>
			<Effect>
				fortify_dwall_tmp.assemble = nil;
				groupObjectsArc(getPlayers(),"locParty","locSorenWindclaw",nil,45);
				
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.tolec,"Tolec",true);
				addSpeaker(fortify_dwall_tmp.derred,"Derred",true);
				addSpeaker(fortify_dwall_tmp.soren,"Soren",true);
				
				addCameraPosition(3000,"locCamera", -90,60, 30);
				
				local magopt = getSpeaker("magopt");
				
				speak("Soren",_("Eure Anwesenheit ist nicht laenger von Noeten."),"aloof");
				speak("Tolec",_("Aber mein Lord, das sind-"),"surprised");
				executeInDialog("insertTrigger('turn_soren')");
				speak("Soren",_("..."),"threaten",2500);
				speak("Tolec",_("Wie ihr es wuenscht, verzeiht bitte."),"fear");
				speak("Derred",_("Jetzt komm schon, der weiß was er tut."),"fear");
				
				executeInDialog("insertTrigger('guards_out')");
				
				speak("magopt",_("Nette Huette!"),"sneer");
				speak("waropt",_("Naja, etwas unordentlich…"),"thoughtful");
				speak("waropt",_("...um nicht zu sagen: schleimig."),"grin");
				speak("priest",_("Diese Ritualgegenstände haben auch schon bessere Zeiten gesehen."));
				if(solo())then
					speak("Soren",_("Ja, sie haben mich gewarnt, dass Ihr schwierig seid. _solo"));
				else
					speak("Soren",_("Ja, sie haben mich gewarnt, dass ihr schwierig seid."));
				end;
				speak("waropt",_("Schwierig?"),"surprised");
				if(solo())then
					speak("waropt",_('Da gebe ich mir solche Mühe und alles was dabei raus kommt ist "schwierig".'),"offended");
				elseif(getSpeaker("waropt")~=getSpeaker("magopt"))then
					speak("waropt",_('Da gibst du dir solche Mühe und alles was dabei raus kommt ist "schwierig".'),"sneer");
					speak("magopt",_("Pft. Ich hätte große Lust den Laden abzufackeln."),"unhappy");
				else
					speak("magopt",_("Ich hätte große Lust den Laden abzufackeln."),"unhappy");
				end;
				local magopt = getSpeaker("magopt");
				if (magopt ~= getSpeaker("any")) then
					speak("any",_("Bei den ganzen Waschlappen hier ist das doch kaum der Mühe wert."),"amused");
					if(getSpeaker("any")==getSpeaker("leader"))then
						speak("leader",_("Andererseits..."),"thoughtful",2000);
					end;
					speak("leader",_("Wenn noch mehr von Riesendinger frei kommen könnte das ein paar Schwierigkeiten machen..."));
					speak("arcopt",_("Und die Chance ist recht hoch... die Monster hier haben schließlich alle ihren eigenen Kopf."),"grin");
					speak("priest",_("Ich kenn da einen netten kleinen Bannspruch..."));
				end;
				if(solo())then
					speak("Soren",_("Wuerdet Ihr bitte kurz auf diesen Kristall sehen. _solo"),"bored");
				else
					speak("Soren",_("Wuerdet ihr bitte kurz auf diesen Kristall sehen."),"bored");
				end;
				-- Er haelt einen Kristall in die Luft. Die Gruppe verstummt sofort und
				-- dreht sich in Richtung des Gegenstandes.
				
				speak("any",_("Ist das etwa ein... ?"),"fear");
				speak("Soren",_("Ganz recht."),"grin");
				speak("Soren",_("Es handelt sich um einen Kristall aus dem Herzen von Harads Hoelle."));
				speak("PL",_("Wie kann es sein, dass ihr noch am Leben seid?"),"surprised");
				speak("Soren",_("In der Tat die richtige Frage."),"grin");
				if(solo())then
					speak("Soren",_("Mit einer Antwort, die Euch von euren Leiden befreien wird."));
				else
					speak("Soren",_("Mit einer Antwort, die euch alle von euren Leiden befreien wird."));
				end;
				speak("Soren",_("Aber bevor ich sie euch gebe, muesst ihr jedoch zuerst etwas für mich tun."));
				speak("any",_("Moege Harad dich verfluchen!"),"angry");
				speak("Soren",_("Ts Ts. Wie unhoeflich den Namen des Verfluchten in Akerans Hallen zu verwenden."),"unhappy");
				speak("leader",_("Das ist eine verdammte Raeuberhoehle."),"threaten");
				speak("Soren",_("Euch entgeht der eigentliche Punkt."),"bored");
				speak("Soren",_("Ihr solltet begreifen, dass es ganz an euch liegt, wie lange ihr unter der vollkommenen Knechtschaft des Totengottes stehen werdet."),"threaten");
				speak("Soren",_("Erfuellt ihr meinen Auftrag zur Zufriedenheit Akerans und des Konzils, habe ich die Macht euch aus seine Klauen zu befreien."), "normal");
				speak("Soren",_("Für immer."),"bored");
				speak("Soren",_("If not, however..."),"threaten");
				if(solo())then
					speak("leader",_("Hab ich schon tausend Mal gehoert. Spar dir die Rede."),"bored");
				else
					speak("leader",_("Das kennen wir schon, also spart dir die langen Reden."),"bored");
				end;
				if (getSpeaker("leader") ~= getSpeaker("any")) then
					insertInDialog("getSpeaker('any'), _('Was?!! Der Fluch kann von uns genommen werden? Warum hoere ich das erst jetzt?'),'surprised');")
				end;
				speak("Soren",_("Wie ihr es wuenscht."),"grin");
				speak("Soren",_("Doch ich sollte euch warnen, der Auftrag ist recht gefaehrlich und ihr werdet wahrscheinlich mehr als einmal sterben."));
				speak("PL",_("Der Fluch von Harad muss ja irgend einen Vorteil haben."),"normal");
				speak("waropt",_("Bis auf die Schmerzen..."),"sad");
				if (getSpeaker("waropt") ~= getSpeaker("magopt")) then
					speak("magopt",_("Selbst hier musst du noch jammern."),"sneer");
				end;
				if (not solo()) then
					speak("Soren",_("Ihr seid in der Tat ein Haufen schwieriger Gestalten."));
				else
					speak("Soren",_("Ihr seid in der Tat eine schwierige Gestalt"));
				end;
				speak("magopt",_("Langsam macht er mich wuetend"),"angry");
				if (getSpeaker("priest") ~= getSpeaker("magopt")) then
					speak("priest",_("Friede!"));
				end;
				if(solo())then
					speak("Soren",_("Armselige Gestalt!"),"angry");
					speak("Soren",_("Zuerst muesst Ihr ganz offensichtlich Manieren lernen. _solo"),"threaten");
				else
					speak("Soren",_("Armselige Gestalten!"),"angry");
					speak("Soren",_("Zuerst muesst ihr ganz offensichtlich Manieren lernen."),"threaten");
				end;
				speak("Soren",_("Betrachtet es einfach als kleine Gefaelligkeit:"),"aloof");
				speak("Soren",_("Vor eurem eigentlichen Auftrag geht ihr als Verstaerkung nach Zwergentrutz."));
				speak("Soren",_("Zeigt den Untoten dort, wer tatsaechlich der Liebling des Totengottes ist."));
				speak("PL",_("Das schmeckt wie Ausbeutung."),"unhappy");
				speak("priopt",_("Außerdem folgen Nekromanten nicht Harad."),"thoughtful");
				if (getSpeaker("PL") ~= getSpeaker("any")) then
					speak("any",_("Unter allen miesen Ratten, für die ich schon die Kastanien aus dem Feuer geholt habe"),"unhappy");
					speak("any",_("rangiert dieser Robenwicht ziemlich weit an der Spitze."),"unhappy");
					if (getSpeaker("waropt") ~= getSpeaker("any")) then
						speak("waropt",_("Ich verstehe auch nicht, warum wir hier nach seiner Pfeife tanzen. Er ist doch schließlich-"),"threaten");
						speak("any",_("Nur ein Mensch!!"),"warcry");
					end;
				end;
				
				speak("Soren",_("Ihr verkennt ganz offensichtlich eure Position."),"aloof");
				speak("Soren",_("Was denkt ihr wohl, was geschieht, wenn ihr in dieser Stadt erkannt werdet?"));
				speak("Soren",_("Wir wissen alles ueber eure akeranverfluchte Art und niemand waere dumm genug, euch zu toeten, dass koennt ihr mir glauben."),"threaten");
				
				setTopicBase("Soren Windclaw");
				addQuestion(_("Weiterhin patzig sein?"));
				addAnswer(_("Yes"),"be_unkind");
				addAnswer(_("No"),"be_kind");
			</Effect>
		</Event>

	</Region>
	
	
		
	<NPC refname="Soren Windclaw">
		<Topic name="be_unkind">
			<Effect>
				speak("PL",_("Ihr haltet euch wohl für besonders mächtig und gerissen?"),"angry");
				if (not solo()) then
					speak("magopt",_("Sicherlich hat er sein Wissen hier irgendwo aufgeschrieben."),"thoughtful");
					speak("magopt",_("Wir koennen danach suchen, sobald er tot ist."));
					if (getSpeaker("magopt") ~= getSpeaker("waropt")) then
						speak("waropt",_("Eine guenstige Gelegenheit. In der Tat."),"grin");
					end;
				else
					speak("leader",_("Sicherlich hast du dein Wissen hier irgendwo aufgeschrieben."),"thoughtful");
					speak("leader",_("Ich kann auch nach deinem vorzeitigen Tod danach suchen."));
				end;
				speak("Soren",_("Ja, sie haben mich auch davor gewarnt, dass so etwas geschehen koennte."));
				
				-- Er beschwoert einen kleinen Feuerelementar vor sich und haelt einen
				-- weiteren Kristall in die Luft.
				
				speak("Soren",_("Mit diesem Kristall werde ich euch im Auge behalten und Anweisungen erteilen."));
				speak("Soren",_("Dieser einfache Elementar wird euch jetzt daran erinnern, dass Unsterblichkeit an diesem Ort wenig bedeutet."));
				executeInDialog("insertTrigger('fire_elemental')");
			</Effect>
		</Topic>
		
		<Topic name="be_kind">
			<Effect>
				speak("PL",_("Natuerlich."));
				speak("PL",_("Wenn unsere Freiheit die Belohnung ist, werden wir alles in unserer Macht stehende tun, um erfolgreich zu sein."));
				speak("waropt",_("Das gefaellt mir nicht."));
				speak("Soren",_("Nun gut."));
				speak("Soren",_("Ich muss mich jetzt um die Vorbereitungen für die bevorstehende Heirat des Prinzen kuemmern."));
				speak("Soren",_("Es ist keine Zeit für weitere Erklaerungen."));
				speak("Soren",_("Nehmt etwas Gold und diesen Kristall."));
				speak("Soren",_("Darueber werde ich euch zur rechten Zeit weitere Instruktionen senden. "));
				
				-- Jeder der Gruppe erhält 200 GM. Anschließend verlassen sie den Saal.
				local players = getPlayers();
				local i,player;
				for i,player in ipairs(players) do
					if (getPlayerPrivateVar(player,"fortify_dwall_startpay") ~= true) then
						setPlayerPrivateVar(player,"fortify_dwall_startpay",true);
						setObjectValue(player,"gold", getObjectValue(player,"gold") + 200);
					end;
				end;
				
				executeInDialog("setCutsceneMode(false)");
				executeInDialog("insertTrigger('teleport_out')");
			</Effect>
		</Topic>
	</NPC>
	
	
	<Region name="elCnlLobby">
		<Event trigger="fire_elemental" once="true">
			<Effect>
				setCutsceneMode(false);
				fortify_dwall_tmp.elemental = createObject("fireElemS","locElemental");
				fortify_dwall_tmp.playernr = table.getn(getPlayers());
				fortify_dwall_tmp.inactive_pl = {};
				fortify_dwall_tmp.inactive_pl_nr = 0;
				fortify_dwall_tmp.inactive_pl_wall = {};
				fortify_dwall_tmp.fwall1 = createObject("blockFireWall","locFireWallEast",-45);
				fortify_dwall_tmp.fwall2 = createObject("blockFireWall","locFireWallWest",45);
			</Effect>
		</Event>
		
		<Event trigger="player_moved" once="true">
			<Condition>
				if (fortify_dwall.scene1 ~= true) then
					return (unitIsInArea(trigger.player,"SorenWindclawArea"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				createDialogue();
				addSpeaker(soren_windclaw,"Soren");
				addSpeaker(fortify_dwall_tmp.guard1,"Tolec");
				addSpeaker(fortify_dwall_tmp.guard2,"Derred");

				addSpeaker(trigger.player,"Player");
				addStandardSpeakers("elCnlLobby","locParty");
				setCutsceneMode(true);
				setTopicBase("Soren Windclaw");
				changeTopic("scene1_dialogue");
			</Effect>
		</Event>
		
		<Event trigger ="unit_die">
			<Condition>
				return (fortify_dwall_tmp.elemental ~= nil and get(trigger.unit,"type") == "PLAYER");
			</Condition>
			<Effect>
				fortify_dwall_tmp.inactive_pl_nr = fortify_dwall_tmp.inactive_pl_nr+1;
				
				set(trigger.unit,"health",1);
				set(trigger.unit,"state","inactive");
				fortify_dwall_tmp.inactive_pl[fortify_dwall_tmp.inactive_pl_nr] = trigger.unit;
				local pos = get(trigger.unit,"position");
				fortify_dwall_tmp.inactive_pl_wall[fortify_dwall_tmp.inactive_pl_nr] = createObject("fireCage",pos);
				
				fortify_dwall_tmp.playernr = fortify_dwall_tmp.playernr-1;
				if (fortify_dwall_tmp.playernr == 0) then
					startTimer("remove_fire_walls",1000);
					startTimer("reactivate_player",2000);
				end;
			</Effect>	
		</Event>
		
		<Event trigger ="unit_die" once="true" >
			<Condition>
				return (trigger.unit == fortify_dwall_tmp.elemental);
			</Condition>
			<Effect>
				fortify_dwall_tmp.elemental = nil
				startTimer("remove_fire_walls",1000);
				startTimer("reactivate_player",2000);
			</Effect>
		</Event>
		
		<Event trigger ="remove_fire_walls" once="true" >
			<Effect>
				local i;
				for i=1,fortify_dwall_tmp.inactive_pl_nr do
					deleteObject(fortify_dwall_tmp.inactive_pl_wall[i]);
				end;
				deleteObject(fortify_dwall_tmp.fwall1);
				deleteObject(fortify_dwall_tmp.fwall2);
			</Effect>
		</Event>
		
		<Event trigger ="reactivate_player" once="true" >
			<Effect>
				local i;
				for i=1,fortify_dwall_tmp.inactive_pl_nr do
					set(fortify_dwall_tmp.inactive_pl[i],"state","active");
					fullHeal(fortify_dwall_tmp.inactive_pl[i]);
				end;
				
				if (fortify_dwall_tmp.elemental ~= nil) then
					deleteObject(fortify_dwall_tmp.elemental);
					fortify_dwall_tmp.elemental = nil;
					startTimer("elemental_end",2000);
					fortify_dwall_tmp.elemental_defeat = false;
				else
					startTimer("elemental_end",1000);
					fortify_dwall_tmp.elemental_defeat = true;
				end
			</Effect>
		</Event>
		
		<Event trigger ="elemental_end" once="true" >
			<Effect>
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				
				addSpeaker(fortify_dwall_tmp.soren,"Soren",true);
				
				if (fortify_dwall_tmp.elemental_defeat) then
					speak("leader",_("Na bitte, das war doch eher zahm."),"injured2");
				end;
				
				speak("Soren",_("Das war der schwaechste Elementar, den ich beschwoeren konnte."),"angry");
				speak("Soren",_("Denkt immer daran."),"threaten");
				speak("Soren",_("Denkt immer daran."),"normal");
				speak("Soren",_("Nehmt etwas Gold und ruestet euch im Soeldnerlager noerdlich der Stadt."));
				speak("Soren",_("Dort findet ihr alles, was ihr braucht."));
				speak("archer",_("Alles?"),"surprise");
				setSpeakerEmotion("archer","normal");
				speak("Soren",_("Ich kann nicht länger meine Zeit verschwenden."),"bored");
				speak("Soren",_("Der Prinz wird bald heiraten und es gibt noch einige Vorbereitungen zu treffen."),"normal");
				speak("Soren",_("Ueber diesen Kristall werde ich mit euch in Verbindung bleiben."));
				speak("arcopt",_("Natuerlich."),"bored");
				if(solo())then
					speak("arcopt",_("Ist sicherlich nicht wirklich vom goettlichsten Akeran erlaubt meine Kampfkraft zu erpressen."),"sneer");
				else
					speak("arcopt",_("Ist sicherlich nicht wirklich vom goettlichsten Akeran erlaubt, unsere Kampfkraft zu erpressen."),"sneer");
				end;
				speak("Soren",_("Verschwindet endlich!"),"angry");
				
				executeInDialog("insertTrigger('teleport_out')");
			</Effect>
		</Event>
		
		<Event trigger ="teleport_out" once="true" >
			<Effect>
				assembleParty("medBackalley","entry_south","entry_north");
			</Effect>
		</Event>
	</Region>
	
	<!-- Kristall in der Hintergasse -->
	<Region name= "medBackalley">
		<Event trigger ="player_moved" once = "true">
			<Condition>
				return (unitIsInArea(trigger.player,"areaScene3")and(fortify_dwall.crystal~=true));
			</Condition>
			<Effect>
				assembleParty("medBackalley","locScene","locCrystal");
				fortify_dwall_tmp.assemble = "crystal";
			</Effect>
		</Event>
		<Event trigger="party_complete" once="true">
			<Condition>
				return (fortify_dwall_tmp.assemble == "crystal");
			</Condition>
			<Effect>
				fortify_dwall_tmp.assemble = nil;
				fortify_dwall_tmp.comCrystal = createObject("sorenCrystal","locCrystal");
				groupObjectsArc(getPlayers(),"locScene","locCrystal",nil,360);
				createDialogue();
				addAllPlayersToDialog();
				addStandardRoles();
				addSpeaker(fortify_dwall_tmp.comCrystal,"Soren",true);
				if(not solo())then
					local leader = getSpeaker("PL");
					local countermage;
					if(leader ~= getSpeaker("priopt"))then
						countermage = getSpeaker("priopt");
					elseif(leader~= getSpeaker("magopt"))then
						countermage = getSpeaker("magopt");
					else
						countermage = getPlayers()[2];
					end;
					addSpeaker(countermage,"countermage");
				end;
				local magopt = getSpeaker("magopt");
				local waropt = getSpeaker("waropt");
				local soren = fortify_dwall_tmp.comCrystal;
				
				if(solo())then
					speak("PL", _("(Dieser Windklaue ist irgendwie seltsam.)"),"thoughtful");
					speak("PL", _("(Er weiß zuviel. Und er hat einen echten Stein aus Harads Hoelle.)"));
					speak("PL", _("(Und dieser Kristall, den er mir untergejubelt hat...)"),"thoughtful");
					speak("PL", _("(Sieht aus wie ein Spionagekristall. Na, das werden wir gleich wissen.)"),"unhappy");
					speak("PL", _("Hm... ich werde einfach mal nach Feinden des Konzils Ausschau halten."),"thoughtful");
					speak("PL", _("Und danach mit ihnen diese Beschwoerer-Wichtel auseinander nehmen."),"amused");
					speak("PL", _("Das sollte nicht so schwer sein."),"grin");
					if(femaleOnly())then
						speak("Soren", _("Das glaubst auch nur du, Gezeichnete!"),"aloof");
					else
						speak("Soren", _("Das glaubst auch nur du, Gezeichneter!"),"aloof");
					end;
					speak("PL", _("...sprach der spionierende Lord Magister."),"sneer");
					speak("PL", _("Keine schoenen Angewohnheiten, die du da hast, Luftpfote..."));
					speak("Soren", _("Windklaue!"),"angry");
					speak("Soren", _("Und gewoehn dich besser daran, ueberwacht zu werden."),"unhappy");
					speak("Soren", _("Ich bin kein Idiot"),"grin");
					setSpeakerEmotion("Soren","normal")
					speak("PL", _("Aber allwissend bist du auch nicht."),"grin");
					speak("Soren", _("Und was willst du damit sagen?"),"aloof");
					speak("PL", _("Na ja... das Ding da ist von der Aisener Magiergilde hergestellt worden, oder etwa nicht?"),"grin");
					speak("Soren", _("Und?"),"bored");
					speak("PL", _("Bist ein Fachidiot, was?"),"unhappy");
					speak("PL", _("Avaera, die Göttin der Magie? Klingelts? Die Leute da sind alle recht fromm."),"normal");
					speak("PL", _("Die haben bestimmt Avaeras Segen auf den Kristall gesprochen, damit er viel besser funktioniert."),"normal");
					speak("Soren", _("Huete deine Zunge, Abschaum! Was bitte soll das aendern?"),"angry");
					speak("PL", _("Alles"),"excited",1500);
					speak("PL", _("Weißt du, was passiert, wenn das mit dem Blut von Gezeichneten in Beruehrung kommt?"),"sneer");
					speak("Soren", _("Es ist nicht so, als hätte ich besondes viele von euch Verfluchten zu experimentellen Zwecken hier."),"unhappy");
					setSpeakerAnimation("Soren", "blindness", 1000);
					speakPause(1000);
					removeSpeaker(soren);
					if(femaleOnly())then
						executeInDialog('unitSpeak('..soren..', _("Mach das sofort rueckgaengig, oder jede Wache in Aisen wird hinter dir her sein, Verfluchte!"),"threaten")');
					else
						executeInDialog('unitSpeak('..soren..', _("Mach das sofort rueckgaengig, oder jede Wache in Aisen wird hinter dir her sein, Verfluchter!"),"threaten")');
					end;
					speak("PL", _("Sicher, sicher."),"grin");
					speak("PL", _("Die werden auch sehr interessiert sein, wo ich hergekommen bin."),"sneer");
					if(femaleOnly())then
						speak("PL", _("Und das heißt Gezeichnete."),"unhappy");
					else
						speak("PL", _("Und das heißt Gezeichneter."),"unhappy");
					end;
						executeInDialog('unitSpeak('..soren..', _("Du bist besser bereit, die Konsequenzen zu tragen, elende Kreatur."),"angry")');
					speak("PL", _("Blind und Taub, aber nicht stumm, wie?"),"thoughtful");
					speak("PL", _("Das wird eine echt anstrengende Reise, wenn das so weitergeht..."),"unhappy");
					speak("PL", _("Beruhige dich, Herr der unangenehemen Luefte!"),"normal");
					speak("PL", _("Ich kann dich hoeren und wir koennen reden, wenn es sein muss"));
					speak("PL", _("Das reicht doch, oder?"),"unhappy");
					speak("archer", _("So viel Geld, als das ich mich von dir die ganze Zeit anstarren lasse, kannst du gar nicht haben."),"grin");
					speak("mage", _("Bete lieber zu deinem Akeran, dass ich nie einen Weg finde, einen Feuerball durch das Ding zu schicken."),"threaten");
					speak("priest", _("Tja ja... Wissen über die Götter ist Macht, wenn man ihren Launen ausgesetzt ist."),"amused");
					speak("warrior", _("Sei lieber froh, dass ich nicht gleich den ganzen Kristall zerschmettert habe."),"unhappy");
					addSpeaker(fortify_dwall_tmp.comCrystal,"Soren",true);
					speak("Soren", _("Erlaube dir noch eine solche Unverschaemtheit und ich werde dich in den Hungerturm sperren lassen!"),"threaten");
					speak("PL", _("Was soll ich nur mit diesen Konzilikern machen?"),"unhappy");
				else
					lookAtObject(leader,countermage);
					setSpeakerPosition("PL","upper_right");
					speak("PL",_("Koennen wir diesen Kristall irgendwie blind machen?"));
					speak("PL",_("Bestimmt sitzt der Kerl gerade in einem gemuetlichen Sessel und passt auf, dass wir nicht aus der Reihe tanzen."),"unhappy");
					speak("PL",_("Ich hab so was schon mal in der Armee gesehen..."), "thoughtful");
					speak("countermage",_("Aber ja. Ich kenne da einen netten kleinen Trick."),"grin");
					speak("Soren",_("Wagt es ja nicht, oder-"),"threaten",1500);
					setSpeakerAnimation("Soren", "blindness", 1000);
					speakPause(1000);
					--TODO Haende abklopfen
					speak("countermage",_("So, das wars."),"happy");
					speak("PL",_("Und jetzt kann er uns nicht mehr hoeren?"),"normal");
					speak("countermage",_("Nur, wenn wir es wollen. Unser Blut wirkt bei gesegneten Gegenstaenden einfach Wunder."),"amused");
					speak("countermage",_("Gut, dass das da von frommen aisener Magiern Avaera gesegnet wurde. Auch wenn die Götting der Magie nicht erfreut ueber meinen Zusatz sein duerfte."),"amused");
					speak("countermage",_("Nerven kann der gute Soren aber immer noch."),"normal");
					speak("countermage",_("Wir bekommen es auf jeden Fall mit, wenn er uns etwas sagen will."),"unhappy");
					speak("PL",_("Sehr gut."),"happy");
					if(duo())then
						speak("PL",_("Also, was haeltst du von dieser Sache?"),"normal");
					else
						speak("PL",_("Also, was haltet ihr von dieser Sache?"),"normal");
					end;
					local list = {};
					list[getSpeaker("waropt")]=true;
					local hopeful = getRolePlayer("any", listToSet(getPlayers()),list);
					addSpeaker(hopeful,"any_hope");
					speak("any_hope", _("Habe ich das richtig verstanden?"),"surprised");
					speak("any_hope", _("Hat er wirklich die Macht, uns von Harads Fluch zu befreien?"),"normal");
					speak("waropt",_("Gesagt hat er es."),"thoughtful");
					speak("waropt",_("Ich habe jedenfalls noch nie gehoert, dass jemand außer uns irgend etwas aus der Hoelle mitnehmen konnte."),"unhappy");
					speak("magopt",_("Aber das Ding war ohne Zweifel echt."),"fear")
					speak("magopt",_("Allein durch den Anblick standen mir alle Haare zu Berge."),"sad");
					setSpeakerEmotion("magopt", "normal");
					if(magopt~=waropt)then
						speak("waropt",_("Fast in Ohnmacht gefallen bist du!"),"amused");
					end;
					speak("priopt",_("Er hat uns die Freiheit versprochen."),"thoughtful");
					setSpeakerEmotion("magopt", "sad");
					speak("priopt",_("Ich habe nicht mal mehr Erinnerungen daran..."),"sad");
					speak("any",_("Trotzdem ist es unwahrscheinlich, dass er sein Wort halten wird."),"unhappy");
					speak("any",_("Selbst wenn er tatsaechlich diese Macht besitzen sollte, sind wir fuer seine Zwecke viel zu wertvoll."),"normal");
					speak("any",_("Wir sind wahrlich gezeichnet."),"sad");
					speak("waropt",_("Aber auch wenn es nur eine kleine Moeglichkeit gibt, ich bin bereit, es zu versuchen."),"offended");
					if(magopt~=waropt)then
						speak("magopt",_("Wenn Dummheit ein Gewicht haette, koenntest du dich nicht einen Millimeter von der Stelle bewegen."),"unhappy");
						speak("waropt",_("Wenn Arroganz einen Geruch haette, wuerdest du augenblicklich ersticken."),"unhappy");	
					end;
					speak("PL",_("Also gut, wir stimmen ab, wie wir weiter vorgehen."),"normal");
				end;
				setTopicBase("Soren Windclaw");
				addQuestion(_("Den Anweisungen des Konzils folgen?"));
				addAnswer(_("Ja"),'work_for_council');
				addAnswer(_("Nein"),'dont_work_for_council');
			</Effect>
		</Event>
	</Region>
	<NPC refname="Soren Windclaw">
	<Topic name="work_for_council">
			<Effect>
				if(solo())then
					speak("PL",_("Ich werde erst mal sehen, wie sich die Sache entwickelt."),"thoughtful");
					speak("PL",_("Bis die Karten alle auf dem Tisch liegen bin ich wieder maechtig genug, um mir notfalls auch mit Gewalt zu holen, was mir zusteht."),"normal");
				else
					speak("PL",_("Dann ist es entschieden."),"normal");
					speak("PL",_("Wehe die halten ihr Versprechen nicht."),"threaten");
				end;
				deleteObject(fortify_dwall_tmp.comCrystal)
			</Effect>
		</Topic>
		<Topic name="dont_work_for_council">
			<Effect>
				if(solo())then
					speak("PL",_("Der Kerl wird sein Versprechen nie im Leben halten."),"unhappy");
					speak("PL",_("Aber in meinem jetzigen Zustand kann ich mich schlecht mit einem ganzen Koenigreich anlegen."),"thoughtful");
					speak("PL",_("Mache ich also gute Miene zum boesen Spiel und gewinne sein Vertrauen."),"amused");
					speak("PL",_("Mal sehen, was sich so an Gelegenheiten ergibt."),"grin");
				else
					speak("PL",_("Die ganze Sache ist wirklich zu unsicher."),"unhappy");
					speak("PL",_("Offenen Widerstand koennen wir uns aber noch nicht leisten, also muessen wir gute Miene zum boesen Spiel machen."),"thoughtful");
					speak("PL",_("Gewinnen wir ihr Vertrauen."),"unhappy");
				end;
				deleteObject(fortify_dwall_tmp.comCrystal)
				fortify_dwall.crystal=true;
			</Effect>
		</Topic>
	</NPC>
</Quest>

