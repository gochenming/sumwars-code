<Quest name="Defend dwarfenwall" table_name="defend_dwall">
	<Description>
		if (defend_dwall.finished) then
			return _("Quest finished")
		else
			return _("Quest description")
		end
	</Description>
	
	<Region name="dwarfenwallCommand">
		<Event trigger="create_region" once="true">
			<Condition>
				return (defend_dwall.briefingFinished ~= true)
			</Condition>
			<Effect>
				setCutsceneMode(true);
				addCameraPosition(0,"locCamera",-90,55,14);
				defend_dwall_tmp.position="command";
				assembleParty("dwarfenwallCommand", entry_south);
				lookAtEachOther(dwarfenwall.general,dwarfenwall.council);
			</Effect>
		</Event>
		
		<Event trigger="party_complete" once="true">
			<Condition>
				return (defend_dwall_tmp.position=="command")
			</Condition>
			<Effect>
				initDialog();
				
				addSpeaker(dwarfenwall.general, "general");
				addSpeaker(dwarfenwall.council, "council");
				
				setSpeakerPosition("council","upper_left");
				speak("council",_("...haben meine Windelementare genau gesehen: Es ist nur dieser eine Lich, der sie fuehrt."),"thoughtful");
				speak("council",_("Wenn er erst mal weg ist, sind die anderen kein Problem."),"unhappy");
				speak("general",_("Wie großartig."),"amused");
				speak("general",_("Und mit welcher Armee wollt ihr ihre Reihen durchbrechen?"),"unhappy");
				speak("general",_("Wir muessen erst mal diesen Ansturm aufhalten, der sich da zusammenbraut."),"unhappy");
				speak("council",_("Keine Sorge."),"normal")
				speak("council",_("Mein Kollege hat mir versichert, dass das Konzil Unterstuetzung sendet."),"normal")
				speak("council",_("Sie muesste bald hier sein."),"normal")
				setSpeakerAnimation("general","angry",800);
				speak("general",_("Erst beordern sie die Maga von Nordenburg ab und dann senden sie wieder Verstaerkung?"),"angry");
				speak("general",_("Was ist das für ein Spiel?"),"unhappy");
				speak("council",_("Die Maga wird an anderer Stelle dringender benoetigt als bei uns."),"aloof");
				speak("general",_("Aber natuerlich!"),"sneer");
				speak("general",_("Auch wenn ich das nur ungern sage, aber bis eine Armee den Weg hier her geschafft hat, kaempfen unsere Koerper laengst für die andere Seite, verehrte Dame!"),"unhappy");
				changeTopic("entryParty");
			</Effect>
		</Event>
		
		<Event trigger="entryParty">
			<Effect>
				addUnitCommand(getPartyleader(),"walk","locLeader");
				addCameraPosition(1500,"locCamera",-90,60,20);
				speak("PL",_("Verzeiht wenn ich mich so einfach einmische, aber kleine Gruppen reisen erheblich schneller als ein Heerzug."),"normal");
				executeInDialog('lookAtObject('..dwarfenwall.general..','..getSpeaker("PL")..')');
				if(solo())then
					speak("general",_("Und wer seid Ihr? _solo"),"threaten");
				else
					speak("general",_("Und wer seid ihr?"),"threaten");
				end;
				speak("PL",_("Die Verstaerkung"),"amused");
				
				setSpeakerEmotion("general","happy");
				setSpeakerAnimation("general","laugh",800);
				setSpeakerEmotion("PL","normal");
				speakPause(800);
				
				speak("general",_("Guter Witz."),"unhappy");
				speak("general",_("Aber wir sind hier im Krieg."),"unhappy");
				if(solo() and maleOnly())then
					speak("general",_("Macht, dass ihr davonkommt, ihr Narr."),"unhappy");
				elseif(solo())then
					speak("general",_("Macht, dass ihr davonkommt, ihr Naerrin."),"unhappy");
				else
					speak("general",_("Macht, dass ihr davonkommt, ihr Narren."),"unhappy");
				end;
				executeInDialog('lookAtObject('..dwarfenwall.general..','..dwarfenwall.council..')');
				
				if(isMale(getSpeaker("PL")))then
					speak("council",_("Dieser Soeldner sagt die Wahrheit."),"aloof");
				else
					speak("council",_("Diese Soeldnerin sagt die Wahrheit."),"aloof");
				end;
				
				speak("general",_("Was?!?"),"pain");
				executeInDialog('lookAtObject('..dwarfenwall.general..','..getSpeaker("PL")..')');
				setSpeakerAnimation("general","point",800);
				speakPause(800);
				setSpeakerAnimation("general","pointing",100,true);
				speak("general",_("Das soll eure grandiose Unterstützung sein?"),"angry");
				setSpeakerAnimation("general","angry",800);
				if(not solo())then
					speak("general",_("Eine Handvoll Soeldlinge?"),"offended");
				end;
				
				speak("council",_("Ihr werdet den Wert unserer Unterstuetzung schon noch erkennen, wenn sie wieder und wieder fuer euch faellt."),"aloof");
				speak("general",_("Was sagt ihr da?"),"unhappy");
				setSpeakerAnimation("general","think",1000);
				speakPause("1000");
				if(solo() and femaleOnly())then
					speak("general",_("... Ist das etwa eine Verfluchte?"),"pain");
				elseif(solo())then
					speak("general",_("... Ist das etwa ein Verfluchter?"),"pain");
				else
					speak("general",_("... Sind das etwa Verfluchte?"),"pain");
				end;
				setSpeakerAnimation("general","aloof");
				speak("any",_("Mir persoenlich gefaellt der Begriff Gezeichnete irgendwie besser."),"unhappy");
				
				setSpeakerEmotion("any","aloof");
				if(solo())then
					speak("PL",_("Wenn der Preis stimmt, lasse ich mich so oft in Stuecke hacken, wie es noetig ist, um diese Stadt zu verteidigen."),"aloof");
				else
					speak("PL",_("Wenn der Preis stimmt, lassen wir uns so oft in Stuecke hacken, wie es noetig ist, um diese Stadt zu verteidigen."),"aloof");
				end;
				
				executeInDialog('lookAtObject('..dwarfenwall.general..','..dwarfenwall.council..')');
				speak("general",_("Ihr lasst euch mit dem Teufel ein, um einen Teufel auszutreiben?"),"disgust");
				setSpeakerEmotion("general","aloof");
				
				speak("council",_("In Zeiten wie diesen kann man nicht besonders zimperlich benehmen."),"offended");
				speak("council",_("Wollt ihr leben oder den Untoten als Verstaerkung dienen?"),"threaten");
				
				speak("general",_("Man kann diesen Monstern nicht trauen!"),"angry");
				speak("general",_("Solange ich diese Armee fuehre, werde ich solche nicht dulden!"),"offended");
				setSpeakerEmotion("general","aloof");
				
				if(solo())then
					speak("PL",_("Ich habe gerade die Untoten daran gehindert, eure Stadt zu umgehen!"),"unhappy");
				else
					speak("PL",_("Wir haben gerade die Untoten daran gehindert, eure Stadt zu umgehen!"),"unhappy");
				end;
				speak("general",_("Das beweist gar nichts!"),"aloof");
				speak("mage",_("Alle Krieger verbindet die Engstirnigkeit."),"thoughtful");
				if(solo())then
					speak("warrior",_("Ich toete nicht wahllos!"),"angry");
				else
					speak("warrior",_("Wir toeten nicht wahllos!"),"angry");
				end;
				
				if(solo() and femaleOnly())then
					speak("council",_("Sie steht unter dem Befehls des Konzils, es ist nicht eure Entscheidung."),"aloof");
				elseif(solo())then
					speak("council",_("Er steht unter dem Befehls des Konzils, es ist nicht eure Entscheidung."),"aloof");
				else
					speak("council",_("Sie stehen unter dem Befehls des Konzils, es ist nicht eure Entscheidung."),"aloof");
				end;
				changeTopic("theChargeBegins");
			</Effect>
		</Event>
		
		<Event trigger="theChargeBegins">
			<Effect>
				--TODO: Hornsignal
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				defend_dwall_tmp.messanger = createObject("guard","exit_south");
				addSpeaker(defend_dwall_tmp.messanger,"guard");
				speak("guard",_("Sie kommen! Der Angriff beginnt!"),"panic");
				changeTopic("ordersForCharge");
			</Effect>
		</Event>
		<Event trigger="ordersForCharge">
			<Effect>
				--TODO: Hornsignal
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				addCameraPosition(100,"locGeneral",-90,60,20);
				addCameraPosition(100,"locCamera",-90,60,20);
				removeSpeaker("guard");
				deleteObject(defend_dwall_tmp.messanger);
				
				speak("general",_("..."),"angry",2000);
				speak("general",_("Seht zu, dass ihr zur Mauer kommt!"),"unhappy");
				speak("archer",_("Wie schnell er seine Meinung doch aendert."),"sneer");
				if(solo())then
					speak("PL",_("Ich bin schon unterwegs"),"normal");
				else
					speak("PL",_("Los jetzt!"),"normal");
				end;
				changeTopic("partyLeavesForBattle")
			</Effect>
		</Event>
		<Event trigger="partyLeavesForBattle">
			<Effect>
				addUnitCommand(getSpeaker("PL"),"walk","entry_south");
				speakPause(1000);
				speak("general",_("Ich hoffe, ihr habt genug Geld, um diese Brut bei der Stange zu halten."),"threaten");
				speak("council",_("Macht euch keine Sorgen."),"unhappy");
				speak("council",_("Daran wird es nicht scheitern."),"sneer");
				--TODO: Schwert nehmen und gehen
				speak("general",_("Ich bete, dass ihr Euch nicht irrt..."),"unhappy")
				executeInDialog('')
				changeTopic("briefingOver")
			</Effect>
		</Event>
		<Event trigger="briefingOver">
			<Effect>
				addUnitCommand(dwarfenwall.general,"walk","exit_south");
				fadeOut(2000);
				defend_dwall.briefingFinished = true;
				timedExecute('assembleParty("dwarfenwall","locPartyLeave")',2000);
				timedExecute('fadeIn(0,{0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3})',2000);
				timedExecute('setCutsceneMode(false)',2000);
			</Effect>
		</Event>
	</Region>

	<Region name="dwarfenwall">
		<Event trigger="enter_region" >
			<Condition>
				return (defend_dwall.finished~=true);
			</Condition>
			<Effect>
				insertTrigger("catapult");
			</Effect>
		</Event>
		<Event trigger="player_moved" >
			<Condition>
				return (unitIsInArea(trigger.player,"areaNoEntry1"))
			</Condition>
			<Effect>
				unitSpeak(dwarfenwall.guard3,_("Es tut mir Leid, aber hier ist nur Durchgang fuer Angehoerige der aisener Armee."));
				addUnitCommand(trigger.player,"walk","locWeaponTrader");
				startTimer("stopWalking",1000);
				addTriggerVariable("unit",trigger.player);
			</Effect>
		</Event>
		
		<Event trigger="player_moved" >
			<Condition>
				return (unitIsInArea(trigger.player,"areaNoEntry2"))
			</Condition>
			<Effect>
				unitSpeak(dwarfenwall.guard4,_("Es tut mir Leid, aber hier ist nur Durchgang fuer Angehoerige der aisener Armee."));
				addUnitCommand(trigger.player,"walk","locWeaponTrader");
				startTimer("stopWalking",1000);
				addTriggerVariable("unit",trigger.player);
			</Effect>
		</Event>
		<Event trigger="stopWalking" >
			<Effect>
				clearUnitCommands(trigger.unit);
			</Effect>
		</Event>
		
		<Event trigger="unit_moved" >
			<Condition>
				local sub = get(trigger.unit,"subtype");
				return((unitIsInArea(trigger.unit,"areaHealer"))and (sub=="aisen_healer"));
			</Condition>
			<Effect>
				timedExecute('deleteObject('..trigger.unit..')',100);
			</Effect>
		</Event>
		
		<Event trigger="unit_hit" >
			<Condition>
				--send healers to important units
				local u = trigger.defender;

				if(defend_dwall.finished ~=true)then
					return((u == dwarfenwall.guard1)or(u == dwarfenwall.guard2)or(u == dwarfenwall.guard3)or(u == dwarfenwall.guard4)or(u == dwarfenwall.sergeant)or(u == dwarfenwall.weapons)or(u == dwarfenwall.armors)or(u == dwarfenwall.potions)or(u == dwarfenwall.blackmarket)or(u == theTrader.theTraderDW));
				else
					return false;
				end;
			</Condition>
			<Effect>
				sendOutHealer(trigger.defender);
			</Effect>
		</Event>
		
		<Event trigger="catapult">
			<Condition>
				return (defend_dwall.siegeEnded~=true);
			</Condition>
			<Effect>
				--bombards dwarfenwall
				local nextShot = math.random(800,4000);
				startTimer("catapult",nextShot);
				
				local x = math.random(40,90);
				local y = math.random(40,90);
				--print("and the winner is: "..x.."/"..y);
				catapult({x,y});
			</Effect>
		</Event>
		
		<Event trigger="unit_die" >
			<Effect>
				--print("someone is now six feet under")
				--print(get(trigger.unit,"subtype"))
				local i = dwarfenwall.people[trigger.unit];
				--print(i);
				
				if(dwarfenwall.city[i]==nil)then
					--print("now in the section for unregistered victims")
				elseif(dwarfenwall.city[i]["important"]~=true)then
					local unit;
					
					if(dwarfenwall.city[i]["moving"]~=true)then
						--print("unit was a stationary peasant")
						local chain = dwarfenwall.city[i]["respawn"];
						
						for key,loc in pairs(chain) do
							if(key == 1)then
								unit = createObject("peasant",loc);
							else
								--print("new peasant walking to "..loc);
								addUnitCommand(unit,"walk",loc,2.5);
							end;
						end;
						
						addUnitCommand(unit,"walk",dwarfenwall.city[i]["location"],0.2);
					else
						--print("unit was a moving peasant")
						unit = createObject("peasant",dwarfenwall.city[i]["location"]);
						dwarfenwall.city[i]["phase"] = 1;
						insertTrigger("peasantNextPhase");
						addTriggerVariable("id",i);
					end;
					
					setRefName(unit,dwarfenwall.city[i]["refname"])
					dwarfenwall.people[unit]=dwarfenwall.people[trigger.unit];
					dwarfenwall.people[trigger.unit]=nil;
					dwarfenwall.city[i]["unit"]=unit;
				else
					print("the unit was important and was not replaced... the gods will punish you!")
				end;
			</Effect>
		</Event>
	
		<Event trigger="party_complete" once="true">
			<Condition>
				return(defend_dwall.briefingFinished==true and defend_dwall.siegeStarted~=true);
			</Condition>
			<Effect>
				--TODO: Wachen von General G, ein paar Soldaten
				dwarfenwall.combatGeneral = createObject("general_greif_battle","locGeneralSpwan");
				addUnitCommand(dwarfenwall.combatGeneral,"walk","exit_rampart");
			</Effect>
		</Event>
		<Event trigger="unit_moved" once="true">
			<Condition>
				if(trigger.unit==dwarfenwall.combatGeneral)then
					return(unitIsInArea(trigger.unit,"areaRampart"));
				else
					return false;
				end;
			</Condition>
			<Effect>
				deleteObject(dwarfenwall.combatGeneral);
			</Effect>
		</Event>
	</Region>
	
	<Region name="dwarfenwallRampart">
		<Event trigger="create_region">
			<Condition>
				debug["defend_dwall"] = false;
				return (defend_dwall.siegeEnded ~= true);
			</Condition>
			<Effect>
				--the number of penalty-points accumulated during battle
				defend_dwall_tmp.penalty=0;
			
				-- a table containing information for every battle-position | siege-index -> struct
				-- Be aware that this table contains informations about defending units as well as attacking groups. Ultimately this means there mustn't be conflicting indices.
				defend_dwall_tmp.siege = {};
				--a table containing every unit in battle| id -> siege-index
				-- this does not apply for the attacing spawn-groups
				defend_dwall_tmp.units = {};
				
				--guards of the second defense-line
				createUnitIndex(1, "locGuard1", 10, "guard_siege", 5, 4000, "locSpawnGuards")
				setGuard(1,-90)
				createUnitIndex(2, "locGuard2", 10, "guard_siege", 5, 4000, "locSpawnGuards")
				setGuard(2,-90)
				createUnitIndex(3, "locGuard3", 10, "guard_siege", 5, 4000, "locSpawnGuards")
				setGuard(3,-90)
				createUnitIndex(4, "locGuard4", 10, "guard_siege", 5, 4000, "locSpawnGuards")
				setGuard(4,-90)
				
				--guards of the first defense-line
				createUnitIndex(5, "locGuard5", 10, "guard_siege", 1, 4000, "locSpawnGuards")
				setGuard(5,-90)
				createUnitIndex(6, "locGuard6", 10, "guard_siege", 1, 4000, "locSpawnGuards")
				setGuard(6,-90)
				createUnitIndex(9, "locGuard9", 10, "guard_siege", 1, 4000, "locSpawnGuards")
				setGuard(9,-90)
				createUnitIndex(10, "locGuard10", 10, "guard_siege", 1, 4000, "locSpawnGuards")
				setGuard(10,-90)
				createUnitIndex(11, "locGuard11", 10, "guard_siege", 1, 4000, "locSpawnGuards")
				setGuard(11,-90)
				createUnitIndex(12, "locGuard12", 10, "guard_siege", 1, 4000, "locSpawnGuards")
				setGuard(12,-90)
				
				--mages and bowman of the second defense-line
				createUnitIndex(13, "locBowmen2", 2, "aisen_mage", 25, 6000, "locSpawnGuards")
				setGuard(13,-90);
				createUnitIndex(14, "locBowmen3", 2,"aisen_mage", 25, 6000, "locSpawnGuards")
				setGuard(14,-90);
				createUnitIndex(15, "locBowmen1", 5,"bowman_siege", 10, 4000, "locSpawnGuards")
				setGuard(15,-90);
				--bowmen of the first defense-line
				createUnitIndex(14, "locBowmen4", 5, "bowman_siege", 3, 4000, "locSpawnGuards")
				setGuard(14,-90);
				createUnitIndex(16, "locBowmen6", 5, "bowman_siege", 3, 4000, "locSpawnGuards")
				setGuard(16,-90);
				createUnitIndex(17, "locBowmen7", 5, "bowman_siege", 3, 4000, "locSpawnGuards")
				setGuard(17,-90);
				
				--Darna's fireelementals
				createUnitIndex(18, "locElemental1", 15, "fire_guard", 30, 4000, "locElemental1")
				--local guard = setGuard(18,-90);
				createUnitIndex(19, "locElemental2", 15, "fire_guard", 30, 4000, "locElemental2")
				--local guard = setGuard(19,-90);
				
				--elite-guards of Greif and Darna
				createUnitIndex(7, "locGeneralGuard1", 10, "elite_siege", 50, 4000, "locSpawnGuards")
				--local guard = setGuard(7,-90)
				createUnitIndex(8, "locGeneralGuard2", 10, "dwarfenwall_councilguard", 50, 4000, "locSpawnGuards")
				--local guard = setGuard(8,-90);
			--aisen defenses
				createUnitIndex(15, "locDefender1", 15, "bowman_siegeDefense", 3, 4000, "locSpawnBow1","newDefender");
				local guard = setGuard(15,-90);
				createUnitIndex(20, "locDefender3", 15, "bowman_siegeDefense", 3, 4000, "locSpawnBow1","newDefender");
				local guard = setGuard(20,-90);
				createUnitIndex(21, "locDefender4", 15, "bowman_siegeDefense", 3, 4000, "locSpawnBow2","newDefender");
				local guard = setGuard(21,-90);
				createUnitIndex(22, "locDefender6", 15, "bowman_siegeDefense", 3, 4000, "locSpawnBow2","newDefender");
				local guard = setGuard(22,-90);
				
				createUnitIndex(23, "locDefender2", 15, "aisen_mageDefense", 3, 4000, "locSpawnBow1","newDefender");
				local guard = setGuard(23,-90);
				createUnitIndex(24, "locDefender5", 15, "aisen_mageDefense", 3, 4000, "locSpawnBow2","newDefender");
				local guard = setGuard(24,-90);
				
				
			--undead defenses
				createUnitIndex(50, "locArmy1", 15, "bow_skel_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(50,90);
				createUnitIndex(51, "locArmy2", 15, "bow_skel_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(51,90);
				createUnitIndex(52, "locArmy3", 15, "bow_skel_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(52,90);
				createUnitIndex(53, "locArmy4", 15, "bow_skel_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(53,90);
				createUnitIndex(54, "locArmy5", 15, "bow_skel_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(54,90);
				createUnitIndex(55, "locArmy6", 15, "bow_skel_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(55,90);
				
				createUnitIndex(56, "locNecromancer1", 15, "necromancer_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(56,90);
				createUnitIndex(57, "locNecromancer2", 15, "necromancer_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(57,90);
				createUnitIndex(58, "locNecromancer3", 15, "necromancer_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(58,90);
				createUnitIndex(59, "locNecromancer4", 15, "necromancer_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(59,90);
				createUnitIndex(60, "locNecromancer5", 15, "necromancer_siegeDefense", 0, 0, "locEntryUndead", "newDefender");
				--local guard = setGuard(60,90);
				
				
			--undead attackers
				defend_dwall_tmp.attackLeft = {"locCharge1", "locCharge2", "locLeftFlank", "locEntryGeneral"};
				defend_dwall_tmp.attackMiddleLeft = {"locCharge3", "locEntryGeneral"};
				defend_dwall_tmp.attackMiddle = {"locCharge4","locCharge3","locEntryGeneral"};
				defend_dwall_tmp.attackMiddleRight = {"locCharge5","locEntryGeneral"};
				defend_dwall_tmp.attackRight = {"locCharge6","locCharge7","locRightFlank","locEntryGeneral"};
			
				createAttackIndex(80, "locSpawn1", defend_dwall_tmp.attackLeft, "easySkeletonsDwall");
				createAttackIndex(81, "locSpawn2", defend_dwall_tmp.attackLeft, "easySkeletonsDwall");
				createAttackIndex(82, "locSpawn3", defend_dwall_tmp.attackMiddleLeft, "easySkeletonsDwall");
				createAttackIndex(83, "locSpawn4", defend_dwall_tmp.attackMiddle, "easySkeletonsDwall");
				createAttackIndex(84, "locSpawn5", defend_dwall_tmp.attackMiddleRight, "easySkeletonsDwall");
				createAttackIndex(85, "locSpawn6", defend_dwall_tmp.attackRight, "easySkeletonsDwall");
				createAttackIndex(86, "locSpawn7", defend_dwall_tmp.attackRight, "easySkeletonsDwall");
				
				createAttackIndex(87, "locSpawn1", defend_dwall_tmp.attackLeft, "mediumSkeletonsDwall");
				createAttackIndex(88, "locSpawn2", defend_dwall_tmp.attackLeft, "mediumSkeletonsDwall");
				createAttackIndex(89, "locSpawn3", defend_dwall_tmp.attackMiddleLeft, "mediumSkeletonsDwall");
				createAttackIndex(90, "locSpawn4", defend_dwall_tmp.attackMiddle, "mediumSkeletonsDwall");
				createAttackIndex(91, "locSpawn5", defend_dwall_tmp.attackMiddleRight, "mediumSkeletonsDwall");
				createAttackIndex(92, "locSpawn6", defend_dwall_tmp.attackRight, "mediumSkeletonsDwall");
				createAttackIndex(93, "locSpawn7", defend_dwall_tmp.attackRight, "mediumSkeletonsDwall");
				
				createAttackIndex(94, "locSpawn1", defend_dwall_tmp.attackLeft, "hardSkeletonsDwall");
				createAttackIndex(95, "locSpawn2", defend_dwall_tmp.attackLeft, "hardSkeletonsDwall");
				createAttackIndex(96, "locSpawn3", defend_dwall_tmp.attackMiddleLeft, "hardSkeletonsDwall");
				createAttackIndex(97, "locSpawn4", defend_dwall_tmp.attackMiddle, "hardSkeletonsDwall");
				createAttackIndex(98, "locSpawn5", defend_dwall_tmp.attackMiddleRight, "hardSkeletonsDwall");
				createAttackIndex(99, "locSpawn6", defend_dwall_tmp.attackRight, "hardSkeletonsDwall");
				createAttackIndex(100, "locSpawn7", defend_dwall_tmp.attackRight, "hardSkeletonsDwall");
				
				createAttackIndex(101, "locSpawn4", {"locCharge4","locCharge3","locEntryGeneral"}, "boss1");
				
				createAttackIndex(102, "locSpawn1", defend_dwall_tmp.attackLeft, "burningMeleeSkeletonsDwall");
				createAttackIndex(103, "locSpawn2", defend_dwall_tmp.attackLeft, "burningMeleeSkeletonsDwall");
				createAttackIndex(104, "locSpawn3", defend_dwall_tmp.attackMiddleLeft, "burningMeleeSkeletonsDwall");
				createAttackIndex(105, "locSpawn4", defend_dwall_tmp.attackMiddle, "burningMeleeSkeletonsDwall");
				createAttackIndex(106, "locSpawn5", defend_dwall_tmp.attackMiddleRight, "burningMeleeSkeletonsDwall");
				createAttackIndex(107, "locSpawn6", defend_dwall_tmp.attackRight, "burningMeleeSkeletonsDwall");
				createAttackIndex(108, "locSpawn7", defend_dwall_tmp.attackRight, "burningMeleeSkeletonsDwall");
				
				createAttackIndex(109, "locSpawn1", defend_dwall_tmp.attackLeft, "burningRangeSkeletonsDwall");
				createAttackIndex(110, "locSpawn2", defend_dwall_tmp.attackLeft, "burningRangeSkeletonsDwall");
				createAttackIndex(111, "locSpawn3", defend_dwall_tmp.attackMiddleLeft, "burningRangeSkeletonsDwall");
				createAttackIndex(112, "locSpawn4", defend_dwall_tmp.attackMiddle, "burningRangeSkeletonsDwall");
				createAttackIndex(113, "locSpawn5", defend_dwall_tmp.attackMiddleRight, "burningRangeSkeletonsDwall");
				createAttackIndex(114, "locSpawn6", defend_dwall_tmp.attackRight, "burningRangeSkeletonsDwall");
				createAttackIndex(115, "locSpawn7", defend_dwall_tmp.attackRight, "burningRangeSkeletonsDwall");
				
				createAttackIndex(116, "locSpawn2", defend_dwall_tmp.attackLeft, "shadowSkeletonsDwall");
				createAttackIndex(117, "locSpawn6", defend_dwall_tmp.attackRight, "shadowSkeletonsDwall");
				
				createAttackIndex(118, "locSpawn4", defend_dwall_tmp.attackMiddle, "boss2");
				createAttackIndex(119, "locSpawn4", defend_dwall_tmp.attackMiddle, "boss3");
				createAttackIndex(120, "locSpawn4", defend_dwall_tmp.attackMiddle, "boss4");
				createAttackIndex(121, "locSpawn4", defend_dwall_tmp.attackMiddle, "boss5");
				createAttackIndex(122, "locSpawn4", defend_dwall_tmp.attackMiddle, "boss6");
				
				createAttackIndex(123, "locSpawn1", defend_dwall_tmp.attackLeft, "frostSkeletonsDwall");
				createAttackIndex(124, "locSpawn2", defend_dwall_tmp.attackLeft, "iceMageDwall");
				createAttackIndex(125, "locSpawn3", defend_dwall_tmp.attackMiddleLeft, "frostSkeletonsDwall");
				createAttackIndex(126, "locSpawn4", defend_dwall_tmp.attackMiddle, "frostMageDwall");
				createAttackIndex(127, "locSpawn5", defend_dwall_tmp.attackMiddleRight, "frostSkeletonsDwall");
				createAttackIndex(128, "locSpawn6", defend_dwall_tmp.attackRight, "iceMageDwall");
				createAttackIndex(129, "locSpawn7", defend_dwall_tmp.attackRight, "frostSkeletonsDwall");
				
				createAttackIndex(130, "locSpawn2", defend_dwall_tmp.attackLeft, "blackMageDwall");
				createAttackIndex(131, "locSpawn4", defend_dwall_tmp.attackMiddle, "blackMageDwall");
				createAttackIndex(132, "locSpawn6", defend_dwall_tmp.attackRight, "blackMageDwall");
			</Effect>
		</Event>
		
		<Event trigger="enter_region">
			<Condition>
				return (defend_dwall.siegeEnded ~= true);
			</Condition>
			<Effect>
				insertTrigger("beforeBattle");
			</Effect>
		</Event>
		
		<Event trigger="unit_die">
			<Condition>
				return (defend_dwall_tmp.units[trigger.unit] ~= nil);
			</Condition>
			<Effect>
				local i = defend_dwall_tmp.units[trigger.unit];
				startTimer(defend_dwall_tmp.siege[i]["respawnTrigger"],defend_dwall_tmp.siege[i]["respawn"]);
				--startTimer("newUnit",1000);
				addTriggerVariable("index",i);
				defend_dwall_tmp.penalty = defend_dwall_tmp.penalty + defend_dwall_tmp.siege[i]["penalty"];
				print("penalty-points: "..defend_dwall_tmp.penalty);
				
				--print("index: "..i.." id: "..trigger.unit);
				defend_dwall_tmp.units[trigger.unit]=nil;
			</Effect>
		</Event>
		
		<Event trigger="newUnit">
			<Effect>
				--print("lets get a new unit");
				local i = trigger.index;
				--print("The index is "..i);
				--print("subtype: "..defend_dwall_tmp.siege[i]["subtype"]);
				local unit = createObject(defend_dwall_tmp.siege[i]["subtype"],defend_dwall_tmp.siege[i]["respawnlocation"]);
				defend_dwall_tmp.units[unit]=i;
				
				addUnitCommand(unit,"walk","locEntryGeneral",1,"secondary");
				addUnitCommand(unit,"walk",defend_dwall_tmp.siege[i]["location"],0.5,"secondary");
				addUnitCommand(unit,"guard",defend_dwall_tmp.siege[i]["location"],defend_dwall_tmp.siege[i]["guard_range"],"secondary");
			</Effect>
		</Event>
		<Event trigger="newDefender">
			<Effect>
				local i = trigger.index;
				local unit = createObject(defend_dwall_tmp.siege[i]["subtype"],defend_dwall_tmp.siege[i]["respawnlocation"]);
				defend_dwall_tmp.units[unit]=i;
				
				addUnitCommand(unit,"walk",defend_dwall_tmp.siege[i]["location"],0.5,"secondary");
				addUnitCommand(unit,"guard",defend_dwall_tmp.siege[i]["location"],defend_dwall_tmp.siege[i]["guard_range"],"secondary");
			</Effect>
		</Event>
		
		<Event trigger="beforeBattle" once="true">
			<Effect>
				fadeOut(0);
				fadeIn(2000, {0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3});
				
				assembleParty("dwarfenwallRampart","locParty");
				setCutsceneMode(true);
				addCameraPosition(0,"locEntryGeneral",-70,55,15);
				
			--spawn the elite_guards
				local unit=createObject("elite_siege","exit_south");
				addUnitCommand(unit,"walk","locGeneralGuard1");
				defend_dwall_tmp.units[unit] = 7;
				unit=createObject("dwarfenwall_councilguard","exit_south");
				addUnitCommand(unit,"walk","locGeneralGuard2");
				defend_dwall_tmp.units[unit] = 8;
				
				defend_dwall_tmp.arrived=0;
				if(debug["defend_dwall"] ~= true)then
					startTimer("councilEnters",3000);
					startTimer("generalEnters",3500);
				else
					insertTrigger("councilEnters");
					insertTrigger("generalEnters");
				end;
			</Effect>
		</Event>
		<Event trigger="generalEnters" once="true">
			<Effect>
				defend_dwall_tmp.general = createObject("general_greif_battle","exit_south");
				setRefName(defend_dwall_tmp.general,"General Greif");
				addUnitCommand(defend_dwall_tmp.general,"walk","locEntryGeneral");
				defend_dwall_tmp.phase="generalEnters";
			</Effect>
		</Event>
		<Event trigger="councilEnters" once="true">
			<Effect>
				defend_dwall_tmp.council = createObject("council_dwarfenwall","exit_south");
				setRefName(defend_dwall_tmp.council,"Maga Convocatis Darna Eistaucher");
				addUnitCommand(defend_dwall_tmp.council,"walk","locCouncilMage");
				defend_dwall_tmp.phase="generalEnters";
			</Effect>
		</Event>
		
		<Event trigger="command_complete" once="true">
			<Condition>
				local sub = get(trigger.unit,"subtype");
				return(sub=="general_greif_battle")
			</Condition>
			<Effect>
				set(trigger.unit,"angle",-90);
				
				defend_dwall_tmp.arrived=defend_dwall_tmp.arrived+1;
				if(defend_dwall_tmp.arrived==2)then
					insertTrigger("talkBeforeBattle");
				end;
			</Effect>
		</Event>
		<Event trigger="command_complete" once="true">
			<Condition>
				local sub = get(trigger.unit,"subtype");
				return(sub=="council_dwarfenwall");
			</Condition>
			<Effect>
				set(trigger.unit,"angle",-90);
				
				defend_dwall_tmp.arrived=defend_dwall_tmp.arrived+1;
				if(defend_dwall_tmp.arrived==2)then
					insertTrigger("talkBeforeBattle");
				end;
			</Effect>
		</Event>
		
		<Event trigger="command_complete" once="true">
			<Condition>
				local sub = get(trigger.unit,"subtype");
				return(sub=="elite_siege")
			</Condition>
			<Effect>
				set(trigger.unit,"angle",-90);
			</Effect>
		</Event>
		<Event trigger="command_complete" once="true">
			<Condition>
				local sub = get(trigger.unit,"subtype");
				return(sub=="dwarfenwall_councilguard")
			</Condition>
			<Effect>
				set(trigger.unit,"angle",-90);
			</Effect>
		</Event>
		
		<Event trigger="talkBeforeBattle" once="true">
			<Effect>
				--lookAtEachOther(defend_dwall_tmp.council,defend_dwall_tmp.general);
				
				if(debug["defend_dwall"] ~= true)then
					initDialog();
					addSpeaker(defend_dwall_tmp.council, "darna");
					addSpeaker(defend_dwall_tmp.general, "greif");
					
					setSpeakerAnimation("greif","point",700);
					timedExecute('setObjectAnimation('..defend_dwall_tmp.general..',"pointing",1000,true)',695);
					speak("greif", _("Da hinten kommen sie."),"unhappy");
					setSpeakerAnimation("greif","warcry",1500);
					speak("greif", _("Macht euch bereit Maenner!"),"warcry");
					setSpeakerEmotion("greif","normal");
					changeTopic("entryLich");
				else
					insertTrigger("entryLich");
				end;
			</Effect>
		</Event>
		<Event trigger="entryLich" once="true">
			<Effect>
				if(debug["defend_dwall"] ~= true)then
					addCameraPosition(4000,"locLich",-80,55,35)
					addCameraPosition(1000,"locLich",-80,55,35)
					addCameraPosition(1000,"locLich",-80,55,17)
				else
					addCameraPosition(0,"locLich",-80,55,17)
				end;
				entryLich();
			</Effect>
		</Event>
		
		<Event trigger="command_complete" once="true">
			<Condition>
				return(trigger.unit==defend_dwall_tmp.attendend1)
			</Condition>
			<Effect>
				setObjectAnimation(trigger.unit,"kneelDown",790);
				timedExecute('setObjectAnimation('..trigger.unit..',"kneel",1900,true)',785);
			</Effect>
		</Event>
		<Event trigger="command_complete" once="true">
			<Condition>
				return(trigger.unit==defend_dwall_tmp.attendend2)
			</Condition>
			<Effect>
				setObjectAnimation(trigger.unit,"kneelDown",820);
				timedExecute('setObjectAnimation('..trigger.unit..',"kneel",2100,true)',815);
			</Effect>
		</Event>
		<Event trigger="command_complete" once="true">
			<Condition>
				return(trigger.unit==defend_dwall_tmp.lich)
			</Condition>
			<Effect>
				set(trigger.unit,"angle",90);
				insertTrigger("undeadTalkBeforeBattle1")
			</Effect>
		</Event>
		
		<Event trigger="undeadTalkBeforeBattle1" once="true">
			<Effect>
				if(debug["defend_dwall"] ~= true)then
					initDialog();
					addImportantSpeakers();
				
					speakPause(800);
					speak("lich",_("Eure Zeit ist gekommen, erbaermliche Menschen!"),"threaten");
					speak("att1",_("Zwergentrutz wird endlich Euer sein, mein Gebieter."),"sneer");
					speak("att2",_("Mit der Unterstuetzung aus der Hauptstadt wird es endlich gelingen."),"happy");
					speak("lich",_("Beginnen wir also den letzten Sturm auf diese elende Festung."),"angry");
					executeInDialog('insertTrigger("changeView");addTriggerVariable("nextTrigger","beingPrepared");');
				else
					insertTrigger("changeView");
					addTriggerVariable("nextTrigger","beingPrepared");
				end;
			</Effect>
		</Event>
		
		<Event trigger="changeView">
			<Effect>
				setCutsceneMode(true);
				fadeOut(1000)
				startTimer(trigger.nextTrigger,1500);
			</Effect>
		</Event>
		
		<Event trigger="beingPrepared" once="true">
			<Effect>
				if(debug["defend_dwall"] ~= true)then
					fadeIn(2000, {0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3});
					groupObjectsArc(getPlayers(),"entry_south","locBowmen1",nil,90);
					addCameraPosition(0,"locEntryGeneral",-70,55,15);
					
					initDialog();
					addImportantSpeakers();

					speakPause(1000);
					speak("greif",_("Da hinten sind wahrscheinlich so viele Untote, dass Eure ach so kampfkraeftige Unterstuetzung unseren Tod nicht wird abwenden koennen."),"unhappy");
					speak("darna",_("Diese... Unterstuetzung ist nicht das einzige, was das Konzil fuer Zwergentrutz tun kann und wird."),"aloof");
					speak("darna",_("Ich habe schon vor Wochen einen Erdelementar gebunden."),"sneer");
					speak("darna",_("Er wartet nur noch auf meinen Befehl."),"normal");
					speak("darna",_("Natuerlich konnte ich nicht wissen, wo die Untoten angreifen wuerden."),"thougtful");
					speak("darna",_("Ich fuerchte, da kommt einiges an Aufraeumarbeiten auf die Ueberlebenden zu."),"sad");
					speak("greif",_("Hoert auf zu spotten und tut es endlich, was auch immer ihr vorhabt."),"angry");
					setSpeakerEmotion("greif","normal");
					setSpeakerAnimation("darna","callEarth",3000);
					speakPause(3000);
					executeInDialog('insertTrigger("changeView");addTriggerVariable("nextTrigger","cuttingOfUndead");');
				else
					fadeIn(0, {0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3});
					insertTrigger("changeView");
					addTriggerVariable("nextTrigger","cuttingOfUndead");
				end;
			</Effect>
		</Event>
		
		<Event trigger="cuttingOfUndead" once="true">
			<Effect>
				defend_dwall_tmp.phase="groundbreak";
				if(debug["defend_dwall"] ~= true)then
					fadeIn(1000, {0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3});
					addCameraPosition(0,"locFissure1",-60,55,20);
					addCameraPosition(800,"locFissure1",-60,55,20);
					addCameraPosition(3500,"locFissure7",-120,55,20);
					addCameraPosition(1500,"locFissure7",-120,55,20);
					addCameraPosition(1500,"locLich",-65,35,9);
					timedExecute("blockWall()",1000);
				else
					fadeIn(0, {0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3});
					blockWall();
					addCameraPosition(0,"locLich",-65,35,9);
				end;
			</Effect>
		</Event>
		
		<Event trigger="all_camera_moves_complete" once="true">
			<Condition>
				return(defend_dwall_tmp.phase=="groundbreak");
			</Condition>
			<Effect>
				if(debug["defend_dwall"] ~= true)then
					initDialog();
					addImportantSpeakers();
					
					speak("lich", _("Verfluchte Elementaristen!"),"warcry");
					speak("lich", _("Es wird mir eine Freude sein, den Körper dieser Hexe wiederzubeleben, nur um sie zu verbrennen!"),"angry");
					speak("att1",_("Es wird geschehen, mein Gebieter."),"amused");
					speak("att2",_("Aber wie greifen wir die Stadt jetzt an? Sie hat den Weg fuer unsere Armee blockiert"),"thoughtful");
					speak("lich", _("Schweigt!"),"threaten");
					setSpeakerEmotion("att1","panic");
					setSpeakerEmotion("att2","panic");
					speakPause(1000);
					speak("lich", _("Die Katapulte?"),"normal");
					speak("att1",_("Sind bereit, mein Gebieter"),"normal");
					speak("lich", _("Unsere Nekromanten?"),"normal");
					speak("att2",_("Warten nur auf euren Befehl."),"normal");
					speak("lich", _("Nicht umsonst kaempfe ich schon seit Jahrhunderten mit Zwergentrutz."),"grin");
					speak("lich", _("Schickt die Skelette durch die Kriechgaenge."),"threaten");
					
					setSpeakerAnimation("att1","kneelUp",800);
					setSpeakerAnimation("att2","kneelUp",700);
					speakPause(1000);
					changeTopic("firstWaveAdvances")
				else
					addUnitCommand(defend_dwall_tmp.attendend1,"walk","locEntryUndead",3);
					addUnitCommand(defend_dwall_tmp.attendend2,"walk","locEntryUndead",3);
					timedExecute('insertTrigger("changeView");addTriggerVariable("nextTrigger","prepareTheBrothers")',2000);
				end;
			</Effect>
		</Event>
		
		<Event trigger="firstWaveAdvances" once="true">
			<Effect>
				addUnitCommand(defend_dwall_tmp.attendend1,"walk","locEntryUndead",3);
				addUnitCommand(defend_dwall_tmp.attendend2,"walk","locEntryUndead",3);
				
				addCameraPosition(4000,"locEntryGeneral",-70,55,15);
				
				speak("greif", _("Da tut sich was."),"normal");
				speak("greif", _("Sie kommen!"),"warcry");
				setSpeakerEmotion("greif","normal")
				speak("darna",_("Es wird wohl nicht schaden, wenn ich auch noch ein paar Helfer rufe."),"aloof");
				
				if(solo())then
					speak("greif", _("An die Front mit euch, Schlaechter. _solo"),"angry");
				else
					speak("greif", _("An die Front mit euch, Schlaechter."),"angry");
				end;
				speak("leader",_("Sag 'Bitte'."),"grin")
				speak("darna",_("Macht schon!"),"unhappy");
				setSpeakerEmotion("darna","normal");
				changeTopic("summoningElementals");
			</Effect>
		</Event>
		
		<Event trigger="summoningElementals" once="true">
			<Effect>
				setObjectAnimation(defend_dwall_tmp.council,"fire_wave",4000);
				timedExecute('callElementals()',4000);
				timedExecute('addCameraPosition(1500,"locElemental1",-70,55,15)',3500);
				speakPause(4500);
				changeTopic("itBegins");
			</Effect>
		</Event>
		<Event trigger="itBegins" once="true">
			<Effect>
				speak("greif",_("Gebt Acht!"),"warcry")
				speak("greif",_("Katapulte!"),"warcry")
				changeTopic("siegeBegins");
			</Effect>
		</Event>
			
		<Event trigger="barrage">
			<Condition>
				return(defend_dwall.siegeEnded ~=true);
			</Condition>
			<Effect>
				barrage(20);
				startTimer("barrage",180000)
			</Effect>
		</Event>
		<Event trigger="siegeBegins" once="true">
			<Effect>
				addCameraPosition(2000,"locEntryGeneral",-90,55,25);
				for i = 0,10 do
					insertTrigger("newDefender");
					addTriggerVariable("index",50+i);
				end;
				insertTrigger("barrage");
				startTimer("wave1",1900);
			</Effect>
		</Event>
		
		<Event trigger="wave1" once="true">
			<Effect>
				addCameraPosition(1000,"locSpawn6",-90,55,30);
				timedExecute('setCutsceneMode(false)',2000);
				
				defend_dwall_tmp.phase="wave1"
				launchAttack(80); --e
				launchAttack(84); --e
				launchAttack(86); --e
				
				startTimer("wave2",45000);
			</Effect>
		</Event>
		
		<Event trigger="wave2" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave2"
				launchAttack(80); --e
				launchAttack(89); --m
				launchAttack(91); --m
				launchAttack(86); --e
				
				startTimer("wave3",50000);
			</Effect>
		</Event>
		
		<Event trigger="wave3" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave3"
				launchAttack(80); --e
				launchAttack(81); --e
				launchAttack(89); --m
				launchAttack(90); --m
				launchAttack(91); --m
				launchAttack(85); --e
				launchAttack(86); --e
				
				startTimer("wave4",50000);
			</Effect>
		</Event>
		
		<Event trigger="wave4" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave4"
				launchAttack(80); --e
				launchAttack(88); --m
				launchAttack(86); --m
				launchAttack(97); --h
				launchAttack(91); --m
				launchAttack(92); --m
				launchAttack(86); --e
				
				startTimer("firstBoss",50000);
			</Effect>
		</Event>
		
		<Event trigger="firstBoss" once="true">
			<Effect>
				defend_dwall_tmp.phase="boss1"
				launchAttack(101); --boss
			</Effect>
		</Event>
		<Event trigger="unit_die" once="true">
			<Condition>
				return(get(trigger.unit,"subtype")=="boss1_siege");
			</Condition>
			<Effect>
				print("siege on")
				startTimer("wave5",7000);
			</Effect>
		</Event>
	
		<Event trigger="wave5" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave5"
				launchAttack(102); --fm
				launchAttack(110); --fr
				launchAttack(114); --fr
				launchAttack(108); --fm
				
				startTimer("wave6",30000);
			</Effect>
		</Event>
		
		<Event trigger="wave6" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave6"
				launchAttack(102); --fm
				launchAttack(110); --fr
				launchAttack(104); --fm
				launchAttack(112); --fm
				launchAttack(106); --fm
				launchAttack(114); --fr
				launchAttack(108); --fm
				
				startTimer("secondBoss",50000);
			</Effect>
		</Event>
		
		<Event trigger="secondBoss" once="true">
			<Effect>
				defend_dwall_tmp.phase="boss2"
				launchAttack(116); --b
				launchAttack(118); --boss
				launchAttack(117); --b
				
			</Effect>
		</Event>
		<Event trigger="unit_die" once="true">
			<Condition>
				return(get(trigger.unit,"subtype")=="boss2_siege");
			</Condition>
			<Effect>
				defend_dwall_tmp.phase="endlessStream"
				print("chilling death is dead")
				print("incoming fireskeletons")
				skeletonBarrage(8);
				startTimer("overrunThem",30000);
				startTimer("wave7",50000);
			</Effect>
		</Event>
		
		<Event trigger="overrunThem">
			<Condition>
				return(defend_dwall.siegeEnded ~=true);
			</Condition>
			<Effect>
				if(defend_dwall_tmp.suspend ~=true)then
					for i=0,6 do
						launchAttack(80 +i);
					end;
				end;
				
				startTimer("overrunThem",75000);
			</Effect>
		</Event>
		
		<Event trigger="wave7" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave7"
				launchAttack(116); --b
				launchAttack(97); --h
				launchAttack(117); --b
				
				startTimer("wave8",40000);
			</Effect>
		</Event>
		
		<Event trigger="wave8" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave7"
				
				launchAttack(116); --b
				launchAttack(97); --h
				launchAttack(117); --b
				
				startTimer("thirdBoss",50000);
			</Effect>
		</Event>
		
		<Event trigger="thirdBoss" once="true">
			<Effect>
				defend_dwall_tmp.phase="boss3"
				launchAttack(119); --boss
			</Effect>
		</Event>
		<Event trigger="unit_die" once="true">
			<Condition>
				return(get(trigger.unit,"subtype")=="boss3_siege");
			</Condition>
			<Effect>
				print("siege on")
				timedExecute('skeletonBarrage(15)',2000);
				startTimer("wave9",20000);
			</Effect>
		</Event>
	
		<Event trigger="wave9" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave9"
				
				launchAttack(87); --m
				launchAttack(96); --h
				launchAttack(97); --h
				launchAttack(98); --h
				launchAttack(93); --m
				
				startTimer("wave10",50000);
			</Effect>
		</Event>

		<Event trigger="wave10" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave10"
				defend_dwall_tmp.suspend = true;
				
				skeletonBarrage(10);
				timedExecute('skeletonBarrage(10)',30000);
				
				for i=0,6 do
					launchAttack(94 +i);
				end;
				
				startTimer("changeView",50000);
				addTriggerVariable("nextTrigger","prepareTheBrothers")
			</Effect>
		</Event>
		
		<Event trigger="prepareTheBrothers" once="true">
			<Effect>
				defend_dwall_tmp.phase="the4thBoss"
				addCameraPosition(0,"locLich",-65,35,9);
				fadeIn(2000, {0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3});
				addUnitCommand(defend_dwall_tmp.attendend1,"walk","locAttendend1");
			</Effect>
		</Event>
		
		<Event trigger="all_commands_complete" once="true">
			<Condition>
				return((trigger.unit==defend_dwall_tmp.attendend1) and (defend_dwall_tmp.phase=="the4thBoss"));
			</Condition>
			<Effect>
				initDialog()
				addImportantSpeakers();
			
				lookAt(defend_dwall_tmp.attendend1,"locLich");
				setSpeakerAnimation("att1","kneelDown",800);
				timedExecute('setObjectAnimation('..defend_dwall_tmp.attendend1..',"kneel",2000,true)',795)
			
				
				speak("att1", _("Ihr habt gerufen, mein Gebieter?"),"normal");
				speak("lich", _("Ich will, dass ihr die Brueder einsetzt."), "sneer");
				speak("att1", _("Aber die sind noch immer nicht stabil!"),"fear");
				speak("att1", _("Im schlimmsten Fall werden sie dem Gegner ueberhaupt keinen Schaden zufuegen."), "fear");
				speak("lich", _("Das spielt keine Rolle."),"normal");
				speak("lich", _("Er muesste bald hier sein. Im Moment schinden wir nur Zeit."),"normal");
				speak("att1", _("Wie ihr Befehlt, mein Gebieter."),"normal");
				executeInDialog('insertTrigger("changeView");addTriggerVariable("nextTrigger","boss4");');
				
			</Effect>
		</Event>

		<Event trigger="boss4" once="true">
			<Effect>
				addUnitCommand(defend_dwall_tmp.attendend1,"walk","locEntryUndead");
				setCutsceneMode(false);
				fadeIn(2000, {0.4,0.4,0.4},{1,1,1},{0.3,0.3,0.3});
			
				defend_dwall_tmp.phase="boss4"
				launchAttack(120); --boss
			</Effect>
		</Event>
		<Event trigger="unit_die" once="true">
			<Condition>
				return(get(trigger.unit,"subtype")=="boss4_siege");
			</Condition>
			<Effect>
				startTimer("wave11",20000);
			</Effect>
		</Event>
		
		<Event trigger="wave11" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave11"
				defend_dwall_tmp.suspend = false;
				
				--skeletonBarrage(10);
				--timedExecute('skeletonBarrage(10)',30000);
				
				launchAttack(123); --fs
				launchAttack(125); --fs
				launchAttack(127); --fs
				launchAttack(129); --fs
								
				startTimer("wave12",50000);
			</Effect>
		</Event>
		
		<Event trigger="wave12" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave12"
				
				skeletonBarrage(10);
				--timedExecute('skeletonBarrage(10)',30000);
				
				for i=0,6 do
					launchAttack(123 +i);
				end;
								
				startTimer("boss5",50000);
			</Effect>
		</Event>
		
		<Event trigger="boss5" once="true">
			<Effect>
				defend_dwall_tmp.phase="boss5"
				defend_dwall_tmp.suspend = true;
				
				launchAttack(121); --boss
			</Effect>
		</Event>
		<Event trigger="unit_die" once="true">
			<Condition>
				return(get(trigger.unit,"subtype")=="boss5_siege");
			</Condition>
			<Effect>
				defend_dwall_tmp.suspend = false;
				startTimer("wave13",20000);
			</Effect>
		</Event>
		
		<Event trigger="wave13" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave11"
				defend_dwall_tmp.suspend = false;
				
				--skeletonBarrage(10);
				--timedExecute('skeletonBarrage(10)',30000);
				
				launchAttack(94); --h
				launchAttack(116); --b
				launchAttack(125); --fs
				launchAttack(131); --bm
				launchAttack(127); --fs
				launchAttack(117); --b
				launchAttack(100); --h
								
				startTimer("wave14",50000);
			</Effect>
		</Event>
		
		<Event trigger="wave14" once="true">
			<Effect>
				defend_dwall_tmp.phase="wave11"
				defend_dwall_tmp.suspend = false;
				
				--skeletonBarrage(10);
				--timedExecute('skeletonBarrage(10)',30000);
				
				launchAttack(94); --h
				launchAttack(130); --bm
				launchAttack(125); --fs
				launchAttack(131); --bm
				launchAttack(127); --fs
				launchAttack(132); --bm
				launchAttack(100); --h
								
				startTimer("boss6",50000);
			</Effect>
		</Event>
		
		<Event trigger="boss6" once="true">
			<Effect>
				defend_dwall_tmp.phase="boss6"
				launchAttack(122); --boss
			</Effect>
		</Event>
		<Event trigger="unit_die" once="true">
			<Condition>
				return(get(trigger.unit,"subtype")=="boss6_siege");
			</Condition>
			<Effect>
				print("the siege has ended");
				defend_dwall.siegeEnded = true;
			</Effect>
		</Event>
	
	</Region>
</Quest>

